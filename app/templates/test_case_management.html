{% extends "base.html" %}

{% block title %}測試案例管理 - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

<!-- 快速編輯樣式 -->
<style>
/* 限定本頁：關閉整頁滾動，只讓列表區域滾動 */
html, body { height: 100%; overflow: hidden; }
#testCasesPage { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

.hover-editable {
    cursor: pointer;
    transition: background-color 0.2s;
}

.hover-editable:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.hover-edit-btn {
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    min-width: 28px;
    min-height: 28px;
    padding: 2px 4px;
}

.hover-editable:hover .hover-edit-btn {
    opacity: 1 !important;
    pointer-events: auto;
}

.hover-editable .hover-edit-btn {
    display: block !important;
}

.quick-edit-input {
    border: 1px solid #007bff !important;
    border-radius: 4px !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    height: auto !important;
    min-height: 1.5rem !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

/* 確保表格行高度一致 */
#testCasesTable tbody tr {
    height: 2.5rem;
}

#testCasesTable tbody td {
    vertical-align: middle;
    height: 2.5rem;
}

/* Markdown 編輯器樣式 */
.markdown-global-toolbar {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.markdown-field-container {
    margin-top: 0.5rem;
}

.markdown-field-container textarea {
    border-radius: 0.375rem;
}

.markdown-field-container .card {
    border-radius: 0.375rem;
    height: 100%;
}

.markdown-preview {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}

.markdown-preview h1,
.markdown-preview h2,
.markdown-preview h3 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.markdown-preview h1 { font-size: 1.5rem; }
.markdown-preview h2 { font-size: 1.25rem; }
.markdown-preview h3 { font-size: 1.1rem; }

.markdown-preview ul,
.markdown-preview ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-preview code {
    background-color: #f1f3f4;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

.markdown-preview a {
    color: var(--tr-primary);
    text-decoration: none;
}

.markdown-preview a:hover {
    text-decoration: underline;
}

/* 附件樣式 */
.attachment-item {
    background-color: #f8f9fa;
    transition: background-color 0.2s;
}

.attachment-item:hover {
    background-color: #e9ecef;
}

/* (reverted) removed modal TCG custom styles */

/* 在顯示前先隱藏 modal 內容，避免進場時可見的滾動回頂彈跳感 */
.modal-preparing .modal-body {
    visibility: hidden;
}

/* 禁用任何平滑滾動，確保立即置頂 */
.scrollable-content {
    scroll-behavior: auto;
}

/* 精準收斂搜尋卡片的內邊距，避免上方留白過多 */
#searchFilterCard .card-body {
    padding-top: 0.25rem;   /* 再更緊：由 0.5rem 降為 0.25rem */
    padding-bottom: 0.5rem; /* 底部同步略收斂 */
}
#searchFilterCard .form-label {
    margin-bottom: 0.125rem; /* 再更緊：由 0.25rem 降為 0.125rem */
}

/* 同層級其他卡片一併收斂頂部空白 */
#batchToolbar .card-body,
#testCasesCard .card-body {
    padding-top: 0.5rem;
}

/* 讓列表容器可滾動（高度由 JS 計算設定）*/
#testCasesScroll {
    overflow-y: auto;
}

/* 讓標題列固定在列表容器頂部，不跟著內容滾動，並恢復底色與陰影層次 */
#testCasesScroll thead th {
    position: sticky;
    top: 0;
    z-index: 20; /* 確保蓋過內容列 */
    background-color: #f8f9fa; /* 與卡片/表頭風格一致 */
    border-bottom: 1px solid #dee2e6; /* 清楚的下邊界 */
}
#testCasesScroll thead tr {
    box-shadow: 0 2px 3px rgba(0,0,0,0.05); /* 輕微陰影強化層次 */
}

/* 專門收斂 #searchInput 的父層（col-）之上緣空白：縮小該 row 的垂直 gutter */
#searchFilterCard .card-body .row.g-3 {
    --bs-gutter-y: 0.125rem; /* 再更緊：由 0.25rem 降為 0.125rem */
}


/* 分頁列固定在視窗底部（不加底色與邊框，貼合卡片背景） */
#testCasesPagination {
    position: sticky;
    bottom: 0;
    z-index: 25;
    background-color: transparent;
    border-top: none;
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid" id="testCasesPage">
    <!-- 頁面標題與工具列 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h3 mb-1">測試案例管理</h1>
            <p class="text-muted">管理測試案例，支援搜尋、過濾、編輯和批次操作</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-home me-2"></i>回到首頁
            </a>
            <button type="button" class="btn btn-primary" id="addTestCaseBtn">
                <i class="fas fa-plus me-2"></i>新增測試案例
            </button>
            <button type="button" class="btn btn-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt me-2"></i>重新整理
            </button>
        </div>
    </div>

    <!-- 載入進度條 -->
    <div id="loadingProgress" class="card mb-2" style="display: none;">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i class="fas fa-spinner fa-spin me-2"></i>載入中...
            </h5>
            
            <!-- Test Case 載入進度 -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">載入測試案例</small>
                    <small class="text-muted" id="testCaseProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" id="testCaseProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- TCG 快取載入進度 -->
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">載入 TCG 單號快取</small>
                    <small class="text-muted" id="tcgCacheProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="tcgCacheProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋與篩選區 -->
    <div class="card mb-3" id="searchFilterCard" style="display: none;">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6 col-lg-4">
                    <label for="searchInput" class="form-label">關鍵字搜尋</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="搜尋測試案例標題、描述...">
                </div>
                <div class="col-md-3 col-lg-2">
                    <label for="priorityFilter" class="form-label">優先級</label>
                    <select class="form-select" id="priorityFilter">
                        <option value="">全部優先級</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="col-md-6 col-lg-6 d-flex align-items-end justify-content-between flex-wrap">
                    <div class="d-flex align-items-center mb-2 mb-lg-0">
                        <button type="button" class="btn btn-primary me-2" id="applyFiltersBtn">
                            <i class="fas fa-filter me-2"></i>套用篩選
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearFiltersBtn">
                            <i class="fas fa-times me-2"></i>清除
                        </button>
                    </div>
                    <!-- 批次操作工具列（與套用篩選同一排、靠右顯示） -->
                    <div id="batchInlineToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0">
                        <span class="text-muted">已選取 <strong id="selectedCount">0</strong> 個項目</span>
                        <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn">
                            <i class="fas fa-trash me-2"></i>批次刪除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 測試案例表格 -->
    <div class="card" id="testCasesCard">
        <div class="card-body">
            <div class="table-responsive" id="testCasesScroll">
                <table class="table table-hover table-sm" id="testCasesTable">
                    <thead>
                        <tr style="height: 32px !important; line-height: 1.2;">
                            <th width="30" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                            </th>
                            <th width="220" style="padding: 4px 8px !important; vertical-align: middle;">Test Case Number</th>
                            <th style="padding: 4px 8px !important; vertical-align: middle;">標題</th>
                            <th width="120" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">TCG</th>
                            <th width="80" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">優先級</th>
                            <th width="100" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">建立日期</th>
                            <th width="100" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">更新日期</th>
                            <th width="100" style="padding: 4px 8px !important; vertical-align: middle;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="testCasesTableBody">
                        <!-- 將由 JavaScript 動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分頁控制 -->
    <nav aria-label="測試案例分頁" class="mt-3" id="testCasesPagination">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- 將由 JavaScript 動態載入 -->
        </ul>
    </nav>
</div>

<!-- 測試案例詳情/編輯 Modal -->
<div class="modal fade" id="testCaseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl" style="height: 90vh; max-height: 90vh;">
        <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <span id="testCaseModalTitle">新增測試案例</span>
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevTestCaseBtn" title="上一隻測試案例">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextTestCaseBtn" title="下一隻測試案例">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0; display: flex; flex-direction: column;">
                <form id="testCaseForm" style="height: 100%; display: flex; flex-direction: column;">
                    <input type="hidden" id="testCaseId" name="id">
                    <input type="hidden" id="tcg" name="tcg">
                    
                    <!-- 固定區域：基本資訊 -->
                    <div class="fixed-section" style="flex-shrink: 0; padding: 1rem; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label for="testCaseNumber" class="form-label">Test Case Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseNumber" name="test_case_number" required>
                            </div>
                            <div class="col-md-6">
                                <label for="title" class="form-label">測試案例標題 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-2">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="tcg" class="form-label">TCG</label>
                                <div class="tcg-search-container" style="position: relative;">
                                    <input type="text" 
                                           id="modalTCGInput" 
                                           class="form-control" 
                                           placeholder="輸入搜尋 TCG..."
                                           autocomplete="off"
                                           onkeyup="handleTCGSearch(this)"
                                           onfocus="showTCGDropdown()"
                                           onblur="hideTCGDropdown()"
                                           oncontextmenu="clearModalTCGDirect(event)">
                                    <div id="modalTCGDropdown" 
                                         style="position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; max-height: 200px; overflow-y: auto; display: none; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <!-- 搜尋結果會動態載入到這裡 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 可滾動內容區域 -->
                    <div class="scrollable-content" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        
                        <!-- 測試內容三個區域 -->
                        
                        <!-- 測試內容三個區域 - 統一網格佈局 -->
                        <div class="row">
                            <!-- Precondition 區域 -->
                            <div class="col-12 mb-4">
                                <div class="mb-3">
                                    <label for="precondition" class="form-label mb-0">
                                        <i class="fas fa-list-ul me-2"></i>Precondition
                                    </label>
                                </div>
                                <div class="markdown-field-container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="precondition" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" title="粗體">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" title="斜體">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" title="程式碼">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " title="標題 1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " title="標題 2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " title="標題 3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " title="無序列表">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " title="有序列表">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" title="連結">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" title="圖片">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="precondition" name="precondition" class="markdown-textarea" rows="4" 
                                                        placeholder="測試前置條件，支援 Markdown 格式" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="precondition" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 測試步驟區域 -->
                            <div class="col-12 mb-4">
                                <label for="test_steps" class="form-label">
                                    <i class="fas fa-list-ol me-2"></i>測試步驟
                                </label>
                                <div class="markdown-field-container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 250px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="test_steps" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" title="粗體">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" title="斜體">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" title="程式碼">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " title="標題 1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " title="標題 2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " title="標題 3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " title="無序列表">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " title="有序列表">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" title="連結">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" title="圖片">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="test_steps" name="test_steps" class="markdown-textarea" rows="6" 
                                                        placeholder="詳細的測試執行步驟，支援 Markdown 格式&#10;&#10;範例：&#10;1. 開啟應用程式&#10;2. 點擊 **登入** 按鈕&#10;3. 輸入有效的使用者名稱和密碼&#10;4. 確認畫面顯示歡迎訊息" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 250px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="test_steps" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 預期結果區域 -->
                            <div class="col-12 mb-4">
                                <label for="expected_result" class="form-label">
                                    <i class="fas fa-check-circle me-2"></i>預期結果
                                </label>
                                <div class="markdown-field-container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="expected_result" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" title="粗體">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" title="斜體">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" title="程式碼">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " title="標題 1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " title="標題 2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " title="標題 3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " title="無序列表">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " title="有序列表">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" title="連結">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" title="圖片">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="expected_result" name="expected_result" class="markdown-textarea" rows="4" 
                                                        placeholder="描述預期的測試結果，支援 Markdown 格式" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="expected_result" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 附件區域 -->
                        <div class="mb-3">
                            <label for="attachmentUpload" class="form-label">
                                <i class="fas fa-paperclip me-2"></i>附件
                            </label>
                            <input type="file" class="form-control" id="attachmentUpload" multiple 
                                   accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <div class="form-text">支援圖片、PDF、Office 文件，單檔最大 10MB</div>
                            <div id="attachmentsList" class="mt-2">
                                <!-- 附件列表將由 JavaScript 動態載入 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 固定按鈕區域 -->
                    <div class="fixed-buttons" style="flex-shrink: 0; padding: 1rem; border-top: 1px solid #dee2e6; background: #ffffff;">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- 模式切換按鈕 -->
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="editModeBtn">
                                    <i class="fas fa-edit me-1"></i>編輯
                                </button>
                                <button type="button" class="btn btn-secondary active" id="previewModeBtn">
                                    <i class="fas fa-eye me-1"></i>預覽
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="splitModeBtn">
                                    <i class="fas fa-columns me-1"></i>並排
                                </button>
                            </div>
                            <!-- 操作按鈕 -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="saveTestCaseBtn" disabled>
                                    <i class="fas fa-save me-2"></i>儲存
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>確認刪除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>警告：</strong>刪除操作無法復原，請謹慎確認
                </div>
                <div id="deleteList">
                    <!-- 要刪除的項目列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>確認刪除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let testCases = [];
let filteredTestCases = [];
let selectedTestCases = new Set();
let currentPage = 1;
let currentTestCaseIndex = -1; // 當前檢視測試案例在 filteredTestCases 中的索引
let pageSize = 50;
let markdownEditor = null;

// TCG 快取相關變數
let tcgCache = null;
let tcgCacheTimestamp = null;
const TCG_CACHE_KEY = 'tcg_cache';
const TCG_CACHE_TIMESTAMP_KEY = 'tcg_cache_timestamp';
const TCG_CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24小時過期

document.addEventListener('DOMContentLoaded', function() {
    initTestCaseManagement();
    bindEvents();
    initializeMarkdownEditor();
    // 初始化列表高度（等待初始排版完成）
    setTimeout(adjustTestCasesScrollHeight, 0);
});

// TCG 快取管理函數
function loadTCGCacheFromStorage() {
    try {
        const cached = localStorage.getItem(TCG_CACHE_KEY);
        const timestamp = localStorage.getItem(TCG_CACHE_TIMESTAMP_KEY);
        
        if (cached && timestamp) {
            const cacheAge = Date.now() - parseInt(timestamp);
            if (cacheAge < TCG_CACHE_EXPIRY) {
                tcgCache = JSON.parse(cached);
                tcgCacheTimestamp = parseInt(timestamp);
                console.log(`載入 TCG 快取: ${tcgCache.length} 筆記錄`);
                return true;
            }
        }
    } catch (error) {
        console.error('載入 TCG 快取失敗:', error);
    }
    return false;
}

function saveTCGCacheToStorage() {
    try {
        localStorage.setItem(TCG_CACHE_KEY, JSON.stringify(tcgCache));
        localStorage.setItem(TCG_CACHE_TIMESTAMP_KEY, tcgCacheTimestamp.toString());
    } catch (error) {
        console.error('儲存 TCG 快取失敗:', error);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function clearTCGCache() {
    tcgCache = null;
    tcgCacheTimestamp = null;
    localStorage.removeItem(TCG_CACHE_KEY);
    localStorage.removeItem(TCG_CACHE_TIMESTAMP_KEY);
}

function shouldUpdateTCGCache() {
    // 檢查是否需要更新快取
    // 1. 沒有快取
    if (!tcgCache) return true;
    
    // 2. 快取過期
    if (tcgCacheTimestamp && (Date.now() - tcgCacheTimestamp) > TCG_CACHE_EXPIRY) {
        return true;
    }
    
    // 3. 強制重新載入 (檢查 URL 參數或其他條件)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('refresh') === 'true') return true;
    
    // 4. 頁面完全重新載入 (performance.navigation.type === 1 for reload)
    if (performance.navigation && performance.navigation.type === 1) return true;
    
    return false;
}

async function loadTCGCache(updateProgress = null) {
    try {
        if (updateProgress) updateProgress(0, '開始載入 TCG 單號...');
        
        if (updateProgress) updateProgress(30, '從本地資料庫載入...');
        
        // 一次性從本地 SQLite 載入所有資料（極快）
        const response = await fetch('/api/tcg/search?keyword=&limit=50000');
        if (!response.ok) {
            throw new Error(`載入 TCG 失敗: ${response.status} ${response.statusText}`);
        }
        
        if (updateProgress) updateProgress(70, '解析 TCG 資料...');
        
        const data = await response.json();
        tcgCache = data.results || [];
        tcgCacheTimestamp = Date.now();
        
        if (updateProgress) updateProgress(90, '儲存快取...');
        saveTCGCacheToStorage();
        
        if (updateProgress) {
            updateProgress(100, `載入完成 (${tcgCache.length} 筆)`);
        }
        
        console.log(`TCG 快取更新完成: ${tcgCache.length} 筆記錄`);
        return true;
        
    } catch (error) {
        console.error('載入 TCG 快取失敗:', error);
        if (updateProgress) {
            updateProgress(0, '載入失敗: ' + error.message);
        }
        return false;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function searchTCGFromCache(keyword, limit = 20) {
    if (!tcgCache) return [];
    
    if (!keyword || keyword.trim() === '') {
        return tcgCache.slice(0, limit);
    }
    
    const lowerKeyword = keyword.toLowerCase();
    return tcgCache.filter(tcg => 
        tcg.tcg_number.toLowerCase().includes(lowerKeyword) ||
        tcg.title.toLowerCase().includes(lowerKeyword)
    ).slice(0, limit);
}

async function initTestCaseManagement() {
    // 顯示進度條
    showLoadingProgress();
    
    try {
        // 載入 TCG 快取 (如果需要)
        const hasCachedTCG = loadTCGCacheFromStorage();
        if (!hasCachedTCG || shouldUpdateTCGCache()) {
            await loadTCGCache((progress, message) => {
                updateTCGCacheProgress(progress, message);
            });
        } else {
            updateTCGCacheProgress(100, `使用快取 (${tcgCache.length} 筆)`);
        }
        
        // 載入測試案例
        await loadTestCases(false, (progress, message) => {
            updateTestCaseProgress(progress, message);
        });
        
    } catch (error) {
        console.error('初始化失敗:', error);
    } finally {
        // 隱藏進度條
        hideLoadingProgress();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 進度條控制函數
function showLoadingProgress() {
    const progressDiv = document.getElementById('loadingProgress');
    if (progressDiv) {
        progressDiv.style.display = 'block';
    }
    
    // 隱藏搜尋與篩選區和表格
    const searchCard = document.getElementById('searchFilterCard');
    const tableCard = document.querySelector('#testCasesTable').closest('.card');
    if (searchCard) searchCard.style.display = 'none';
    if (tableCard) tableCard.style.display = 'none';
}

function hideLoadingProgress() {
    const progressDiv = document.getElementById('loadingProgress');
    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
    
    // 顯示搜尋與篩選區和表格
    const searchCard = document.getElementById('searchFilterCard');
    const tableCard = document.querySelector('#testCasesTable').closest('.card');
    if (searchCard) searchCard.style.display = 'block';
    if (tableCard) tableCard.style.display = 'block';
    // 顯示後調整列表高度
    adjustTestCasesScrollHeight();
}


function updateTestCaseProgress(progress, message = '') {
    const progressBar = document.getElementById('testCaseProgressBar');
    const progressText = document.getElementById('testCaseProgress');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = `${Math.round(progress)}%${message ? ' - ' + message : ''}`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function updateTCGCacheProgress(progress, message = '') {
    const progressBar = document.getElementById('tcgCacheProgressBar');
    const progressText = document.getElementById('tcgCacheProgress');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = `${Math.round(progress)}%${message ? ' - ' + message : ''}`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}


async function loadTestCases(showLoadingBlock = true, updateProgress = null) {
    try {
        if (updateProgress) updateProgress(0, '開始載入測試案例...');
        
        if (showLoadingBlock) {
            showLoadingState();
        }
        
        // 獲取當前選擇的團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            throw new Error('請先選擇團隊');
        }
        
        if (updateProgress) updateProgress(30, '連接伺服器...');
        
        const response = await fetch(`/api/teams/${currentTeam.id}/testcases/`);
        if (!response.ok) {
            throw new Error(`載入測試案例失敗: ${response.status} ${response.statusText}`);
        }
        
        if (updateProgress) updateProgress(60, '解析資料...');
        
        testCases = await response.json();
        
        if (updateProgress) updateProgress(80, '處理資料...');
        
        // 預設按 Test Case Number 升冪排序
        testCases.sort((a, b) => {
            const aNumber = a.test_case_number || '';
            const bNumber = b.test_case_number || '';
            return aNumber.localeCompare(bNumber);
        });
        
        filteredTestCases = [...testCases];
        
        if (updateProgress) updateProgress(95, '渲染表格...');
        
        renderTestCasesTable();
        updatePagination();
        if (showLoadingBlock) {
            hideLoadingState();
        }
        
        if (updateProgress) updateProgress(100, `載入完成 (${testCases.length} 筆)`);
        
    } catch (error) {
        console.error('載入測試案例失敗:', error);
        showError('載入測試案例失敗：' + error.message);
        if (showLoadingBlock) {
            hideLoadingState();
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function refreshTestCases() {
    const refreshBtn = document.getElementById('refreshBtn');
    const originalHTML = refreshBtn.innerHTML;
    
    // 顯示載入動畫在按鈕內
    refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>重新載入';
    refreshBtn.disabled = true;
    
    try {
        // 調用 loadTestCases，但不顯示載入區塊
        await loadTestCases(false);
    } finally {
        // 恢復按鈕原始狀態
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function renderTestCasesTable() {
    const tbody = document.getElementById('testCasesTableBody');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageTestCases = filteredTestCases.slice(startIndex, endIndex);
    
    if (pageTestCases.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <div class="text-muted">沒有找到符合條件的測試案例</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pageTestCases.map(testCase => `
        <tr>
            <td class="align-middle text-center">
                <input type="checkbox" class="form-check-input test-case-checkbox" 
                       value="${testCase.record_id}" ${selectedTestCases.has(testCase.record_id) ? 'checked' : ''}>
            </td>
            <td class="align-middle position-relative hover-editable" data-field="test_case_number" data-record-id="${testCase.record_id}">
                <div style="padding-right: 45px;">
                    <code class="small">${testCase.test_case_number || testCase.record_id}</code>
                </div>
                <button type="button" class="btn btn-sm btn-edit position-absolute hover-edit-btn" 
                        style="top: 50%; right: 5px; transform: translateY(-50%); z-index: 10;" 
                        onclick="quickEdit('${testCase.record_id}', 'test_case_number')" title="快速編輯">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="align-middle position-relative hover-editable" data-field="title" data-record-id="${testCase.record_id}">
                <div class="d-flex align-items-center" style="padding-right: 45px;">
                    <div style="flex-grow: 1; min-width: 0;">
                        <div class="fw-medium text-truncate" title="${testCase.title}">${testCase.title}</div>
                        <div class="small text-muted text-truncate">
                            ${testCase.description ? testCase.description.substring(0, 60) + '...' : ''}
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-edit position-absolute hover-edit-btn" 
                        style="top: 50%; right: 5px; transform: translateY(-50%); z-index: 10;" 
                        onclick="quickEdit('${testCase.record_id}', 'title')" title="快速編輯">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="align-middle text-center position-relative" data-field="tcg" data-record-id="${testCase.record_id}">
                <div class="tcg-edit-area" onclick="editTCG('${testCase.record_id}')" title="點擊編輯 TCG">
                    ${getTCGTags(testCase)}
                </div>
            </td>
            <td class="align-middle text-center">
                <span class="badge ${getPriorityBadgeClass(testCase.priority)}">${getPriorityText(testCase.priority)}</span>
            </td>
            <td class="align-middle text-center">
                <div class="small text-muted text-nowrap">
                    ${formatDate(testCase.created_at, 'date')}
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="small text-muted text-nowrap">
                    ${formatDate(testCase.updated_at, 'date')}
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="test-case-actions">
                    <button type="button" class="btn btn-sm btn-view" 
                            onclick="viewTestCase('${testCase.record_id}')" title="檢視/編輯">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="deleteTestCase('${testCase.record_id}')" title="刪除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    // 渲染後調整列表可視高度
    adjustTestCasesScrollHeight();
}


function bindEvents() {
    // 新增按鈕
    document.getElementById('addTestCaseBtn').addEventListener('click', () => showTestCaseModal());
    
    // 重新載入按鈕
    document.getElementById('refreshBtn').addEventListener('click', refreshTestCases);
    
    // 搜尋與篩選
    document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
    
    // 批次操作
    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) batchDeleteBtn.addEventListener('click', batchDeleteTestCases);
    
    // 上一隻/下一隻測試案例按鈕
    document.getElementById('prevTestCaseBtn').addEventListener('click', showPrevTestCase);
    document.getElementById('nextTestCaseBtn').addEventListener('click', showNextTestCase);
    
    // 監聽表格內的複選框變化
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('test-case-checkbox')) {
            const recordId = e.target.value;
            if (e.target.checked) {
                selectedTestCases.add(recordId);
            } else {
                selectedTestCases.delete(recordId);
            }
            updateBatchToolbar();
        }
    });
    
    // 儲存按鈕
    document.getElementById('saveTestCaseBtn').addEventListener('click', saveTestCase);
}

let originalFormData = {}; // 存儲原始表單資料
let isFormChanged = false; // 追蹤表單是否有變更
let testCaseModalInstance = null; // 全域 Modal 實例

function showTestCaseModal(testCase = null) {
    const modal = document.getElementById('testCaseModal');
    const title = document.getElementById('testCaseModalTitle');
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    
    // 重設表單和狀態
    form.reset();
    isFormChanged = false;
    saveBtn.disabled = true;
    
    if (testCase) {
        // 編輯現有測試案例時，初始化附件資料
        if (testCase.attachments && testCase.attachments.length > 0) {
            uploadedAttachments = testCase.attachments.map(att => ({
                file_token: att.file_token,
                name: att.name,
                size: att.size,
                type: att.type || 'application/octet-stream'
            }));
        } else {
            uploadedAttachments = [];
        }
    } else {
        // 新增測試案例時，重設附件資料
        uploadedAttachments = [];
    }
    
    if (testCase) {
        // 找到當前測試案例在 filteredTestCases 中的索引
        currentTestCaseIndex = filteredTestCases.findIndex(tc => tc.record_id === testCase.record_id);
        updateNavigationButtons();
        title.textContent = '檢視測試案例';
        
        // 填入資料
        document.getElementById('testCaseId').value = testCase.record_id;
        
        // 設定 modal 的 recordId dataset 供刪除附件使用
        modal.dataset.recordId = testCase.record_id;
        document.getElementById('title').value = testCase.title || '';
        document.getElementById('testCaseNumber').value = testCase.test_case_number || '';
        document.getElementById('priority').value = testCase.priority || 'Medium';
        const tcgValue = testCase.tcg ? testCase.tcg.map(t => t.text || t).join(', ') : '';
        document.getElementById('tcg').value = tcgValue;
        
        // 更新 Modal TCG 輸入框
        const modalTCGInput = document.getElementById('modalTCGInput');
        if (modalTCGInput) {
            modalTCGInput.value = tcgValue || '';
            // 不自動顯示下拉選單，只設定值
        }
        document.getElementById('precondition').value = testCase.precondition || '';
        document.getElementById('test_steps').value = testCase.steps || '';
        document.getElementById('expected_result').value = testCase.expected_result || '';
        
        // 渲染附件列表
        renderAttachmentsList();
        
        // 儲存原始資料用於比較
        originalFormData = {
            title: testCase.title || '',
            test_case_number: testCase.test_case_number || '',
            priority: testCase.priority || 'Medium',
            tcg: testCase.tcg ? testCase.tcg.map(t => t.text || t).join(', ') : '',
            precondition: testCase.precondition || '',
            steps: testCase.steps || '',
            expected_result: testCase.expected_result || ''
        };
        
        // 初始化 Markdown 預覽內容
        markdownFields.forEach(fieldId => {
            updateMarkdownPreview(fieldId);
        });
        
    } else {
        title.textContent = '新增測試案例';
        document.getElementById('testCaseId').value = '';
        originalFormData = {};
        saveBtn.disabled = false; // 新增模式下儲存按鈕啟用
        currentTestCaseIndex = -1;
        updateNavigationButtons();
        
        // 渲染附件列表（新增模式下為空）
        renderAttachmentsList();
    }
    
    // 啟用所有欄位（檢視/編輯合一）
    form.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false);
    
    // 綁定變更監聽器
    bindFormChangeListeners();
    
    // 在顯示 modal 前，確保所有滾動位置都在頂部
    // 這樣做可以避免 modal 顯示時的跳動效果
    resetModalScrollPositions(modal);
    
    // 只創建一次 Modal 實例，避免 backdrop 累積
    if (!testCaseModalInstance) {
        testCaseModalInstance = new bootstrap.Modal(modal);
        
        // 只綁定一次事件監聽器
        // 顯示前立即重置滾動，並暫時隱藏內容避免進場彈跳
        modal.addEventListener('show.bs.modal', function() {
            modal.classList.add('modal-preparing');
            resetModalScrollPositions(modal);
        });
        // 顯示後完成高度計算，再解除隱藏（整體觀感無彈跳）
        modal.addEventListener('shown.bs.modal', function() {
            calculateDynamicHeights();
            resetModalScrollPositions(modal);
            modal.classList.remove('modal-preparing');
        });
    }
    
    testCaseModalInstance.show();
}

function viewTestCase(id) {
    const testCase = testCases.find(tc => tc.record_id === id);
    if (testCase) {
        showTestCaseModal(testCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 表單變更監聽器
function bindFormChangeListeners() {
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    
    // 為所有表單欄位綁定變更事件
    form.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('input', checkFormChanges);
        element.addEventListener('change', checkFormChanges);
    });
}

// 檢查表單是否有變更
function checkFormChanges() {
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const formData = new FormData(form);
    
    // 檢查新增模式
    if (!document.getElementById('testCaseId').value) {
        // 新增模式：檢查是否有填入必要欄位
        const hasTitle = formData.get('title') && formData.get('title').trim();
        saveBtn.disabled = !hasTitle;
        return;
    }
    
    // 編輯模式：比較與原始資料的差異
    let hasChanges = false;
    
    for (const [key, value] of Object.entries(originalFormData)) {
        const currentValue = formData.get(key) || '';
        if (currentValue !== value) {
            hasChanges = true;
            break;
        }
    }
    
    isFormChanged = hasChanges;
    saveBtn.disabled = !hasChanges;
}

function deleteTestCase(id) {
    const testCase = testCases.find(tc => tc.record_id === id);
    if (!testCase) return;
    
    // 設置刪除確認 Modal 的內容
    const deleteList = document.getElementById('deleteList');
    deleteList.innerHTML = `
        <div class="mb-3">
            <p class="mb-2">確定要刪除以下測試案例嗎？</p>
            <div class="border rounded p-3 bg-light">
                <strong class="text-primary">${testCase.test_case_number || testCase.record_id}: ${testCase.title}</strong>
            </div>
        </div>
    `;
    
    // 顯示刪除確認 Modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    
    // 設置確認刪除的處理
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 發送刪除請求
            const response = await fetch(`/api/teams/${currentTeam.id}/testcases/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '刪除失敗');
            }
            
            // 關閉 Modal
            deleteModal.hide();
            
            // 從本地陣列移除已刪除的項目（背景處理，不顯示載入動畫）
            const deletedId = recordId;
            testCases = testCases.filter(tc => tc.record_id !== deletedId);
            filteredTestCases = filteredTestCases.filter(tc => tc.record_id !== deletedId);
            
            // 重新渲染表格和分頁
            renderTestCasesTable();
            updatePagination();
            
            // 用 toast 通知成功
            AppUtils.showSuccess('測試案例刪除成功');
            
        } catch (error) {
            console.error('刪除測試案例失敗:', error);
            showError('刪除失敗：' + error.message);
        }
    };
}

async function saveTestCase() {
    const form = document.getElementById('testCaseForm');
    const formData = new FormData(form);
    
    const testCaseData = {
        title: formData.get('title'),
        test_case_number: formData.get('test_case_number'),
        priority: formData.get('priority'),
        precondition: document.getElementById('precondition').value,
        steps: document.getElementById('test_steps').value,
        expected_result: document.getElementById('expected_result').value,
        tcg: document.getElementById('modalTCGInput').value  // 從新的 type-to-search 輸入框取得 TCG
        // 注意：不再包含 attachments，因為附件現在是立即附加到記錄的
    };
    
    // 除錯：檢查 test_steps 是否被正確收集
    const testStepsElement = document.getElementById('test_steps');
    console.log('test_steps element:', testStepsElement);
    console.log('test_steps element value:', testStepsElement ? testStepsElement.value : 'element not found');
    console.log('FormData test_steps:', formData.get('test_steps'));
    console.log('All form entries:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    console.log('testCaseData:', testCaseData);
    
    // 表單驗證
    if (!testCaseData.title) {
        showError('請填寫測試案例標題');
        return;
    }
    
    // 獲取當前選擇的團隊
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError('請先選擇團隊');
        return;
    }
    
    const testCaseId = document.getElementById('testCaseId').value;
    
    // 不關閉 Modal，保持編輯窗開啟以支持快速編輯
    // 重置變更狀態並禁用儲存按鈕
    isFormChanged = false;
    const saveBtn = document.getElementById('saveTestCaseBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>儲存中...';
    
    // 顯示儲存中訊息
    showSuccess(testCaseId ? '測試案例更新中...' : '測試案例新增中...');
    
    // 背景處理儲存
    setTimeout(async () => {
        try {
            let response;
            
            if (testCaseId) {
                // 更新現有測試案例
                response = await fetch(`/api/teams/${currentTeam.id}/testcases/${testCaseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCaseData)
                });
            } else {
                // 新增測試案例
                response = await fetch(`/api/teams/${currentTeam.id}/testcases/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCaseData)
                });
            }
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '儲存失敗');
            }
            
            // 如果是新增測試案例，需要取得新的記錄ID並轉為編輯模式
            if (!testCaseId) {
                const newTestCase = await response.json();
                if (newTestCase && newTestCase.record_id) {
                    document.getElementById('testCaseId').value = newTestCase.record_id;
                    document.getElementById('testCaseModalTitle').textContent = '檢視測試案例';
                }
            }
            
            // 重新載入測試案例（不顯示載入動畫）
            await loadTestCases(false);
            
            // 恢復儲存按鈕狀態
            const saveBtn = document.getElementById('saveTestCaseBtn');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>儲存';
            
            // 更新成功訊息
            showSuccess(testCaseId ? '測試案例更新完成' : '測試案例新增完成');
            
        } catch (error) {
            console.error('儲存測試案例失敗:', error);
            
            // 恢復儲存按鈕狀態
            const saveBtn = document.getElementById('saveTestCaseBtn');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>儲存';
            
            showError('儲存失敗：' + error.message);
        }
    }, 100); // 100ms 延遲確保 UI 響應
}

// 工具函數
function getStatusBadgeClass(status) {
    const classes = {
        'Draft': 'bg-secondary',
        'Review': 'bg-warning',
        'Active': 'bg-success',
        'Deprecated': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getStatusText(status) {
    const texts = {
        'Draft': '草稿',
        'Review': '待審核',
        'Active': '啟用',
        'Deprecated': '廢棄'
    };
    return texts[status] || status;
}

function getPriorityBadgeClass(priority) {
    const classes = {
        'High': 'bg-danger',
        'Medium': 'bg-warning',
        'Low': 'bg-info'
    };
    return classes[priority] || 'bg-secondary';
}

function getPriorityText(priority) {
    return priority || '';
}

function getTCGDisplay(testCase) {
    if (!testCase.tcg || testCase.tcg.length === 0) {
        return '-';
    }
    
    // 提取所有 TCG 顯示文字
    const tcgNumbers = [];
    for (const tcgRecord of testCase.tcg) {
        if (tcgRecord.text) {
            tcgNumbers.push(tcgRecord.text);
        } else if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            tcgNumbers.push(...tcgRecord.text_arr);
        }
    }
    
    return tcgNumbers.length > 0 ? tcgNumbers.join(', ') : '-';
}

function getTCGTags(testCase) {
    if (!testCase.tcg || testCase.tcg.length === 0) {
        return '';
    }
    
    // 提取所有 TCG 顯示文字
    const tcgNumbers = [];
    for (const tcgRecord of testCase.tcg) {
        if (tcgRecord.text) {
            tcgNumbers.push(tcgRecord.text);
        } else if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            tcgNumbers.push(...tcgRecord.text_arr);
        }
    }
    
    if (tcgNumbers.length === 0) {
        return '';
    }
    
    // 創建柔和的 tag
    return tcgNumbers.map(tcg => 
        `<span class="tcg-tag">${tcg}</span>`
    ).join('');
}

function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const priority = document.getElementById('priorityFilter').value;
    
    filteredTestCases = testCases.filter(testCase => {
        const matchSearch = !search || 
            testCase.title.toLowerCase().includes(search) ||
            (testCase.description && testCase.description.toLowerCase().includes(search));
        
        const matchPriority = !priority || testCase.priority === priority;
        
        return matchSearch && matchPriority;
    });
    
    currentPage = 1;
    renderTestCasesTable();
    updatePagination();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('priorityFilter').value = '';
    
    filteredTestCases = [...testCases];
    currentPage = 1;
    renderTestCasesTable();
    updatePagination();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.test-case-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const id = checkbox.value; // record_id 是字串，勿轉數字
        if (selectAll) {
            selectedTestCases.add(id);
        } else {
            selectedTestCases.delete(id);
        }
    });
    
    updateBatchToolbar();
}

function updateBatchToolbar() {
    const toolbar = document.getElementById('batchInlineToolbar');
    const count = document.getElementById('selectedCount');
    if (!toolbar || !count) return;
    count.textContent = selectedTestCases.size;
    if (selectedTestCases.size > 0) {
        toolbar.classList.remove('d-none');
    } else {
        toolbar.classList.add('d-none');
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function deselectAll() {
    selectedTestCases.clear();
    document.querySelectorAll('.test-case-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateBatchToolbar();
}

function batchEditTestCases() {
    if (selectedTestCases.size === 0) {
        showError('請先選擇要編輯的測試案例');
        return;
    }
    // TODO: 實現批次編輯功能
    alert('批次編輯功能開發中...');
}

function batchDeleteTestCases() {
    if (selectedTestCases.size === 0) {
        showError('請先選擇要刪除的測試案例');
        return;
    }
    
    // 獲取選中的測試案例
    const selectedIds = Array.from(selectedTestCases);
    const selectedCases = testCases.filter(tc => selectedIds.includes(tc.record_id));
    
    // 設置批次刪除確認 Modal 的內容
    const deleteList = document.getElementById('deleteList');
    deleteList.innerHTML = `
        <div class="mb-3">
            <p class="mb-2">確定要刪除以下 ${selectedCases.length} 個測試案例嗎？</p>
            <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                ${selectedCases.map(tc => `
                    <div class="mb-2">
                        <strong class="text-primary">${tc.test_case_number || tc.record_id}: ${tc.title}</strong>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // 顯示刪除確認 Modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    
    // 設置確認刪除的處理
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 發送批次刪除請求
            const response = await fetch(`/api/teams/${currentTeam.id}/testcases/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'delete',
                    record_ids: selectedIds
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '批次刪除失敗');
            }
            
            // 關閉 Modal
            deleteModal.hide();
            
            // 清除選擇
            deselectAll();
            
            // 從本地陣列移除已刪除的項目（背景處理，不顯示載入動畫）
            const deletedIds = Array.from(selectedIds);
            testCases = testCases.filter(tc => !deletedIds.includes(tc.record_id));
            filteredTestCases = filteredTestCases.filter(tc => !deletedIds.includes(tc.record_id));
            
            // 重新渲染表格和分頁
            renderTestCasesTable();
            updatePagination();
            
            // 用 toast 通知成功
            AppUtils.showSuccess(`成功刪除 ${selectedCases.length} 個測試案例`);
            
        } catch (error) {
            console.error('批次刪除測試案例失敗:', error);
            showError('批次刪除失敗：' + error.message);
        }
    };
}

function showLoadingState() {
    const tbody = document.getElementById('testCasesTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center" style="padding-top: 4rem; padding-bottom: 4rem; padding-left: 1rem; padding-right: 1rem;">
                <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <div class="mt-2 text-muted fs-6">載入測試案例中...</div>
            </td>
        </tr>
    `;
}

function hideLoadingState() {
    // hideLoadingState 現在由 renderTestCasesTable 來處理
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(filteredTestCases.length / pageSize);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        // 分頁內容清空後也需要重新計算列表高度，以避免 sticky 分頁高度變化造成重疊
        if (typeof adjustTestCasesScrollHeight === 'function') {
            adjustTestCasesScrollHeight();
        }
        return;
    }
    
    let paginationHtml = '';
    
    // 上一頁
    paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一頁</a>
        </li>
    `;
    
    // 頁碼
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
    }
    
    // 下一頁
    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一頁</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHtml;
    // 分頁內容更新後，重新計算列表高度，避免與分頁重疊
    if (typeof adjustTestCasesScrollHeight === 'function') {
        adjustTestCasesScrollHeight();
    }
}

function changePage(page) {
    const totalPages = Math.ceil(filteredTestCases.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTestCasesTable();
        updatePagination();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 快速編輯功能
function quickEdit(recordId, field) {
    const testCase = testCases.find(tc => tc.record_id === recordId);
    if (!testCase) return;
    
    const cell = document.querySelector(`[data-record-id="${recordId}"][data-field="${field}"]`);
    if (!cell) return;
    
    // 獲取當前值
    const currentValue = testCase[field] || '';
    
    // 建立輸入框
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.className = 'form-control quick-edit-input';
    input.style.width = '100%';
    input.style.height = 'auto';
    input.style.minHeight = '1.5rem';
    input.style.lineHeight = '1.5';
    input.style.fontSize = '0.875rem';
    input.style.padding = '0.25rem 0.5rem';
    input.style.border = '1px solid #007bff';
    input.style.borderRadius = '4px';
    input.style.margin = '0';
    
    // 儲存原始內容
    const originalContent = cell.innerHTML;
    
    // 替換內容
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
    input.select();
    
    // 處理儲存
    const saveEdit = async () => {
        const newValue = input.value.trim();
        
        if (newValue === currentValue) {
            // 值沒有變更，恢復原始內容
            cell.innerHTML = originalContent;
            return;
        }
        
        // 立即更新本地資料和 UI
        testCase[field] = newValue;
        cell.innerHTML = originalContent; // 先恢復原始結構
        
        // 立即重新渲染表格以顯示新值
        renderTestCasesTable();
        
        // 在背景處理儲存
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 構建更新資料
            const updateData = {};
            updateData[field] = newValue;
            
            // 背景發送更新請求，不等待響應
            fetch(`/api/teams/${currentTeam.id}/testcases/${recordId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            }).then(async response => {
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '更新失敗');
                }
                // 成功後顯示提示，但不重新渲染（已經渲染過了）
                showSuccess(`${field === 'test_case_number' ? 'Test Case Number' : '標題'} 更新成功`);
            }).catch(error => {
                console.error('快速編輯失敗:', error);
                showError('更新失敗：' + error.message);
                
                // 如果儲存失敗，恢復原值並重新渲染
                testCase[field] = currentValue;
                renderTestCasesTable();
            });
            
        } catch (error) {
            console.error('快速編輯失敗:', error);
            showError('更新失敗：' + error.message);
            
            // 恢復原值並重新渲染
            testCase[field] = currentValue;
            renderTestCasesTable();
        }
    };
    
    // 處理取消
    const cancelEdit = () => {
        cell.innerHTML = originalContent;
    };
    
    // 綁定事件
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit();
        }
    });
    
    input.addEventListener('blur', saveEdit);
}

// TCG 編輯功能 - 簡化直接編輯
let currentTCGEditor = null;

async function editTCG(recordId) {
    const testCase = testCases.find(tc => tc.record_id === recordId);
    if (!testCase) return;
    
    const cell = document.querySelector(`[data-record-id="${recordId}"][data-field="tcg"]`);
    if (!cell) return;
    
    // 如果已經有編輯器在運行，先關閉
    if (currentTCGEditor && currentTCGEditor.recordId !== recordId) {
        await finishTCGEdit();
    }
    
    // 獲取當前 TCG
    const currentTCGs = [];
    for (const tcgRecord of testCase.tcg || []) {
        if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            currentTCGs.push(...tcgRecord.text_arr);
        } else if (tcgRecord.text) {
            currentTCGs.push(tcgRecord.text);
        }
    }
    
    // 設置編輯器狀態
    currentTCGEditor = {
        recordId: recordId,
        cell: cell,
        originalTCGs: [...currentTCGs],
        currentTCGs: [...currentTCGs],
        originalContent: cell.innerHTML,
        mode: 'search'
    };
    
    // 直接進入搜尋模式
    startTCGSearch();
}

async function startTCGSearch() {
    if (!currentTCGEditor) return;
    
    const { cell, currentTCGs, recordId } = currentTCGEditor;
    
    // 直接顯示搜尋框 - 隱藏原標籤
    const searchHtml = `
        <div class="tcg-search-container position-relative" style="min-height: 32px; height: 32px; display: flex; align-items: center; overflow: hidden;">
            <input type="text" class="form-control form-control-sm tcg-search-input" 
                   placeholder="搜尋 TCG..." autocomplete="off" 
                   onkeydown="handleTCGSearchKeydown(event)" 
                   oninput="handleTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="height: 28px; width: 100%; font-size: 0.75rem; padding: 0.125rem 0.375rem; border: 1px solid #dee2e6; box-shadow: none; outline: none;">
            <div class="tcg-dropdown" 
                 style="display: none;">
                <div class="p-2 text-muted small">開始輸入以搜尋 TCG...</div>
            </div>
        </div>
    `;
    
    cell.innerHTML = searchHtml;
    cell.classList.add('editing');
    
    // 聚焦搜尋框並立即載入選項
    const searchInput = cell.querySelector('.tcg-search-input');
    searchInput.focus();
    
    // 立即載入 TCG 選項並顯示下拉選單
    await searchTCGOptions('');
    const dropdown = cell.querySelector('.tcg-dropdown');
    if (dropdown) {
        // 計算輸入框的位置
        const searchInput = cell.querySelector('.tcg-search-input');
        const rect = searchInput.getBoundingClientRect();
        
        // 設定 fixed 定位的座標
        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.width = Math.max(300, rect.width) + 'px';
        dropdown.style.display = 'block';
    }
    
    // 添加點擊外部結束編輯的監聽器
    setTimeout(() => {
        document.addEventListener('click', handleTCGOutsideClick, true);
    }, 100);
}

function handleTCGOutsideClick(event) {
    if (!currentTCGEditor) return;
    
    const { cell } = currentTCGEditor;
    
    // 檢查點擊是否在編輯區域外
    if (!cell.contains(event.target)) {
        finishTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function finishTCGEdit() {
    if (!currentTCGEditor) return;
    
    const { recordId, currentTCGs, originalTCGs, cell } = currentTCGEditor;
    
    // 移除全域點擊監聽器
    document.removeEventListener('click', handleTCGOutsideClick, true);
    
    // 檢查是否有變更
    const hasChanges = JSON.stringify(currentTCGs.sort()) !== JSON.stringify(originalTCGs.sort());
    
    // 立即更新 UI 顯示
    cell.classList.remove('editing');
    updateTCGCellDisplay(cell, currentTCGs);
    
    // 清除編輯器狀態
    currentTCGEditor = null;
    
    // 如果有變更，在背景處理儲存
    if (hasChanges) {
        // 非同步背景儲存，不等待完成
        saveTCGChanges(recordId, currentTCGs).catch(error => {
            console.error('TCG 儲存失敗:', error);
            // 如果儲存失敗，可以考慮顯示錯誤訊息或恢復原值
        });
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function updateTCGCellDisplay(cell, tcgNumbers) {
    // 更新單個 TCG 欄位的顯示，不重新渲染整個表格
    const recordId = cell.getAttribute('data-record-id');
    
    if (tcgNumbers.length === 0) {
        // 清除後留白，但保留點擊事件
        cell.innerHTML = `<div class="tcg-edit-area" onclick="editTCG('${recordId}')" title="點擊編輯 TCG"></div>`;
    } else {
        // 顯示 TCG 標籤，保留點擊事件
        const tcgHtml = tcgNumbers.map(tcg => 
            `<span class="tcg-tag">${tcg}</span>`
        ).join('');
        cell.innerHTML = `<div class="tcg-edit-area" onclick="editTCG('${recordId}')" title="點擊編輯 TCG">${tcgHtml}</div>`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function restoreTCGDisplay() {
    if (!currentTCGEditor) return;
    
    const { cell } = currentTCGEditor;
    cell.classList.remove('editing');
    renderTestCasesTable(); // 重新渲染以恢復正常顯示
}


let tcgSearchTimeout;

function handleTCGSearchInput(event) {
    clearTimeout(tcgSearchTimeout);
    tcgSearchTimeout = setTimeout(async () => {
        await searchTCGOptions(event.target.value);
    }, 300);
}

function handleTCGSearchKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        finishTCGEdit();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        // 取消變更
        if (currentTCGEditor) {
            currentTCGEditor.currentTCGs = [...currentTCGEditor.originalTCGs];
        }
        finishTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function searchTCGOptions(keyword) {
    if (!currentTCGEditor) return;
    
    const dropdown = currentTCGEditor.cell.querySelector('.tcg-dropdown');
    if (!dropdown) return;
    
    try {
        console.log('搜尋 TCG:', keyword);
        
        // 優先使用快取
        let results = [];
        if (tcgCache) {
            results = searchTCGFromCache(keyword, 20);
            console.log('從快取取得 TCG 搜尋結果:', results.length, '筆');
        } else {
            // 如果沒有快取，使用 API
            const response = await fetch(`/api/tcg/search?keyword=${encodeURIComponent(keyword)}&limit=20`);
            if (!response.ok) {
                console.error('TCG 搜尋失敗:', response.status, response.statusText);
                throw new Error(`搜尋 TCG 失敗: ${response.status}`);
            }
            const data = await response.json();
            results = data.results;
            console.log('從 API 取得 TCG 搜尋結果:', results.length, '筆');
        }
        
        // 始終顯示清除選項作為第一項
        let dropdownHtml = `
            <div class="tcg-option p-2 border-bottom" 
                  onclick="event.stopPropagation(); clearTCGValue()" 
                  style="cursor: pointer; border-bottom: 1px solid #f8f9fa; background-color: #fff3cd;" 
                  onmouseover="this.style.backgroundColor='#ffeaa7'" 
                  onmouseout="this.style.backgroundColor='#fff3cd'">
                <div class="fw-medium text-warning">
                    <i class="fas fa-times me-2"></i>清除 TCG 單號
                </div>
            </div>
        `;
        
        if (results.length === 0) {
            dropdownHtml += '<div class="p-2 text-muted small">沒有找到其他結果</div>';
        } else {
            dropdownHtml += results.map(tcg => 
                `<div class="tcg-option p-2 border-bottom" 
                      onclick="event.stopPropagation(); selectTCGOption('${tcg.tcg_number}')" 
                      style="cursor: pointer; border-bottom: 1px solid #f8f9fa; padding: 0.25rem 0.75rem;" 
                      onmouseover="this.style.backgroundColor='#f8f9fa'" 
                      onmouseout="this.style.backgroundColor='white'">
                    <div class="fw-medium">${tcg.tcg_number}</div>
                </div>`
            ).join('');
        }
        
        dropdown.innerHTML = dropdownHtml;
        
        // 更新位置並顯示
        const searchInput = currentTCGEditor.cell.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
        
    } catch (error) {
        console.error('搜尋 TCG 失敗:', error);
        dropdown.innerHTML = '<div class="p-2 text-danger small">搜尋失敗</div>';
        
        // 更新位置並顯示
        const searchInput = currentTCGEditor.cell.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function selectTCGOption(tcgNumber) {
    if (!currentTCGEditor) return;
    
    // 設置單一 TCG 值
    currentTCGEditor.currentTCGs = [tcgNumber];
    
    // 立即完成編輯並儲存
    finishTCGEdit();
}

function clearTCGValue() {
    if (!currentTCGEditor) return;
    
    // 清空 TCG 值
    currentTCGEditor.currentTCGs = [];
    
    // 立即完成編輯並儲存
    finishTCGEdit();
}

async function fetchTCGRecordByNumber(tcgNumber) {
    try {
        // 從 TCG API 獲取對應的記錄資訊
        const response = await fetch(`/api/tcg/search?keyword=${encodeURIComponent(tcgNumber)}&limit=1`);
        if (!response.ok) {
            return null;
        }
        
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            const tcg = data.results[0];
            // 找到完全匹配的 TCG
            if (tcg.tcg_number === tcgNumber) {
                return {
                    record_id: tcg.record_id || `tcg_${tcg.tcg_number}`,
                    table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
                    tcg_number: tcg.tcg_number,
                    title: tcg.title
                };
            }
        }
        
        // 如果找不到對應記錄，創建一個模擬記錄
        return {
            record_id: `tcg_${tcgNumber}`,
            table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
            tcg_number: tcgNumber,
            title: tcgNumber
        };
    } catch (error) {
        console.error('查詢 TCG 記錄失敗:', error);
        // 返回模擬記錄以保持功能運作
        return {
            record_id: `tcg_${tcgNumber}`,
            table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
            tcg_number: tcgNumber,
            title: tcgNumber
        };
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function saveTCGChanges(recordId, tcgNumbers) {
    try {
        // 獲取當前團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            throw new Error('請先選擇團隊');
        }
        
        // 將 TCG 編號轉換為 LarkRecord 格式
        const tcgRecords = [];
        for (const tcgNum of tcgNumbers) {
            // 使用 TCG 轉換器查詢對應的記錄 ID
            const tcgRecord = await fetchTCGRecordByNumber(tcgNum);
            if (tcgRecord) {
                tcgRecords.push({
                    record_ids: [tcgRecord.record_id],
                    text: tcgNum,
                    text_arr: [tcgNum],
                    table_id: tcgRecord.table_id || '',
                    type: 'record'
                });
            }
        }
        
        // 構建更新資料
        const updateData = {
            tcg: tcgRecords
        };
        
        // 發送更新請求
        const response = await fetch(`/api/teams/${currentTeam.id}/testcases/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || '更新失敗');
        }
        
        // 更新本地資料
        const testCase = testCases.find(tc => tc.record_id === recordId);
        if (testCase) {
            testCase.tcg = tcgRecords;
        }
        
        // 重新渲染表格
        renderTestCasesTable();
        
        showSuccess(`TCG 更新成功`);
        
    } catch (error) {
        console.error('更新 TCG 失敗:', error);
        showError('更新失敗：' + error.message);
        
        // 恢復原始內容
        restoreTCGDisplay();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}


// 通用工具函數
function showSuccess(message) {
    if (AppUtils && AppUtils.showSuccess) {
        AppUtils.showSuccess(message);
    } else {
        alert(message);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function showError(message) {
    if (AppUtils && AppUtils.showError) {
        AppUtils.showError(message);
    } else {
        alert(message);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function formatDate(dateString, format) {
    if (AppUtils && AppUtils.formatDate) {
        return AppUtils.formatDate(dateString, format);
    } else {
        return new Date(dateString).toLocaleDateString();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// Markdown 編輯器功能
let currentEditorMode = 'preview'; // 預設為預覽模式
let markdownPreviewTimeout;
let activeTextarea = null; // 當前焦點的 textarea

// 支援 Markdown 的欄位
const markdownFields = ['precondition', 'test_steps', 'expected_result'];

// 初始化 Markdown 編輯器
function initializeMarkdownEditor() {
    // 模式切換按鈕
    document.getElementById('editModeBtn').addEventListener('click', () => setEditorMode('edit'));
    document.getElementById('previewModeBtn').addEventListener('click', () => setEditorMode('preview'));
    document.getElementById('splitModeBtn').addEventListener('click', () => setEditorMode('split'));
    
    // Markdown 工具列按鈕 (個別工具列)
    document.querySelectorAll('.markdown-toolbar button[data-md]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const toolbar = e.currentTarget.closest('.markdown-toolbar');
            const targetFieldId = toolbar.getAttribute('data-target');
            const mdSyntax = e.currentTarget.getAttribute('data-md');
            insertMarkdownToField(targetFieldId, mdSyntax);
        });
    });
    
    // 為所有 Markdown 欄位添加事件監聽
    markdownFields.forEach(fieldId => {
        const textarea = document.getElementById(fieldId);
        if (textarea) {
            // 焦點事件：記住當前活動的 textarea
            textarea.addEventListener('focus', () => {
                activeTextarea = textarea;
            });
            
            // 輸入事件：更新預覽
            textarea.addEventListener('input', () => {
                if (currentEditorMode !== 'edit') {
                    clearTimeout(markdownPreviewTimeout);
                    markdownPreviewTimeout = setTimeout(() => {
                        updateMarkdownPreview(fieldId);
                    }, 300);
                }
            });
        }
    });
    
    // 附件上傳功能
    const attachmentUpload = document.getElementById('attachmentUpload');
    if (attachmentUpload) {
        attachmentUpload.addEventListener('change', handleAttachmentUpload);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 設置編輯器模式
function setEditorMode(mode) {
    currentEditorMode = mode;
    
    // 更新按鈕狀態
    document.querySelectorAll('#editModeBtn, #previewModeBtn, #splitModeBtn').forEach(btn => {
        btn.classList.remove('active', 'btn-secondary');
        btn.classList.add('btn-outline-secondary');
    });
    const activeBtn = document.getElementById(mode + 'ModeBtn');
    activeBtn.classList.remove('btn-outline-secondary');
    activeBtn.classList.add('btn-secondary', 'active');
    
    // 為所有 Markdown 欄位設置模式
    markdownFields.forEach(fieldId => {
        const container = document.querySelector(`#${fieldId}`).closest('.markdown-field-container');
        if (!container) return;
        
        const editColumn = container.querySelector('.edit-column');
        const previewColumn = container.querySelector('.preview-column');
        
        // 重置類別
        editColumn.className = 'edit-column';
        previewColumn.className = 'preview-column';
        
        switch (mode) {
            case 'edit':
                editColumn.className = 'col-12 edit-column';
                previewColumn.className = 'col-12 d-none preview-column';
                break;
            case 'preview':
                editColumn.className = 'col-12 d-none edit-column';
                previewColumn.className = 'col-12 preview-column';
                updateMarkdownPreview(fieldId);
                break;
            case 'split':
                editColumn.className = 'col-6 edit-column';
                previewColumn.className = 'col-6 preview-column';
                updateMarkdownPreview(fieldId);
                break;
        }
    });
    
    // 控制個別工具列顯示
    markdownFields.forEach(fieldId => {
        const toolbar = document.querySelector(`.markdown-toolbar[data-target="${fieldId}"]`);
        if (toolbar) {
            toolbar.style.display = mode === 'preview' ? 'none' : 'block';
        }
    });
}

// 插入 Markdown 語法到指定欄位
function insertMarkdownToField(fieldId, syntax) {
    const textarea = document.getElementById(fieldId);
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    let cursorOffset = 0;
    
    if (syntax === '**' || syntax === '*' || syntax === '`') {
        insertText = syntax + selectedText + syntax;
        cursorOffset = syntax.length;
    } else if (syntax.startsWith('#')) {
        insertText = syntax + selectedText;
        cursorOffset = syntax.length;
    } else if (syntax === '- ' || syntax === '1. ') {
        const lines = selectedText.split('\n');
        if (lines.length === 1 && lines[0] === '') {
            insertText = syntax;
            cursorOffset = syntax.length;
        } else {
            insertText = lines.map((line, index) => {
                if (syntax === '1. ') {
                    return `${index + 1}. ${line}`;
                } else {
                    return `- ${line}`;
                }
            }).join('\n');
            cursorOffset = 0;
        }
    } else if (syntax === '[text](url)') {
        insertText = selectedText ? `[${selectedText}](url)` : '[text](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 1;
    } else if (syntax === '![alt](url)') {
        insertText = selectedText ? `![${selectedText}](url)` : '![alt](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 2;
    }
    
    // 替換選中的文字
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    
    // 設置光標位置
    if (selectedText) {
        textarea.setSelectionRange(start + cursorOffset, start + insertText.length - (syntax === '**' || syntax === '*' || syntax === '`' ? syntax.length : 0));
    } else {
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }
    
    textarea.focus();
    
    // 觸發變更事件
    textarea.dispatchEvent(new Event('input'));
}

// 插入 Markdown 語法到活動欄位 (保留向後兼容)
function insertMarkdownToActiveField(syntax) {
    const textarea = activeTextarea || document.getElementById('test_steps'); // 預設使用 test_steps
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    let cursorOffset = 0;
    
    if (syntax === '**' || syntax === '*' || syntax === '`') {
        insertText = syntax + selectedText + syntax;
        cursorOffset = syntax.length;
    } else if (syntax.startsWith('#')) {
        insertText = syntax + selectedText;
        cursorOffset = syntax.length;
    } else if (syntax === '- ' || syntax === '1. ') {
        const lines = selectedText.split('\n');
        if (lines.length === 1 && lines[0] === '') {
            insertText = syntax;
            cursorOffset = syntax.length;
        } else {
            insertText = lines.map((line, index) => {
                if (syntax === '1. ') {
                    return `${index + 1}. ${line}`;
                } else {
                    return `- ${line}`;
                }
            }).join('\n');
            cursorOffset = 0;
        }
    } else if (syntax === '[text](url)') {
        insertText = selectedText ? `[${selectedText}](url)` : '[text](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 1;
    } else if (syntax === '![alt](url)') {
        insertText = selectedText ? `![${selectedText}](url)` : '![alt](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 2;
    }
    
    // 替換選中的文字
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    
    // 設置光標位置
    if (selectedText) {
        textarea.setSelectionRange(start + cursorOffset, start + insertText.length - (syntax === '**' || syntax === '*' || syntax === '`' ? syntax.length : 0));
    } else {
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }
    
    textarea.focus();
    
    // 觸發變更事件
    textarea.dispatchEvent(new Event('input'));
}

// 更新特定欄位的 Markdown 預覽
function updateMarkdownPreview(fieldId) {
    if (fieldId) {
        // 更新特定欄位
        updateSingleFieldPreview(fieldId);
    } else {
        // 更新所有欄位
        markdownFields.forEach(id => updateSingleFieldPreview(id));
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 更新單一欄位的預覽
function updateSingleFieldPreview(fieldId) {
    const textarea = document.getElementById(fieldId);
    const previewDiv = document.querySelector(`.markdown-preview[data-target="${fieldId}"]`);
    
    if (!textarea || !previewDiv) return;
    
    const content = textarea.value;
    
    if (typeof marked !== 'undefined') {
        try {
            previewDiv.innerHTML = marked.parse(content);
        } catch (error) {
            previewDiv.innerHTML = '<p class="text-muted">Markdown 解析錯誤</p>';
        }
    } else {
        // 簡單的 Markdown 轉換
        let html = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">')
            .replace(/\n/g, '<br>');
        
        previewDiv.innerHTML = html || '<p class="text-muted">預覽將在此顯示...</p>';
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 附件管理功能
// 全域變數來儲存上傳的附件
let uploadedAttachments = [];

function handleAttachmentUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // 驗證檔案
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB 限制
            showError(`檔案 "${file.name}" 超過 10MB 大小限制`);
            return;
        }
    }
    
    // 顯示上傳中狀態
    const attachmentsList = document.getElementById('attachmentsList');
    const uploadingHtml = Array.from(files).map(file => `
        <div class="attachment-item d-flex align-items-center justify-content-between p-2 border rounded mb-2">
            <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-muted"></i>
                <span>${file.name}</span>
                <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
            </div>
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">上傳中...</span>
            </div>
        </div>
    `).join('');
    
    attachmentsList.innerHTML = uploadingHtml;
    
    // 實際上傳檔案到伺服器
    uploadFilesToServer(Array.from(files));
}

async function uploadFilesToServer(files) {
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError('請先選擇團隊');
        return;
    }
    
    const attachmentsList = document.getElementById('attachmentsList');
    const uploadedFiles = [];
    let totalFiles = files.length;
    let completedFiles = 0;
    
    try {
        // 顯示上傳進度區域
        attachmentsList.innerHTML = `
            <div class="upload-progress-container mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">正在上傳附件...</span>
                    <span class="text-muted">${completedFiles}/${totalFiles}</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">請稍等，正在處理您的檔案</small>
                </div>
            </div>
        `;
        
        const progressBar = attachmentsList.querySelector('.progress-bar');
        const progressText = attachmentsList.querySelector('span.text-muted');
        
        // 逐個上傳檔案並顯示進度
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // 更新當前上傳的檔案名稱
            const statusText = attachmentsList.querySelector('.mt-2 small');
            statusText.textContent = `正在上傳: ${file.name}`;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`/api/attachments/teams/${currentTeam.id}/upload-file-token`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // 立即附加到測試案例記錄
                    const currentRecordId = getCurrentRecordId();
                    if (currentRecordId) {
                        const statusText = attachmentsList.querySelector('.mt-2 small');
                        statusText.textContent = `正在附加: ${file.name}`;
                        
                        const attachFormData = new FormData();
                        attachFormData.append('file_token', result.file_token);
                        attachFormData.append('field_name', 'Attachment');
                        attachFormData.append('append', 'true');
                        
                        const attachResponse = await fetch(`/api/attachments/teams/${currentTeam.id}/testcases/${currentRecordId}/attach-token`, {
                            method: 'POST',
                            body: attachFormData
                        });
                        
                        if (attachResponse.ok) {
                            const attachResult = await attachResponse.json();
                            console.log(`附件 ${file.name} 已成功附加到記錄`);
                            
                            // 加到本地數組以供顯示
                            uploadedFiles.push({
                                file_token: result.file_token,
                                name: result.file_name,
                                size: result.file_size,
                                type: file.type || 'application/octet-stream'
                            });
                            
                            // 同時更新原始資料中的附件
                            const testCaseIndex = testCases.findIndex(tc => tc.record_id === currentRecordId);
                            if (testCaseIndex !== -1) {
                                if (!testCases[testCaseIndex].attachments) {
                                    testCases[testCaseIndex].attachments = [];
                                }
                                testCases[testCaseIndex].attachments.push({
                                    file_token: result.file_token,
                                    name: result.file_name,
                                    size: result.file_size,
                                    type: file.type || 'application/octet-stream'
                                });
                            }
                            
                            // 更新 filteredTestCases
                            const filteredIndex = filteredTestCases.findIndex(tc => tc.record_id === currentRecordId);
                            if (filteredIndex !== -1) {
                                if (!filteredTestCases[filteredIndex].attachments) {
                                    filteredTestCases[filteredIndex].attachments = [];
                                }
                                filteredTestCases[filteredIndex].attachments.push({
                                    file_token: result.file_token,
                                    name: result.file_name,
                                    size: result.file_size,
                                    type: file.type || 'application/octet-stream'
                                });
                            }
                        } else {
                            const attachError = await attachResponse.json();
                            throw new Error(`附加檔案失敗: ${attachError.detail || '未知錯誤'}`);
                        }
                    } else {
                        throw new Error('無法取得當前記錄ID，無法附加檔案');
                    }
                    
                    completedFiles++;
                    
                    // 更新進度條
                    const progress = (completedFiles / totalFiles) * 100;
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    if (progressText) {
                        progressText.textContent = `${completedFiles}/${totalFiles}`;
                    }
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `上傳 "${file.name}" 失敗`);
                }
            } catch (fileError) {
                console.error(`上傳檔案 ${file.name} 失敗:`, fileError);
                // 繼續上傳其他檔案，但記錄錯誤
                showError(`上傳 "${file.name}" 失敗: ${fileError.message}`);
            }
        }
        
        // 將上傳成功的檔案加到全域變數
        uploadedAttachments = uploadedAttachments.concat(uploadedFiles);
        
        // 更新附件列表顯示
        renderAttachmentsList();
        
        if (uploadedFiles.length > 0) {
            showSuccess(`成功上傳並附加 ${uploadedFiles.length} 個附件`);
            // 注意：現在不需要觸發表單變更檢查，因為附件已經立即附加到記錄
        }
        
    } catch (error) {
        console.error('上傳附件過程發生錯誤:', error);
        showError('上傳附件失敗：' + error.message);
        
        // 上傳失敗時顯示錯誤狀態
        attachmentsList.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>附件上傳失敗，請重試</div>
            </div>
        `;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function renderAttachmentsList() {
    const attachmentsList = document.getElementById('attachmentsList');
    if (!uploadedAttachments || uploadedAttachments.length === 0) {
        attachmentsList.innerHTML = '<p class="text-muted small mb-0">尚無附件</p>';
        return;
    }
    
    const attachmentsHtml = uploadedAttachments.map((attachment, index) => `
        <div class="attachment-item d-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-light">
            <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-primary"></i>
                <div>
                    <div class="fw-medium">${attachment.name}</div>
                    <div class="small text-muted">${formatFileSize(attachment.size || 0)}</div>
                </div>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeAttachment('${attachment.file_token}', '${attachment.name}', ${index})" title="移除附件">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    attachmentsList.innerHTML = `
        <div class="attachments-header mb-2">
            <h6 class="mb-0 text-secondary">已上傳的附件 (${uploadedAttachments.length})</h6>
        </div>
        ${attachmentsHtml}
    `;
}

function removeAttachment(index) {
    uploadedAttachments.splice(index, 1);
    renderAttachmentsList();
    checkFormChanges(); // 觸發表單變更檢查
}

// 格式化檔案大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 下載附件
function downloadAttachment(filename) {
    // 實際應該呼叫 API 來下載檔案
    console.log(`下載附件: ${filename}`);
}

// 移除附件
async function removeAttachment(fileToken, filename, index) {
    if (confirm(`確定要刪除附件 "${filename}" 嗎？`)) {
        try {
            console.log(`正在刪除附件: ${filename}...`);
            
            // 取得當前記錄的 ID
            const currentRecordId = getCurrentRecordId();
            if (!currentRecordId) {
                throw new Error('無法取得當前記錄 ID');
            }
            
            // 呼叫後端 API 刪除附件
            const response = await fetch(`/api/attachments/teams/1/testcases/${currentRecordId}/attachments/${fileToken}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '刪除附件失敗');
            }
            
            const result = await response.json();
            
            if (result.success) {
                // 從本地陣列中移除
                uploadedAttachments.splice(index, 1);
                
                // 同時更新原始 testCases 資料中的附件資訊
                const currentRecordId = getCurrentRecordId();
                if (currentRecordId) {
                    // 更新 testCases 陣列中對應記錄的附件
                    const testCaseIndex = testCases.findIndex(tc => tc.record_id === currentRecordId);
                    if (testCaseIndex !== -1) {
                        if (!testCases[testCaseIndex].attachments) {
                            testCases[testCaseIndex].attachments = [];
                        }
                        // 從原始資料中移除該附件
                        testCases[testCaseIndex].attachments = testCases[testCaseIndex].attachments.filter(
                            att => att.file_token !== fileToken
                        );
                    }
                    
                    // 同時更新 filteredTestCases 中的資料
                    const filteredIndex = filteredTestCases.findIndex(tc => tc.record_id === currentRecordId);
                    if (filteredIndex !== -1) {
                        if (!filteredTestCases[filteredIndex].attachments) {
                            filteredTestCases[filteredIndex].attachments = [];
                        }
                        filteredTestCases[filteredIndex].attachments = filteredTestCases[filteredIndex].attachments.filter(
                            att => att.file_token !== fileToken
                        );
                    }
                }
                
                // 重新渲染附件列表
                renderAttachmentsList();
                showSuccess(`已成功刪除附件: ${filename}`);
            } else {
                throw new Error(result.message || '刪除附件失敗');
            }
            
        } catch (error) {
            console.error('刪除附件錯誤:', error);
            showError(`刪除附件失敗: ${error.message}`);
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 重置 modal 內所有滾動位置的輔助函數
function resetModalScrollPositions(modal) {
    // 立即重置主要滾動容器
    const modalBody = modal.querySelector('.modal-body');
    if (modalBody) {
        modalBody.scrollTop = 0;
    }
    
    const scrollableContent = modal.querySelector('.scrollable-content');
    if (scrollableContent) {
        scrollableContent.scrollTop = 0;
    }
    
    // 重置所有 textarea 和其他可滾動元素
    const textareas = modal.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.scrollTop = 0;
    });
    
    // 重置所有 markdown 預覽區域
    const markdownPreviews = modal.querySelectorAll('.markdown-preview');
    markdownPreviews.forEach(preview => {
        preview.scrollTop = 0;
    });
    
    // 重置任何其他可能的滾動容器
    const scrollableElements = modal.querySelectorAll('[style*="overflow-y: auto"], .overflow-auto');
    scrollableElements.forEach(el => {
        el.scrollTop = 0;
    });
}

// 取得當前記錄 ID 的輔助函數
function getCurrentRecordId() {
    // 從 modal 或其他地方取得當前記錄的 ID
    const modal = document.getElementById('testCaseModal');
    if (modal && modal.dataset.recordId) {
        return modal.dataset.recordId;
    }
    
    // 如果沒有 modal，可能在其他地方，需要根據實際情況調整
    const recordIdElement = document.querySelector('[data-record-id]');
    if (recordIdElement) {
        return recordIdElement.dataset.recordId;
    }
    
    return null;
}

// Modal TCG 編輯功能
let currentModalTCGEditor = null;

async function editModalTCG() {
    const container = document.getElementById('modalTCGContainer');
    if (!container) return;
    
    // 如果已經在編輯中，直接返回
    if (currentModalTCGEditor) return;
    
    // 獲取當前 TCG 值
    const tcgInput = document.getElementById('tcg');
    const currentTCGText = tcgInput ? tcgInput.value : '';
    const currentTCGs = currentTCGText ? currentTCGText.split(', ').filter(t => t.trim()) : [];
    
    // 設置編輯器狀態
    currentModalTCGEditor = {
        container: container,
        originalTCGs: [...currentTCGs],
        currentTCGs: [...currentTCGs],
        originalContent: container.innerHTML
    };
    
    // 直接進入搜尋模式
    startModalTCGSearch();
}

async function startModalTCGSearch() {
    if (!currentModalTCGEditor) return;
    
    const { container, currentTCGs } = currentModalTCGEditor;
    
    // 顯示搜尋框
    const searchHtml = `
        <div class="tcg-modal-search-container position-relative" style="width: 100%;">
            <input type="text" class="form-control tcg-modal-search-input" 
                   placeholder="搜尋 TCG..." autocomplete="off" 
                   onkeydown="handleModalTCGSearchKeydown(event)" 
                   oninput="handleModalTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="width: 100%;">
            <div class="tcg-modal-dropdown" 
                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; background: white; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 0.375rem 0.375rem; max-height: 200px; overflow-y: auto;">
                <div class="p-2 text-muted small">開始輸入以搜尋 TCG...</div>
            </div>
        </div>
    `;
    
    container.innerHTML = searchHtml;
    container.classList.add('editing');
    
    // 聚焦搜尋框
    const searchInput = container.querySelector('.tcg-modal-search-input');
    searchInput.focus();
    
    // 立即載入 TCG 選項
    await searchModalTCGOptions('');
    const dropdown = container.querySelector('.tcg-modal-dropdown');
    if (dropdown) {
        dropdown.style.display = 'block';
    }
    
    // 添加點擊外部結束編輯的監聽器
    setTimeout(() => {
        document.addEventListener('click', handleModalTCGOutsideClick, true);
    }, 100);
}

function handleModalTCGOutsideClick(event) {
    if (!currentModalTCGEditor) return;
    
    const { container } = currentModalTCGEditor;
    
    // 檢查點擊是否在編輯區域外
    if (!container.contains(event.target)) {
        finishModalTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function finishModalTCGEdit() {
    if (!currentModalTCGEditor) return;
    
    const { container, currentTCGs, originalTCGs } = currentModalTCGEditor;
    
    // 移除全域點擊監聽器
    document.removeEventListener('click', handleModalTCGOutsideClick, true);
    
    // 更新隱藏的 input 值 (為了向後兼容)
    const tcgInput = document.getElementById('tcg');
    if (tcgInput) {
        tcgInput.value = currentTCGs.join(', ');
    }
    
    // 更新顯示
    container.classList.remove('editing');
    updateModalTCGDisplay(container, currentTCGs);
    
    // 清除編輯器狀態
    currentModalTCGEditor = null;
    
    // 觸發表單變更檢查
    checkFormChanges();
}

function updateModalTCGDisplay(container, tcgs) {
    if (tcgs.length === 0) {
        container.innerHTML = '<span class="text-muted">點擊編輯 TCG</span>';
    } else {
        container.innerHTML = tcgs.join(', ');
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function searchModalTCGOptions(keyword) {
    if (!currentModalTCGEditor) return;
    
    const container = currentModalTCGEditor.container;
    const dropdown = container.querySelector('.tcg-modal-dropdown');
    if (!dropdown) return;
    
    try {
        // 使用相同的 TCG 搜尋邏輯
        const results = searchTCGFromCache(keyword, 20);
        
        if (results.length === 0) {
            dropdown.innerHTML = `
                <div class="p-2 text-muted small">沒有找到匹配的 TCG</div>
                ${currentModalTCGEditor.currentTCGs.length > 0 ? 
                  `<div class="p-2 border-top">
                     <button class="btn btn-sm btn-outline-danger" onclick="clearModalTCG()">清除目前選擇</button>
                   </div>` : ''}
            `;
        } else {
            const optionsHtml = results.map(tcg => {
                const isSelected = currentModalTCGEditor.currentTCGs.includes(tcg.tcg_number);
                return `
                    <div class="tcg-modal-option p-2 d-flex justify-content-between align-items-center" 
                         style="cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                         onclick="selectModalTCG('${tcg.tcg_number}')"
                         onmouseover="this.style.backgroundColor='#f8f9fa'" 
                         onmouseout="this.style.backgroundColor='white'">
                        <div>
                            <strong class="text-primary">${tcg.tcg_number}</strong>
                        </div>
                        ${isSelected ? '<i class="fas fa-check text-success"></i>' : ''}
                    </div>
                `;
            }).join('');
            
            dropdown.innerHTML = optionsHtml + `
                <div class="p-2 border-top">
                    <small class="text-muted">
                        找到 ${results.length} 個結果
                        ${currentModalTCGEditor.currentTCGs.length > 0 ? 
                          `<button class="btn btn-sm btn-outline-danger ms-2" onclick="clearModalTCG()">清除目前選擇</button>` : ''}
                    </small>
                </div>
            `;
        }
    } catch (error) {
        console.error('搜尋 TCG 失敗:', error);
        dropdown.innerHTML = '<div class="p-2 text-danger small">搜尋失敗，請重試</div>';
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function handleModalTCGSearchKeydown(event) {
    if (event.key === 'Escape') {
        finishModalTCGEdit();
    } else if (event.key === 'Enter') {
        event.preventDefault();
        // Enter 直接選擇第一個結果
        const firstOption = document.querySelector('.tcg-modal-option');
        if (firstOption) {
            firstOption.click();
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function handleModalTCGSearchInput(event) {
    const keyword = event.target.value;
    searchModalTCGOptions(keyword);
}

function selectModalTCG(tcgNumber) {
    if (!currentModalTCGEditor) return;
    
    // 單選模式：只選擇一個 TCG
    currentModalTCGEditor.currentTCGs = [tcgNumber];
    
    // 完成編輯
    finishModalTCGEdit();
}

function clearModalTCG() {
    if (!currentModalTCGEditor) return;
    
    // 清空選擇
    currentModalTCGEditor.currentTCGs = [];
    
    // 完成編輯
    finishModalTCGEdit();
}

function clearModalTCGDirect(event) {
    event.preventDefault(); // 阻止右鍵選單
    event.stopPropagation(); // 阻止冒泡
    
    // 清空新的 TCG 輸入框
    const modalTCGInput = document.getElementById('modalTCGInput');
    const tcgInput = document.getElementById('tcg');
    
    if (modalTCGInput) {
        modalTCGInput.value = '';
    }
    if (tcgInput) {
        tcgInput.value = '';
    }
    
    // 隱藏下拉選單
    hideTCGDropdown();
    checkFormChanges();
}

// 新的 type-to-search 支援函數
function handleTCGSearch(input) {
    const keyword = input.value.trim();
    const dropdown = document.getElementById('modalTCGDropdown');
    
    if (!dropdown) return;
    
    if (keyword.length < 1) {
        // 顯示熱門 TCG
        showPopularTCG();
        return;
    }
    
    // 搜尋 TCG
    const results = searchTCGFromCache(keyword, 10);
    updateTCGDropdown(results);
    showTCGDropdown();
}

function showTCGDropdown() {
    const dropdown = document.getElementById('modalTCGDropdown');
    if (!dropdown) return;
    
    dropdown.style.display = 'block';
    
    // 如果沒有內容，顯示熱門 TCG
    if (dropdown.innerHTML.trim() === '') {
        showPopularTCG();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function hideTCGDropdown() {
    // 延遲隱藏，允許點擊選項
    setTimeout(() => {
        const dropdown = document.getElementById('modalTCGDropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }, 150);
}

function showPopularTCG() {
    const results = searchTCGFromCache('', 10); // 取前 10 個
    updateTCGDropdown(results);
}

function updateTCGDropdown(results) {
    const dropdown = document.getElementById('modalTCGDropdown');
    if (!dropdown) return;
    
    if (results.length === 0) {
        dropdown.innerHTML = '<div class="p-2 text-muted">找不到匹配的 TCG</div>';
        return;
    }
    
    const html = results.map(tcg => `
        <div class="dropdown-item-custom p-2 border-bottom" 
             onclick="selectTCG('${tcg.tcg_number}', '${tcg.title || ''}')" 
             style="cursor: pointer; transition: background-color 0.2s;"
             onmouseover="this.style.backgroundColor='#f8f9fa'"
             onmouseout="this.style.backgroundColor='white'">
            <div class="fw-bold">${tcg.tcg_number}</div>
        </div>
    `).join('');
    
    dropdown.innerHTML = html;
}

function selectTCG(tcgNumber, title) {
    const modalTCGInput = document.getElementById('modalTCGInput');
    const tcgInput = document.getElementById('tcg');
    
    if (modalTCGInput) {
        modalTCGInput.value = tcgNumber;
    }
    if (tcgInput) {
        tcgInput.value = tcgNumber;
    }
    
    hideTCGDropdown();
    checkFormChanges();
}

// 計算動態高度
function calculateDynamicHeights() {
    const modal = document.getElementById('testCaseModal');
    const modalContent = modal.querySelector('.modal-content');
    const fixedSection = modal.querySelector('.fixed-section');
    const fixedButtons = modal.querySelector('.fixed-buttons');
    const scrollableContent = modal.querySelector('.scrollable-content');
    
    // 取得視窗高度
    const viewportHeight = window.innerHeight;
    
    // 設定模態框高度為視窗高度的 90%
    const modalHeight = Math.floor(viewportHeight * 0.9);
    const modalDialog = modal.querySelector('.modal-dialog');
    modalDialog.style.height = modalHeight + 'px';
    modalDialog.style.maxHeight = modalHeight + 'px';
    
    // 等待DOM更新後計算
    setTimeout(() => {
        // 計算固定區域高度
        const modalHeader = modal.querySelector('.modal-header');
        const headerHeight = modalHeader ? modalHeader.offsetHeight : 0;
        const fixedSectionHeight = fixedSection ? fixedSection.offsetHeight : 0;
        const fixedButtonsHeight = fixedButtons ? fixedButtons.offsetHeight : 0;
        
        // 計算可滾動內容區域的可用高度
        const availableHeight = modalHeight - headerHeight - fixedSectionHeight - fixedButtonsHeight - 2; // 2px for borders
        
        if (scrollableContent) {
            scrollableContent.style.height = availableHeight + 'px';
            scrollableContent.style.maxHeight = availableHeight + 'px';
        }
        
        // 根據可用空間決定是否需要滾動
        if (scrollableContent) {
            const contentHeight = scrollableContent.scrollHeight;
            if (contentHeight <= availableHeight) {
                // 內容夠小，不需要滾動
                scrollableContent.style.overflowY = 'hidden';
            } else {
                // 內容太大，需要滾動
                scrollableContent.style.overflowY = 'auto';
            }
        }
    }, 100);
}

// 監聽視窗大小變化
window.addEventListener('resize', function() {
    const modal = document.getElementById('testCaseModal');
    if (modal && modal.classList.contains('show')) {
        calculateDynamicHeights();
    }
    // 視窗尺寸改變時，調整列表高度
    adjustTestCasesScrollHeight();
});

// 更新導航按鈕狀態
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevTestCaseBtn');
    const nextBtn = document.getElementById('nextTestCaseBtn');
    
    if (currentTestCaseIndex === -1 || filteredTestCases.length <= 1) {
        // 新增模式或只有一筆資料時，隱藏導航按鈕
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        
        // 第一筆時，上一隻按鈕反灰
        if (currentTestCaseIndex === 0) {
            prevBtn.disabled = true;
            prevBtn.classList.add('disabled');
        } else {
            prevBtn.disabled = false;
            prevBtn.classList.remove('disabled');
        }
        
        // 最後一筆時，下一隻按鈕反灰
        if (currentTestCaseIndex === filteredTestCases.length - 1) {
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
        } else {
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 顯示上一隻測試案例
function showPrevTestCase() {
    if (currentTestCaseIndex > 0) {
        const prevTestCase = filteredTestCases[currentTestCaseIndex - 1];
        showTestCaseModal(prevTestCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 只讓 Test Case 列表區域可滾動：依據可視高度調整列表容器高度
function adjustTestCasesScrollHeight() {
    try {
        const scrollBox = document.getElementById('testCasesScroll');
        if (!scrollBox) return;
        const nav = document.getElementById('testCasesPagination');
        const ul = document.getElementById('pagination');
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const rect = scrollBox.getBoundingClientRect();
        const top = rect.top; // 距離視窗頂部
        const paginationHeight = (nav ? nav.getBoundingClientRect().height : (ul ? ul.getBoundingClientRect().height : 0));
        const gap = 16; // 與下方的間距緩衝
        let available = viewportHeight - top - paginationHeight - gap;
        if (available < 200) available = 200; // 設置最小高度
        scrollBox.style.maxHeight = available + 'px';
        scrollBox.style.height = available + 'px';
        scrollBox.style.overflowY = 'auto';
        // 避免 sticky 分頁覆蓋列表最後一行，預留底部內距
        scrollBox.style.paddingBottom = (paginationHeight + gap) + 'px';
    } catch (e) {
        console.warn('adjustTestCasesScrollHeight failed:', e);
    }
}

// 顯示下一隻測試案例
function showNextTestCase() {
    if (currentTestCaseIndex < filteredTestCases.length - 1) {
        const nextTestCase = filteredTestCases[currentTestCaseIndex + 1];
        showTestCaseModal(nextTestCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}
</script>
{% endblock %}
