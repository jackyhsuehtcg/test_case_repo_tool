{% extends "base.html" %}

{% block title %}測試案例管理 - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script>
// Configure marked to treat single newlines as <br> so previews show line breaks
if (window.marked && typeof window.marked.setOptions === 'function') {
    window.marked.setOptions({
        gfm: true,
        breaks: true
    });
}
</script>

<!-- 快速編輯樣式 -->
<style>
/* 限定本頁：關閉整頁滾動，只讓列表區域滾動 */
html, body { height: 100%; overflow: hidden; }
#testCasesPage { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

.hover-editable {
    cursor: pointer;
    transition: background-color 0.2s;
}

.hover-editable:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.hover-edit-btn {
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    min-width: 28px;
    min-height: 28px;
    padding: 2px 4px;
}

.hover-editable:hover .hover-edit-btn {
    opacity: 1 !important;
    pointer-events: auto;
}

.hover-editable .hover-edit-btn {
    display: block !important;
}

.quick-edit-input {
    border: 1px solid var(--tr-primary) !important;
    border-radius: 4px !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    height: auto !important;
    min-height: 1.5rem !important;
    margin: 0 !important;
    box-sizing: border-box !important;
}

/* 確保表格行高度一致 */
#testCasesTable tbody tr {
    height: 2.5rem;
}

#testCasesTable tbody td {
    vertical-align: middle;
    height: 2.5rem;
}

/* Markdown 編輯器樣式 */
.markdown-global-toolbar {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0.5rem;
    background-color: var(--tr-bg-sidebar);
    border: 1px solid var(--tr-border-light);
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.markdown-field-container {
    margin-top: 0.5rem;
}

.markdown-field-container textarea {
    border-radius: 0.375rem;
}

.markdown-field-container .card {
    border-radius: 0.375rem;
    height: 100%;
}

.markdown-preview {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}

.markdown-preview h1,
.markdown-preview h2,
.markdown-preview h3 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.markdown-preview h1 { font-size: 1.5rem; }
.markdown-preview h2 { font-size: 1.25rem; }
.markdown-preview h3 { font-size: 1.1rem; }

.markdown-preview ul,
.markdown-preview ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.markdown-preview code {
    background-color: var(--tr-bg-sidebar);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

.markdown-preview a {
    color: var(--tr-primary);
    text-decoration: none;
}

.markdown-preview a:hover {
    text-decoration: underline;
}

/* 附件樣式 */
.attachment-item {
    background-color: var(--tr-bg-sidebar);
    transition: background-color 0.2s;
}

.attachment-item:hover {
    background-color: var(--tr-border-light);
}

/* (reverted) removed modal TCG custom styles */

/* Markdown 預覽區域：移除首尾多餘邊距，避免卡片內留下額外留白 */

/* 卡片與編輯容器對齊：確保卡片本身不產生額外外距 */
/* (revert) remove special markdown preview margin normalization */


/* 在顯示前先隱藏 modal 內容，避免進場時可見的滾動回頂彈跳感 */
.modal-preparing .modal-body {
    visibility: hidden;
}

/* 禁用任何平滑滾動，確保立即置頂 */
.scrollable-content {
    scroll-behavior: auto;
}

/* 精準收斂搜尋卡片的內邊距，避免上方留白過多 */
#searchFilterCard .card-body {
    padding-top: 0.25rem;   /* 再更緊：由 0.5rem 降為 0.25rem */
    padding-bottom: 0.5rem; /* 底部同步略收斂 */
}
#searchFilterCard .form-label {
    margin-bottom: 0.125rem; /* 再更緊：由 0.25rem 降為 0.125rem */
}

/* 同層級其他卡片一併收斂頂部空白 */
#batchToolbar .card-body,
#testCasesCard .card-body {
    padding-top: 0.5rem;
}

/* 讓列表容器可滾動（高度由 JS 計算設定）*/
#testCasesScroll {
    overflow-y: auto;
}

/* 讓標題列固定在列表容器頂部，不跟著內容滾動，並恢復底色與陰影層次 */
#testCasesScroll thead th {
    position: sticky;
    top: 0;
    z-index: 20; /* 確保蓋過內容列 */
    background-color: #f8f9fa; /* 與卡片/表頭風格一致 */
    border-bottom: 1px solid #dee2e6; /* 清楚的下邊界 */
}
#testCasesScroll thead tr {
    box-shadow: 0 2px 3px rgba(0,0,0,0.05); /* 輕微陰影強化層次 */
}

/* 專門收斂 #searchInput 的父層（col-）之上緣空白：縮小該 row 的垂直 gutter */
#searchFilterCard .card-body .row.g-3 {
    --bs-gutter-y: 0.125rem; /* 再更緊：由 0.25rem 降為 0.125rem */
}


/* 分頁列外觀（定位由 .fixed-pagination-bar 控制） */
#testCasesPagination {
    background-color: transparent;
    border-top: none;
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
}

</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testCase.management">測試案例管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testCase.subtitle">管理測試案例，支援搜尋、過濾、編輯和批次操作</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" id="addTestCaseBtn">
        <i class="fas fa-plus me-2"></i><span data-i18n="testCase.createTestCase">新增測試案例</span>
    </button>
    <button type="button" class="btn btn-outline-primary" id="openBulkCreateBtn">
        <i class="fas fa-layer-group me-2"></i><span data-i18n="testCase.bulk.bulkCreateMode">大量新增模式</span>
    </button>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
    <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid" id="testCasesPage">

    <!-- 載入進度條 -->
    <div id="loadingProgress" class="card mb-2" style="display: none;">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i class="fas fa-spinner fa-spin me-2"></i><span data-i18n="common.loading">載入中...</span>
            </h5>
            
            <!-- Test Case 載入進度 -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" data-i18n="testCase.loadingTestCases">載入測試案例</small>
                    <small class="text-muted" id="testCaseProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" id="testCaseProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- TCG 快取載入進度 -->
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" data-i18n="testCase.loadingTCG">載入 TCG 單號快取</small>
                    <small class="text-muted" id="tcgCacheProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="tcgCacheProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋與篩選區 -->
    <div class="card mb-3" id="searchFilterCard" style="display: none;">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3 col-lg-2">
                    <label for="testCaseNumberSearch" class="form-label" data-i18n="testCase.testCaseNumber">Test Case Number</label>
                    <input type="text" class="form-control" id="testCaseNumberSearch" data-i18n-placeholder="testCase.testCaseNumberPlaceholder">
                </div>
                <div class="col-md-4 col-lg-3">
                    <label for="searchInput" class="form-label" data-i18n="common.search">關鍵字搜尋</label>
                    <input type="text" class="form-control" id="searchInput" data-i18n-placeholder="testCase.searchPlaceholder">
                </div>
                <div class="col-md-2 col-lg-1">
                    <label for="priorityFilter" class="form-label" data-i18n="testCase.priority">優先級</label>
                    <select class="form-select" id="priorityFilter">
                        <option value="" data-i18n="common.all">全部</option>
                        <option value="High" data-i18n="priority.high">High</option>
                        <option value="Medium" data-i18n="priority.medium">Medium</option>
                        <option value="Low" data-i18n="priority.low">Low</option>
                    </select>
                </div>
                <div class="col-md-3 col-lg-6 d-flex align-items-end justify-content-between flex-wrap">
                    <div class="d-flex align-items-center mb-2 mb-lg-0">
                        <button type="button" class="btn btn-primary me-2" id="applyFiltersBtn">
                            <i class="fas fa-filter me-2"></i><span data-i18n="common.apply">套用篩選</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearFiltersBtn">
                            <i class="fas fa-times me-2"></i><span data-i18n="common.clear">清除</span>
                        </button>
                    </div>
                    <!-- 批次操作工具列（與套用篩選同一排、靠右顯示） -->
                    <div id="batchInlineToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0">
                        <span class="text-muted" id="selectedCountWrapper" data-i18n="testCase.selectedItems" data-i18n-params='{"count":0}'>
                            已選取 0 個項目
                        </span>
                        <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn">
                            <i class="fas fa-trash me-2"></i><span data-i18n="testCase.batchDelete">批次刪除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 測試案例表格 -->
    <div class="card" id="testCasesCard">
        <div class="card-body">
            <div class="table-responsive" id="testCasesScroll">
                <table class="table table-hover table-sm" id="testCasesTable">
                    <thead>
                        <tr style="height: 32px !important; line-height: 1.2;">
                            <th width="30" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                            </th>
                            <th width="220" style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="testCase.testCaseNumber">Test Case Number</th>
                            <th style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="common.title">標題</th>
                            <th width="120" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;">TCG</th>
                            <th width="80" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="testCase.priority">優先級</th>
                            <th width="100" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="common.createDate">建立日期</th>
                            <th width="100" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="common.updateDate">更新日期</th>
                            <th width="100" class="text-center" style="padding: 4px 8px !important; vertical-align: middle;" data-i18n="common.actions">操作</th>
                        </tr>
                    </thead>
                    <tbody id="testCasesTableBody">
                        <!-- 將由 JavaScript 動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分頁控制 -->
    <nav aria-label="測試案例分頁" class="mt-3 fixed-pagination-bar" id="testCasesPagination">
        <ul class="pagination justify-content-center" id="pagination">
            <!-- 將由 JavaScript 動態載入 -->
        </ul>
    </nav>
</div>

<!-- 測試案例詳情/編輯 Modal -->
<div class="modal fade" id="testCaseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl" style="height: 90vh; max-height: 90vh;">
        <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <span id="testCaseModalTitle" data-i18n="testCase.createTestCase">新增測試案例</span>
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevTestCaseBtn" data-i18n-title="testCase.previousTestCase">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextTestCaseBtn" data-i18n-title="testCase.nextTestCase">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0; display: flex; flex-direction: column;">
                <form id="testCaseForm" style="height: 100%; display: flex; flex-direction: column;">
                    <input type="hidden" id="testCaseId" name="id">
                    <input type="hidden" id="tcg" name="tcg">
                    
                    <!-- 固定區域：基本資訊 -->
                    <div class="fixed-section" style="flex-shrink: 0; padding: 1rem; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label for="testCaseNumber" class="form-label">Test Case Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseNumber" name="test_case_number" required>
                            </div>
                            <div class="col-md-6">
                                <label for="title" class="form-label"><span data-i18n="form.testCaseTitle">測試案例標題</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-2">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="tcg" class="form-label">TCG</label>
                                <div class="tcg-search-container" style="position: relative;">
                                    <input type="text" 
                                           id="modalTCGInput" 
                                           class="form-control" 
                                           data-i18n-placeholder="testCase.tcgPlaceholder"
                                           autocomplete="off"
                                           onkeyup="handleTCGSearch(this)"
                                           onfocus="showTCGDropdown()"
                                           onblur="hideTCGDropdown()"
                                           oncontextmenu="clearModalTCGDirect(event)">
                                    <div id="modalTCGDropdown" 
                                         style="position: absolute; top: 100%; left: 0; right: 0; z-index: 9999; max-height: 200px; overflow-y: auto; display: none; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <!-- 搜尋結果會動態載入到這裡 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 可滾動內容區域 -->
                    <div class="scrollable-content" style="flex: 1; overflow-y: auto; padding: 1rem;">
                        
                        <!-- 測試內容三個區域 -->
                        
                        <!-- 測試內容三個區域 - 統一網格佈局 -->
                        <div class="row">
                            <!-- Precondition 區域 -->
                            <div class="col-12 mb-4">
                                <div class="mb-3">
                                    <label for="precondition" class="form-label mb-0">
                                        <i class="fas fa-list-ul me-2"></i>Precondition
                                    </label>
                                </div>
                                <div class="markdown-field-container" id="precondition_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="precondition" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="precondition" name="precondition" class="markdown-textarea" rows="4" 
                                                        data-i18n-placeholder="testCase.preconditionsPlaceholder" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="precondition" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 測試步驟區域 -->
                            <div class="col-12 mb-4">
                                <label for="test_steps" class="form-label">
                                    <i class="fas fa-list-ol me-2"></i><span data-i18n="form.testSteps">測試步驟</span>
                                </label>
                                <div class="markdown-field-container" id="test_steps_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 250px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="test_steps" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="test_steps" name="test_steps" class="markdown-textarea" rows="6" 
                                                        data-i18n-placeholder="testCase.stepsPlaceholder" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 250px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="test_steps" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 預期結果區域 -->
                            <div class="col-12 mb-4">
                                <label for="expected_result" class="form-label">
                                    <i class="fas fa-check-circle me-2"></i><span data-i18n="form.expectedResults">預期結果</span>
                                </label>
                                <div class="markdown-field-container" id="expected_result_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="expected_result" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="expected_result" name="expected_result" class="markdown-textarea" rows="4" 
                                                        data-i18n-placeholder="testCase.expectedResultsPlaceholder" 
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="expected_result" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 附件區域 -->
                        <div class="mb-3">
                            <label for="attachmentUpload" class="form-label">
                                <i class="fas fa-paperclip me-2"></i><span data-i18n="form.attachments">附件</span>
                            </label>
                            <input type="file" class="form-control" id="attachmentUpload" multiple 
                                   accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <div class="form-text" data-i18n="form.attachmentHint">支援圖片、PDF、Office 文件，單檔最大 10MB</div>
                            <div id="attachmentsList" class="mt-2">
                                <!-- 附件列表將由 JavaScript 動態載入 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 固定按鈕區域 -->
                    <div class="fixed-buttons" style="flex-shrink: 0; padding: 1rem; border-top: 1px solid #dee2e6; background: #ffffff;">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- 模式切換按鈕 -->
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-secondary active" id="previewModeBtn">
                                    <i class="fas fa-eye me-1"></i><span data-i18n="form.browse">瀏覽</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="splitModeBtn">
                                    <i class="fas fa-edit me-1"></i><span data-i18n="form.editMode">編輯</span>
                                </button>
                            </div>
                            <!-- 操作按鈕 -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                                <button type="button" class="btn btn-success" id="saveAndAddNextBtn" disabled style="display: none;">
                                    <i class="fas fa-plus me-2"></i><span data-i18n="form.saveAndNext">儲存並新增下一筆</span>
                                </button>
                                <button type="button" class="btn btn-primary" id="saveTestCaseBtn" disabled>
                                    <i class="fas fa-save me-2"></i><span data-i18n="common.save">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i><span data-i18n="form.deleteConfirmation">確認刪除</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>警告：</strong><span data-i18n="form.deleteWarning">刪除操作無法復原，請謹慎確認</span>
                </div>
                <div id="deleteList">
                    <!-- 要刪除的項目列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">確認刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 大量新增 Test Case Modal -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-layer-group me-2"></i>
          <span data-i18n="testCase.bulk.bulkCreateMode">大量新增模式</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- 前綴單號清單 -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <label class="form-label mb-0"><span data-i18n="testCase.bulk.prefixList">前綴單號清單</span></label>
          <button type="button" class="btn btn-outline-primary btn-sm" id="addPrefixBtn">
            <i class="fas fa-plus me-1"></i><span data-i18n="testCase.bulk.addPrefix">新增前綴</span>
          </button>
        </div>
        <div id="prefixContainer" class="mb-2"></div>
        <div class="form-text" data-i18n="testCase.bulk.structureHint">每個前綴可新增多個中間分類與末尾單號範圍。最終單號格式：前綴.中間.末尾（末尾以 10 遞增）。</div>

        <hr>
        <div id="bulkValidation" style="display:none"></div>

        <div id="bulkPreview" class="small text-muted">
          <i class="fas fa-eye me-1"></i>
          <span data-i18n="testCase.bulk.generatePreview">預覽將產生的單號</span>：
          <span id="bulkPreviewList"></span>
          <div class="mt-1"><span data-i18n="testCase.bulk.totalToCreate">預計建立筆數</span>：<span id="bulkTotalCount">0</span></div>
        </div>

        <div id="bulkProgress" style="display:none" class="mt-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted" data-i18n="testCase.bulk.creating">建立中...</small>
            <small class="text-muted" id="bulkProgressText">0/0</small>
          </div>
          <div class="progress" style="height:6px;">
            <div class="progress-bar bg-primary" id="bulkProgressBar" style="width:0%"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
        <button type="button" class="btn btn-primary" id="startBulkCreateBtn">
          <i class="fas fa-check me-2"></i><span data-i18n="testCase.bulk.startCreate">開始建立</span>
        </button>
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
// 與執行頁共用的 Test Case 詳細快取設定（localStorage）
const EXEC_TC_CACHE_PREFIX = 'tr_exec_tc_cache_v1';
const EXEC_TC_CACHE_TTL_MS = 60 * 60 * 1000; // 1 小時

function getExecCacheKey(testCaseNumber) {
    try {
        const team = AppUtils.getCurrentTeam();
        const teamId = team && team.id ? team.id : 'unknown';
        return `${EXEC_TC_CACHE_PREFIX}:${teamId}:${testCaseNumber}`;
    } catch (_) {
        return `${EXEC_TC_CACHE_PREFIX}:unknown:${testCaseNumber}`;
    }
}

function setExecCachedTestCase(testCaseNumber, data) {
    try {
        const key = getExecCacheKey(testCaseNumber);
        const payload = { ts: Date.now(), data };
        localStorage.setItem(key, JSON.stringify(payload));
    } catch (_) {}
}

function removeExecCachedTestCase(testCaseNumber) {
    try {
        const key = getExecCacheKey(testCaseNumber);
        localStorage.removeItem(key);
    } catch (_) {}
}

let testCases = [];
let filteredTestCases = [];
let selectedTestCases = new Set();
let currentPage = 1;
let currentTestCaseIndex = -1; // 當前檢視測試案例在 filteredTestCases 中的索引
let pageSize = 50;
let markdownEditor = null;

// TCG 快取相關變數
let tcgCache = null;
let tcgCacheTimestamp = null;
const TCG_CACHE_KEY = 'tcg_cache';
const TCG_CACHE_TIMESTAMP_KEY = 'tcg_cache_timestamp';
const TCG_CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24小時過期

document.addEventListener('DOMContentLoaded', async function() {
    try {
        // 先處理 URL 的 team_id，確保後續載入不會因為未選擇團隊而中止
        const urlParams = new URLSearchParams(window.location.search);
        const teamIdParam = urlParams.get('team_id');
        if (teamIdParam && (!AppUtils.getCurrentTeam() || !AppUtils.getCurrentTeam().id)) {
            const teamId = parseInt(teamIdParam);
            if (!isNaN(teamId)) {
                AppUtils.setCurrentTeam({ id: teamId, name: 'From Test Run' });
            }
        }
    } catch (_) {}

    const urlParams = new URLSearchParams(window.location.search);
    const minimal = urlParams.get('minimal') === '1' || urlParams.get('editor') === '1';
    const tcNumber = urlParams.get('tc') || urlParams.get('test_case_number');
    const mode = urlParams.get('mode') || 'preview';

    if (minimal && tcNumber) {
        // 最小模式：不載入列表，直接開啟指定測試案例
        try {
            // 綁定事件（包含儲存按鈕）
            bindEvents();
            initializeMarkdownEditor();
            // 隱藏列表與搜尋區塊
            const page = document.getElementById('testCasesPage');
            if (page) {
                const searchCard = document.getElementById('searchFilterCard');
                const tableCard = document.querySelector('#testCasesTable')?.closest('.card');
                if (searchCard) searchCard.style.display = 'none';
                if (tableCard) tableCard.style.display = 'none';
            }
            // 套用最小模式樣式：隱藏頁首/頁尾與背景容器
            try {
                document.body.classList.add('minimal-mode');
                if (!document.getElementById('minimal-mode-style')) {
                    const style = document.createElement('style');
                    style.id = 'minimal-mode-style';
                    style.textContent = `
                        .minimal-mode .app-header, .minimal-mode .app-footer { display: none !important; }
                        .minimal-mode #testCasesPage, .minimal-mode #searchFilterCard, .minimal-mode #loadingProgress, .minimal-mode #testCasesPagination { display: none !important; }
                        body.minimal-mode { overflow: hidden; }
                    `;
                    document.head.appendChild(style);
                }
            } catch (_) {}

            // 直接從 API 抓此測試案例
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) throw new Error('請先選擇團隊');
            const resp = await fetch(`/api/teams/${currentTeam.id}/testcases/?search=${encodeURIComponent(tcNumber)}&limit=1`);
            if (!resp.ok) throw new Error('載入測試案例失敗');
            const arr = await resp.json();
            const target = Array.isArray(arr) ? arr.find(tc => tc.test_case_number === tcNumber) : null;
            if (target) {
                // 設定最小模式旗標，供顯示 Modal 時使用無背板
                window.__MINIMAL_MODE__ = true;
                showTestCaseModal(target);
                if (mode === 'edit' || mode === 'split') {
                    // 切換為可編輯模式（若可行）
                    try { setEditorMode('split'); } catch (_) {}
                }
            } else {
                showError('找不到指定的測試案例');
            }
        } catch (e) {
            console.error('最小模式開啟測試案例失敗:', e);
            // 回退到完整載入
            await initTestCaseManagement();
            bindEvents();
            initializeMarkdownEditor();
        }
    } else {
        // 原本完整流程
        await initTestCaseManagement();
        bindEvents();
        initializeMarkdownEditor();
        // 初始化列表高度（等待初始排版完成）
        setTimeout(adjustTestCasesScrollHeight, 0);
        try {
            if (tcNumber) {
                const openAfterLoad = async () => {
                    if (!Array.isArray(testCases) || testCases.length === 0) {
                        await loadTestCases(false);
                    }
                    const target = testCases.find(tc => (tc.test_case_number === tcNumber) || (tc.record_id === tcNumber));
                    if (target) {
                        showTestCaseModal(target);
                    }
                };
                setTimeout(openAfterLoad, 0);
            }
        } catch (_) {}
    }
});

// TCG 快取管理函數
function loadTCGCacheFromStorage() {
    try {
        const cached = localStorage.getItem(TCG_CACHE_KEY);
        const timestamp = localStorage.getItem(TCG_CACHE_TIMESTAMP_KEY);
        
        if (cached && timestamp) {
            const cacheAge = Date.now() - parseInt(timestamp);
            if (cacheAge < TCG_CACHE_EXPIRY) {
                tcgCache = JSON.parse(cached);
                tcgCacheTimestamp = parseInt(timestamp);
                console.log(`載入 TCG 快取: ${tcgCache.length} 筆記錄`);
                return true;
            }
        }
    } catch (error) {
        console.error('載入 TCG 快取失敗:', error);
    }
    return false;
}

function saveTCGCacheToStorage() {
    try {
        localStorage.setItem(TCG_CACHE_KEY, JSON.stringify(tcgCache));
        localStorage.setItem(TCG_CACHE_TIMESTAMP_KEY, tcgCacheTimestamp.toString());
    } catch (error) {
        console.error('儲存 TCG 快取失敗:', error);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function clearTCGCache() {
    tcgCache = null;
    tcgCacheTimestamp = null;
    localStorage.removeItem(TCG_CACHE_KEY);
    localStorage.removeItem(TCG_CACHE_TIMESTAMP_KEY);
}

function shouldUpdateTCGCache() {
    // 檢查是否需要更新快取
    // 1. 沒有快取
    if (!tcgCache) return true;
    
    // 2. 快取過期
    if (tcgCacheTimestamp && (Date.now() - tcgCacheTimestamp) > TCG_CACHE_EXPIRY) {
        return true;
    }
    
    // 3. 強制重新載入 (檢查 URL 參數或其他條件)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('refresh') === 'true') return true;
    
    // 4. 頁面完全重新載入 (performance.navigation.type === 1 for reload)
    if (performance.navigation && performance.navigation.type === 1) return true;
    
    return false;
}

async function loadTCGCache(updateProgress = null) {
    try {
        if (updateProgress) updateProgress(0, '開始載入 TCG 單號...');
        
        if (updateProgress) updateProgress(30, '從本地資料庫載入...');
        
        // 一次性從本地 SQLite 載入所有資料（極快）
        const response = await fetch('/api/tcg/search?keyword=&limit=50000');
        if (!response.ok) {
            throw new Error(`載入 TCG 失敗: ${response.status} ${response.statusText}`);
        }
        
        if (updateProgress) updateProgress(70, '解析 TCG 資料...');
        
        const data = await response.json();
        tcgCache = data.results || [];
        tcgCacheTimestamp = Date.now();
        
        if (updateProgress) updateProgress(90, '儲存快取...');
        saveTCGCacheToStorage();
        
        if (updateProgress) {
            const tcgCompletedMsg = window.i18n ? window.i18n.t('loading.completedWithCount', {count: tcgCache.length}) : `載入完成 (${tcgCache.length} 筆)`;
            updateProgress(100, tcgCompletedMsg);
        }
        
        console.log(`TCG 快取更新完成: ${tcgCache.length} 筆記錄`);
        return true;
        
    } catch (error) {
        console.error('載入 TCG 快取失敗:', error);
        if (updateProgress) {
            updateProgress(0, '載入失敗: ' + error.message);
        }
        return false;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function searchTCGFromCache(keyword, limit = 20) {
    if (!tcgCache) return [];
    
    if (!keyword || keyword.trim() === '') {
        return tcgCache.slice(0, limit);
    }
    
    const lowerKeyword = keyword.toLowerCase();
    return tcgCache.filter(tcg => 
        tcg.tcg_number.toLowerCase().includes(lowerKeyword) ||
        tcg.title.toLowerCase().includes(lowerKeyword)
    ).slice(0, limit);
}

async function initTestCaseManagement() {
    // 顯示進度條
    showLoadingProgress();
    
    try {
        // 載入 TCG 快取 (如果需要)
        const hasCachedTCG = loadTCGCacheFromStorage();
        if (!hasCachedTCG || shouldUpdateTCGCache()) {
            await loadTCGCache((progress, message) => {
                updateTCGCacheProgress(progress, message);
            });
        } else {
            updateTCGCacheProgress(100, `使用快取 (${tcgCache.length} 筆)`);
        }
        
        // 載入測試案例
        await loadTestCases(false, (progress, message) => {
            updateTestCaseProgress(progress, message);
        });
        
    } catch (error) {
        console.error('初始化失敗:', error);
    } finally {
        // 隱藏進度條
        hideLoadingProgress();
        // 初始化篩選狀態
        updateFilterStatus();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 進度條控制函數
function showLoadingProgress() {
    const progressDiv = document.getElementById('loadingProgress');
    if (progressDiv) {
        progressDiv.style.display = 'block';
    }
    
    // 隱藏搜尋與篩選區和表格
    const searchCard = document.getElementById('searchFilterCard');
    const tableCard = document.querySelector('#testCasesTable').closest('.card');
    if (searchCard) searchCard.style.display = 'none';
    if (tableCard) tableCard.style.display = 'none';
}

function hideLoadingProgress() {
    const progressDiv = document.getElementById('loadingProgress');
    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
    
    // 顯示搜尋與篩選區和表格
    const searchCard = document.getElementById('searchFilterCard');
    const tableCard = document.querySelector('#testCasesTable').closest('.card');
    if (searchCard) searchCard.style.display = 'block';
    if (tableCard) tableCard.style.display = 'block';
    // 顯示後調整列表高度
    adjustTestCasesScrollHeight();
}


function updateTestCaseProgress(progress, message = '') {
    const progressBar = document.getElementById('testCaseProgressBar');
    const progressText = document.getElementById('testCaseProgress');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = `${Math.round(progress)}%${message ? ' - ' + message : ''}`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function updateTCGCacheProgress(progress, message = '') {
    const progressBar = document.getElementById('tcgCacheProgressBar');
    const progressText = document.getElementById('tcgCacheProgress');
    
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    if (progressText) {
        progressText.textContent = `${Math.round(progress)}%${message ? ' - ' + message : ''}`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}


async function loadTestCases(showLoadingBlock = true, updateProgress = null) {
    try {
        if (updateProgress) updateProgress(0, '開始載入測試案例...');
        
        if (showLoadingBlock) {
            showLoadingState();
        }
        
        // 獲取當前選擇的團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            throw new Error('請先選擇團隊');
        }
        
        const connectingMsg = window.i18n ? window.i18n.t('loading.connecting') : '連接伺服器...';
        if (updateProgress) updateProgress(30, connectingMsg);
        
        const response = await fetch(`/api/teams/${currentTeam.id}/testcases/`);
        if (!response.ok) {
            throw new Error(`載入測試案例失敗: ${response.status} ${response.statusText}`);
        }
        
        if (updateProgress) updateProgress(60, '解析資料...');
        
        testCases = await response.json();
        
        if (updateProgress) updateProgress(80, '處理資料...');
        
        // 預設按 Test Case Number 升冪排序
        testCases.sort((a, b) => {
            const aNumber = a.test_case_number || '';
            const bNumber = b.test_case_number || '';
            return aNumber.localeCompare(bNumber);
        });
        
        filteredTestCases = [...testCases];
        
        if (updateProgress) updateProgress(95, '渲染表格...');
        
        renderTestCasesTable();
        updatePagination();
        if (showLoadingBlock) {
            hideLoadingState();
        }
        
        const completedMsg = window.i18n ? window.i18n.t('loading.completedWithCount', {count: testCases.length}) : `載入完成 (${testCases.length} 筆)`;
        if (updateProgress) updateProgress(100, completedMsg);
        
    } catch (error) {
        console.error('載入測試案例失敗:', error);
        const message = window.i18n ? window.i18n.t('errors.loadTestCasesFailed') : '載入測試案例失敗';
        showError(message + '：' + error.message);
        if (showLoadingBlock) {
            hideLoadingState();
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function refreshTestCases() {
    const refreshBtn = document.getElementById('refreshBtn');
    const originalHTML = refreshBtn.innerHTML;
    
    // 檢查是否有搜尋條件
    const hasFilters = hasAnyFilters();
    
    // 顯示載入動畫在按鈕內
    refreshBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>${window.i18n ? window.i18n.t('common.refresh') : '重新載入'}${hasFilters ? (window.i18n ? ' & ' + window.i18n.t('common.filter') : ' & 篩選') : ''}`;
    refreshBtn.disabled = true;
    
    try {
        // 調用 loadTestCases，但不顯示載入區塊
        await loadTestCases(false);
        
        // 重新載入後，自動套用當前的搜尋條件
        if (hasFilters) {
            applyFilters();
            // 提示使用者已保持篩選條件
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloadedWithFilters') : '資料已重新載入，篩選條件已保持');
        } else {
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloaded') : '資料已重新載入');
        }
        
    } finally {
        // 恢復按鈕原始狀態
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 檢查是否有任何篩選條件的輔助函數
function hasAnyFilters() {
    const testCaseNumberSearch = document.getElementById('testCaseNumberSearch').value.trim();
    const search = document.getElementById('searchInput').value.trim();
    const priority = document.getElementById('priorityFilter').value;
    
    return testCaseNumberSearch || search || priority;
}

function renderTestCasesTable() {
    const tbody = document.getElementById('testCasesTableBody');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageTestCases = filteredTestCases.slice(startIndex, endIndex);
    
    if (pageTestCases.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                    <i class="fas fa-search fa-2x text-muted mb-2"></i>
                    <div class="text-muted" data-i18n="errors.noMatchingTestCases">沒有找到符合條件的測試案例</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pageTestCases.map(testCase => `
        <tr>
            <td class="align-middle text-center">
                <input type="checkbox" class="form-check-input test-case-checkbox" 
                       value="${testCase.record_id}" ${selectedTestCases.has(testCase.record_id) ? 'checked' : ''}>
            </td>
            <td class="align-middle position-relative hover-editable" data-field="test_case_number" data-record-id="${testCase.record_id}">
                <div style="padding-right: 45px;">
                    <code class="small">${testCase.test_case_number || testCase.record_id}</code>
                </div>
                <button type="button" class="btn btn-sm btn-edit position-absolute hover-edit-btn" 
                        style="top: 50%; right: 5px; transform: translateY(-50%); z-index: 10;" 
                        onclick="quickEdit('${testCase.record_id}', 'test_case_number')" data-i18n-title="tooltips.quickEdit">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="align-middle position-relative hover-editable" data-field="title" data-record-id="${testCase.record_id}">
                <div class="d-flex align-items-center" style="padding-right: 45px;">
                    <div style="flex-grow: 1; min-width: 0;">
                        <div class="fw-medium text-truncate" title="${testCase.title}">${testCase.title}</div>
                        <div class="small text-muted text-truncate">
                            ${testCase.description ? testCase.description.substring(0, 60) + '...' : ''}
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-edit position-absolute hover-edit-btn" 
                        style="top: 50%; right: 5px; transform: translateY(-50%); z-index: 10;" 
                        onclick="quickEdit('${testCase.record_id}', 'title')" data-i18n-title="tooltips.quickEdit">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
            <td class="align-middle text-center position-relative" data-field="tcg" data-record-id="${testCase.record_id}">
                <div class="tcg-edit-area" onclick="editTCG('${testCase.record_id}')" data-i18n-title="tooltips.clickEditTcg">
                    ${getTCGTags(testCase)}
                </div>
            </td>
            <td class="align-middle text-center">
                <span class="badge ${getPriorityBadgeClass(testCase.priority)}">${getPriorityText(testCase.priority)}</span>
            </td>
            <td class="align-middle text-center">
                <div class="small text-muted text-nowrap">
                    ${formatDate(testCase.created_at, 'date')}
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="small text-muted text-nowrap">
                    ${formatDate(testCase.updated_at, 'date')}
                </div>
            </td>
            <td class="align-middle text-center" style="width: 100px;">
                <div class="test-case-actions d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-sm btn-view" 
                            onclick="viewTestCase('${testCase.record_id}')" data-i18n-title="tooltips.viewEdit">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            onclick="copyTestCase('${testCase.record_id}')" title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('common.copy') : '複製'}">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="deleteTestCase('${testCase.record_id}')" data-i18n-title="tooltips.delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    // 渲染後調整列表可視高度
    adjustTestCasesScrollHeight();
}


function bindEvents() {
    // 新增按鈕
    document.getElementById('addTestCaseBtn').addEventListener('click', () => showTestCaseModal());
    // 監聽大量新增欄位變更以更新預覽
    // 移除舊的前綴/末尾輸入監聽；改由 renderPrefixes 中的 oninput 觸發
    
    // 重新載入按鈕
    document.getElementById('refreshBtn').addEventListener('click', refreshTestCases);
    
    // 搜尋與篩選
    document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
    
    // 搜尋欄位 Enter 鍵支援
    document.getElementById('testCaseNumberSearch').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
    document.getElementById('searchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyFilters();
        }
    });
    
    // 批次操作
    document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) batchDeleteBtn.addEventListener('click', batchDeleteTestCases);
    
    // 上一隻/下一隻測試案例按鈕
    document.getElementById('prevTestCaseBtn').addEventListener('click', showPrevTestCase);
    document.getElementById('nextTestCaseBtn').addEventListener('click', showNextTestCase);
    
    // 監聽表格內的複選框變化
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('test-case-checkbox')) {
            const recordId = e.target.value;
            if (e.target.checked) {
                selectedTestCases.add(recordId);
            } else {
                selectedTestCases.delete(recordId);
            }
            updateBatchToolbar();
        }
    });
    
    // 大量新增模式
    const openBulkBtn = document.getElementById('openBulkCreateBtn');
    if (openBulkBtn) openBulkBtn.addEventListener('click', openBulkCreateModal);
    const addPrefixBtn = document.getElementById('addPrefixBtn');
    if (addPrefixBtn) addPrefixBtn.addEventListener('click', addPrefix);
    const startBulkBtn = document.getElementById('startBulkCreateBtn');
    if (startBulkBtn) startBulkBtn.addEventListener('click', startBulkCreate);
    
    // 儲存按鈕
    document.getElementById('saveTestCaseBtn').addEventListener('click', saveTestCase);
    
    // 儲存並新增下一筆按鈕
    document.getElementById('saveAndAddNextBtn').addEventListener('click', saveAndAddNext);
}

// ===== 大量新增模式（多前綴 / 前綴下多中間 / 末尾範圍） =====
let bulkModalInstance = null;
// 結構：[{ prefix: string, middles: [{ middle: '110', start: 20, end: 60 }] }]
let bulkTree = [];

function openBulkCreateModal() {
    resetBulkState();
    const modalEl = document.getElementById('bulkCreateModal');
    if (!bulkModalInstance) bulkModalInstance = new bootstrap.Modal(modalEl);
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modalEl);
    bulkModalInstance.show();
}

function resetBulkState() {
    bulkTree = [];
    renderPrefixes();
    document.getElementById('bulkPreviewList').textContent = '';
    document.getElementById('bulkTotalCount').textContent = '0';
    hideBulkValidation();
    hideBulkProgress();
}

function addPrefix() { bulkTree.push({ prefix: '', middles: [] }); renderPrefixes(); }

function renderPrefixes() {
    const container = document.getElementById('prefixContainer');
    const optionsAll = (base=10) => Array.from({length: ((990 - base)/10)+1}, (_,i)=>base+i*10)
          .map(v => `<option value="${v}">${pad3(v)}</option>`).join('');
    container.innerHTML = bulkTree.map((p, pi) => {
        const middlesHtml = (p.middles||[]).map((m, mi) => {
            const startVal = m.start || 10;
            const endVal = m.end || startVal;
            const endOptions = Array.from({length: ((990 - startVal)/10)+1}, (_,i)=>startVal+i*10)
                .map(v => `<option value="${v}" ${v===endVal?'selected':''}>${pad3(v)}</option>`).join('');
            return `
              <div class="row g-2 align-items-end mb-2">
                <div class="col-12 col-md-3">
                  <label class="form-label mb-0 small" data-i18n="testCase.bulk.middleCode">中間分類號</label>
                  <input type="text" class="form-control form-control-sm" value="${escapeHtml(m.middle||'')}" maxlength="3" oninput="onMiddleCodeChange(${pi}, ${mi}, this.value)">
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mb-0 small" data-i18n="testCase.bulk.suffixStart">末尾起始</label>
                  <select class="form-select form-select-sm" onchange="onSuffixChange(${pi}, ${mi}, 'start', this.value)">
                    ${optionsAll(10).replace(`value=\"${startVal}\"`, `value=\"${startVal}\" selected`)}
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label mb-0 small" data-i18n="testCase.bulk.suffixEnd">末尾結束</label>
                  <select class="form-select form-select-sm" onchange="onSuffixChange(${pi}, ${mi}, 'end', this.value)">
                    ${endOptions}
                  </select>
                </div>
                <div class="col-12 col-md-3 d-flex gap-2">
                  <button type="button" class="btn btn-outline-danger btn-sm" title="-" onclick="removeMiddle(${pi}, ${mi})"><i class="fas fa-times"></i></button>
                </div>
              </div>
            `;
        }).join('');
        return `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex gap-2 mb-2">
                <div class="flex-grow-1">
                  <label class="form-label mb-1"><span data-i18n="testCase.bulk.prefix">前綴單號</span></label>
                  <input type="text" class="form-control" value="${escapeHtml(p.prefix||'')}" placeholder="e.g. TCG-93178" oninput="onPrefixChange(${pi}, this.value)">
                </div>
                <div class="align-self-end">
                  <button type="button" class="btn btn-outline-danger" title="remove" onclick="removePrefix(${pi})"><i class="fas fa-trash"></i></button>
                </div>
              </div>
              <div class="d-flex align-items-center justify-content-between mt-2 mb-2">
                <label class="form-label mb-0"><span data-i18n="testCase.bulk.middleRanges">功能分項範圍</span></label>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMiddle(${pi})"><i class="fas fa-plus me-1"></i><span data-i18n="testCase.bulk.addRange">新增範圍</span></button>
              </div>
              <div>${middlesHtml || '<div class="text-muted small">(empty)</div>'}</div>
            </div>
          </div>
        `;
    }).join('');
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(container);
}

function onPrefixChange(pi, value) { bulkTree[pi].prefix = value; updateBulkPreview(); }
function removePrefix(pi) { bulkTree.splice(pi,1); renderPrefixes(); updateBulkPreview(); }
function addMiddle(pi) { (bulkTree[pi].middles ||= []).push({ middle: '', start: 10, end: 10 }); renderPrefixes(); updateBulkPreview(); }
function removeMiddle(pi, mi) { bulkTree[pi].middles.splice(mi,1); renderPrefixes(); updateBulkPreview(); }
function onMiddleCodeChange(pi, mi, value) {
    const sanitized = (value||'').replace(/[^0-9]/g,'').slice(0,3);
    bulkTree[pi].middles[mi].middle = sanitized;
    updateBulkPreview();
}
function onSuffixChange(pi, mi, which, value) {
    const v = parseInt(value,10);
    if (isNaN(v)) return;
    const m = bulkTree[pi].middles[mi];
    if (which==='start') { m.start = v; if (!m.end || m.end < v) m.end = v; }
    else { m.end = v; if (!m.start || m.start > v) m.start = v; }
    renderPrefixes();
    updateBulkPreview();
}

function updateBulkPreview() {
    const numbers = generateBulkNumbers();
    const previewEl = document.getElementById('bulkPreviewList');
    document.getElementById('bulkTotalCount').textContent = String(numbers.length);
    // 預覽最多前 10 筆
    const preview = numbers.slice(0, 10).join(', ');
    previewEl.textContent = preview + (numbers.length > 10 ? ' ...' : '');
}

function generateBulkNumbers() {
    const list = [];
    bulkTree.forEach(p => {
        const prefix = (p.prefix||'').trim();
        (p.middles||[]).forEach(m => {
            const mid = (m.middle||'').replace(/[^0-9]/g,'');
            if (!prefix || mid.length===0) return;
            const middle = pad3(parseInt(mid,10)||0);
            const start = Math.max(10, Math.min(990, m.start||10));
            const end = Math.max(start, Math.min(990, m.end||start));
            for (let v=start; v<=end; v+=10) {
                list.push(`${prefix}.${middle}.${pad3(v)}`);
            }
        });
    });
    return list;
}

function pad3(n) { return String(n).padStart(3, '0'); }

function showBulkValidation(html, isError = true) {
    const box = document.getElementById('bulkValidation');
    box.className = isError ? 'alert alert-danger' : 'alert alert-warning';
    box.innerHTML = html;
    box.style.display = 'block';
}
function hideBulkValidation() {
    const box = document.getElementById('bulkValidation');
    box.style.display = 'none';
    box.innerHTML = '';
}

function showBulkProgress(total) {
    document.getElementById('bulkProgress').style.display = 'block';
    updateBulkProgress(0, total);
}
function hideBulkProgress() {
    document.getElementById('bulkProgress').style.display = 'none';
}
function updateBulkProgress(done, total) {
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    document.getElementById('bulkProgressText').textContent = `${done}/${total}`;
    document.getElementById('bulkProgressBar').style.width = `${pct}%`;
}

async function startBulkCreate() {
    hideBulkValidation();
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showBulkValidation(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    if (bulkTree.length === 0) {
        showBulkValidation(window.i18n ? window.i18n.t('testCase.bulk.addAtLeastOne') : '請至少新增一個範圍');
        return;
    }

    const numbers = generateBulkNumbers();
    if (numbers.length === 0) {
        showBulkValidation(window.i18n ? window.i18n.t('testCase.bulk.nothingToCreate') : '沒有可建立的單號');
        return;
    }

    // 檢查重複
    const existing = new Set(testCases.map(tc => tc.test_case_number).filter(Boolean));
    const dup = numbers.filter(n => existing.has(n));
    if (dup.length > 0) {
        const title = window.i18n ? window.i18n.t('testCase.bulk.duplicatesFound') : '發現重複單號：';
        const fixText = window.i18n ? window.i18n.t('testCase.bulk.fixBeforeSave') : '請修正後再儲存。';
        showBulkValidation(`<div class="mb-1">${title}</div><code>${dup.join(', ')}</code><div class="mt-2">${fixText}</div>`, true);
        return;
    }

    // 逐筆建立
    showBulkProgress(numbers.length);
    const saveBtn = document.getElementById('startBulkCreateBtn');
    const original = saveBtn.innerHTML;
    saveBtn.disabled = true;
    const creatingText = window.i18n ? window.i18n.t('testCase.bulk.creating') : '建立中...';
    saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${creatingText}`;

    let done = 0, errors = [];
    for (const num of numbers) {
        const payload = {
            title: `${num} ${window.i18n ? window.i18n.t('testCase.bulk.tempTitleSuffix') : '的測試案例'}`,
            test_case_number: num,
            priority: 'Medium',
            precondition: '',
            steps: '',
            expected_result: ''
        };
        try {
            const resp = await fetch(`/api/teams/${currentTeam.id}/testcases/`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                try {
                    const err = await resp.json();
                    errors.push(err.detail || resp.statusText);
                } catch (_) { errors.push(resp.statusText); }
            }
        } catch (e) {
            errors.push(String(e));
        }
        done += 1;
        updateBulkProgress(done, numbers.length);
    }

    saveBtn.disabled = false;
    saveBtn.innerHTML = original;

    if (errors.length > 0) {
        showBulkValidation((window.i18n ? window.i18n.t('errors.saveFailed') : '儲存失敗') + '<br><small>' + errors.slice(0,3).join('<br>') + (errors.length>3?' ...':'') + '</small>');
        return;
    }

    try {
        await loadTestCases(false);
        AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloaded') : '資料已重新載入');
    } catch (_) {}
    if (bulkModalInstance) bulkModalInstance.hide();
}

// 複製 Test Case：開啟與「新增/編輯」相同的 Modal，預填欄位
function copyTestCase(id) {
    const source = testCases.find(tc => tc.record_id === id);
    if (!source) return;
    // 標記為複製模式，供 showTestCaseModal 判斷隱藏「儲存並新增下一筆」
    try {
        const modal = document.getElementById('testCaseModal');
        if (modal && modal.dataset) modal.dataset.copyMode = '1';
    } catch (_) {}
    // 先以新增模式打開，確保狀態正確（不帶 record_id，附件清空，按鈕狀態正確）
    showTestCaseModal(null);

    // 設定 Modal 標題為「複製測試案例」
    const modalTitle = document.getElementById('testCaseModalTitle');
    if (modalTitle) {
        const copyText = window.i18n ? window.i18n.t('common.copy') : '複製';
        const baseTitle = window.i18n ? window.i18n.t('testCase.createTestCase') : '新增測試案例';
        modalTitle.textContent = `${copyText} ${baseTitle}`;
    }

    // 預填欄位（編號留空，避免重複；標題前綴「複製 - 」）
    const copyWord = window.i18n ? window.i18n.t('common.copy') : '複製';
    document.getElementById('testCaseId').value = '';
    document.getElementById('title').value = `${copyWord} - ${source.title || ''}`;
    document.getElementById('testCaseNumber').value = '';
    document.getElementById('priority').value = source.priority || 'Medium';
    const tcgValue = source.tcg ? source.tcg.map(t => t.text || t).join(', ') : '';
    document.getElementById('tcg').value = tcgValue;
    const modalTCGInput = document.getElementById('modalTCGInput');
    if (modalTCGInput) modalTCGInput.value = tcgValue;
    document.getElementById('precondition').value = source.precondition || '';
    document.getElementById('test_steps').value = source.steps || '';
    document.getElementById('expected_result').value = source.expected_result || '';

    // 更新 Markdown 預覽
    try {
        markdownFields.forEach(fieldId => updateMarkdownPreview(fieldId));
    } catch (_) {}

    // 新增模式下的按鈕狀態
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    if (saveBtn) saveBtn.disabled = false;
    if (saveAndAddNextBtn) {
        // 複製模式：不提供「儲存並新增下一筆」
        saveAndAddNextBtn.disabled = true;
        saveAndAddNextBtn.style.display = 'none';
    }

    // 編輯器模式採用 split（與新增一致）
    try { setEditorMode('split'); } catch (_) {}
}

let originalFormData = {}; // 存儲原始表單資料
let isFormChanged = false; // 追蹤表單是否有變更
let testCaseModalInstance = null; // 全域 Modal 實例

function showTestCaseModal(testCase = null) {
    const modal = document.getElementById('testCaseModal');
    const title = document.getElementById('testCaseModalTitle');
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    const isCopyMode = (modal && modal.dataset && modal.dataset.copyMode === '1');
    
    // 重設表單和狀態
    form.reset();
    isFormChanged = false;
    saveBtn.disabled = true;
    
    if (testCase) {
        // 編輯現有測試案例時，初始化附件資料
        if (testCase.attachments && testCase.attachments.length > 0) {
            uploadedAttachments = testCase.attachments.map(att => ({
                file_token: att.file_token,
                name: att.name,
                size: att.size,
                type: att.type || 'application/octet-stream'
            }));
        } else {
            uploadedAttachments = [];
        }
    } else {
        // 新增測試案例時，重設附件資料
        uploadedAttachments = [];
    }
    
    if (testCase) {
        // 找到當前測試案例在 filteredTestCases 中的索引
        currentTestCaseIndex = filteredTestCases.findIndex(tc => tc.record_id === testCase.record_id);
        updateNavigationButtons();
        title.textContent = window.i18n ? window.i18n.t('testCase.viewTestCase') : '檢視測試案例';
        
        // 填入資料
        document.getElementById('testCaseId').value = testCase.record_id;
        
        // 設定 modal 的 recordId dataset 供刪除附件使用
        modal.dataset.recordId = testCase.record_id;
        document.getElementById('title').value = testCase.title || '';
        document.getElementById('testCaseNumber').value = testCase.test_case_number || '';
        document.getElementById('priority').value = testCase.priority || 'Medium';
        const tcgValue = testCase.tcg ? testCase.tcg.map(t => t.text || t).join(', ') : '';
        document.getElementById('tcg').value = tcgValue;
        
        // 更新 Modal TCG 輸入框
        const modalTCGInput = document.getElementById('modalTCGInput');
        if (modalTCGInput) {
            modalTCGInput.value = tcgValue || '';
            // 不自動顯示下拉選單，只設定值
        }
        document.getElementById('precondition').value = testCase.precondition || '';
        document.getElementById('test_steps').value = testCase.steps || '';
        document.getElementById('expected_result').value = testCase.expected_result || '';
        
        // 渲染附件列表
        renderAttachmentsList();
        
        // 儲存原始資料用於比較
        originalFormData = {
            title: testCase.title || '',
            test_case_number: testCase.test_case_number || '',
            priority: testCase.priority || 'Medium',
            tcg: testCase.tcg ? testCase.tcg.map(t => t.text || t).join(', ') : '',
            precondition: testCase.precondition || '',
            steps: testCase.steps || '',
            expected_result: testCase.expected_result || ''
        };
        
        // 初始化 Markdown 預覽內容
        markdownFields.forEach(fieldId => {
            updateMarkdownPreview(fieldId);
        });
        
        // 檢視模式下預設為預覽模式
        setEditorMode('preview');
        
        // 隱藏「儲存並新增下一筆」按鈕（編輯模式不需要）
        saveAndAddNextBtn.style.display = 'none';
        
    } else {
        title.textContent = window.i18n ? window.i18n.t('testCase.createTestCase') : '新增測試案例';
        
        // 清空所有表單欄位
        document.getElementById('testCaseId').value = '';
        document.getElementById('title').value = '';
        document.getElementById('testCaseNumber').value = '';
        document.getElementById('priority').value = 'Medium';
        document.getElementById('tcg').value = '';
        document.getElementById('precondition').value = '';
        document.getElementById('test_steps').value = '';
        document.getElementById('expected_result').value = '';
        
        // 清空 Modal TCG 輸入框
        const modalTCGInput = document.getElementById('modalTCGInput');
        if (modalTCGInput) {
            modalTCGInput.value = '';
        }
        
        // 清除 modal 的 recordId dataset
        modal.dataset.recordId = '';
        
        originalFormData = {};
        saveBtn.disabled = false; // 新增模式下儲存按鈕啟用
        if (isCopyMode) {
            // 複製模式移除「儲存並新增下一筆」
            saveAndAddNextBtn.disabled = true;
            saveAndAddNextBtn.style.display = 'none';
        } else {
            saveAndAddNextBtn.disabled = false; // 新增模式下「儲存並新增下一筆」按鈕啟用
            saveAndAddNextBtn.style.display = 'inline-block'; // 顯示「儲存並新增下一筆」按鈕
        }
        currentTestCaseIndex = -1;
        updateNavigationButtons();
        
        // 渲染附件列表（新增模式下為空）
        renderAttachmentsList();
        
        // 清空所有 Markdown 預覽內容
        markdownFields.forEach(fieldId => {
            const previewElement = document.querySelector(`.markdown-preview[data-target="${fieldId}"]`);
            if (previewElement) {
                const previewPlaceholder = window.i18n ? window.i18n.t('errors.previewPlaceholder') : '預覽內容會在這裡顯示';
                previewElement.innerHTML = `<p class="text-muted">${previewPlaceholder}</p>`;
            }
        });
        
        // 新增模式下預設為編輯模式
        setEditorMode('split');
    }
    
    // 啟用所有欄位（檢視/編輯合一）
    form.querySelectorAll('input, textarea, select').forEach(el => el.disabled = false);
    
    // 綁定變更監聽器
    bindFormChangeListeners();
    
    // 在顯示 modal 前，確保所有滾動位置都在頂部
    // 這樣做可以避免 modal 顯示時的跳動效果
    resetModalScrollPositions(modal);
    
    // 只創建一次 Modal 實例，避免 backdrop 累積
    if (!testCaseModalInstance) {
        const modalOptions = window.__MINIMAL_MODE__ ? { backdrop: false, keyboard: true, focus: true } : undefined;
        testCaseModalInstance = new bootstrap.Modal(modal, modalOptions);
        
        // 只綁定一次事件監聽器
        // 顯示前立即重置滾動，並暫時隱藏內容避免進場彈跳
        modal.addEventListener('show.bs.modal', function() {
            modal.classList.add('modal-preparing');
            resetModalScrollPositions(modal);
        });
        // 顯示後完成高度計算，再解除隱藏（整體觀感無彈跳）
        modal.addEventListener('shown.bs.modal', function() {
            calculateDynamicHeights();
            resetModalScrollPositions(modal);
            modal.classList.remove('modal-preparing');
            // 綁定鍵盤左右鍵支援（僅檢視狀態觸發）
            document.addEventListener('keydown', handleTestCaseModalKeydown);
        });
        // 關閉時移除鍵盤事件監聽
        modal.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handleTestCaseModalKeydown);
            // 離開時重置 copyMode 標記
            try { modal.dataset.copyMode = '0'; } catch (_) {}
            // 最小模式：在 Modal 關閉後一併關閉彈出視窗
            if (window.__MINIMAL_MODE__) {
                try { window.close(); } catch (e) {}
            }
        });

        // 最小模式：點擊關閉按鈕時一併關閉彈出視窗
        if (window.__MINIMAL_MODE__) {
            const closeBtn = modal.querySelector('.btn-close');
            if (closeBtn && !closeBtn._closeWindowBound) {
                closeBtn.addEventListener('click', function() {
                    setTimeout(function(){ try { window.close(); } catch (e) {} }, 0);
                });
                closeBtn._closeWindowBound = true;
            }
        }
    }
    
    testCaseModalInstance.show();
}

// 鍵盤支援：在檢視 Test Case Modal 時使用左右鍵切換
function handleTestCaseModalKeydown(e) {
    try {
        const modal = document.getElementById('testCaseModal');
        if (!modal || !modal.classList.contains('show')) return;
        // 避免在輸入元件或可編輯區域觸發
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        const isEditable = e.target && (e.target.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select');
        if (isEditable) return;
        // 編輯模式時不觸發
        if (typeof currentEditorMode !== 'undefined' && currentEditorMode !== 'preview') return;
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showPrevTestCase();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            showNextTestCase();
        }
    } catch (_) {}
}

function viewTestCase(id) {
    const testCase = testCases.find(tc => tc.record_id === id);
    if (testCase) {
        showTestCaseModal(testCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 表單變更監聽器
function bindFormChangeListeners() {
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    
    // 為所有表單欄位綁定變更事件
    form.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('input', checkFormChanges);
        element.addEventListener('change', checkFormChanges);
    });
}

// 檢查表單是否有變更
function checkFormChanges() {
    const form = document.getElementById('testCaseForm');
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    const formData = new FormData(form);
    
    // 檢查新增模式
    if (!document.getElementById('testCaseId').value) {
        // 新增模式：檢查是否有填入必要欄位
        const hasTitle = formData.get('title') && formData.get('title').trim();
        saveBtn.disabled = !hasTitle;
        saveAndAddNextBtn.disabled = !hasTitle;
        return;
    }
    
    // 編輯模式：比較與原始資料的差異
    let hasChanges = false;
    
    for (const [key, value] of Object.entries(originalFormData)) {
        const currentValue = formData.get(key) || '';
        if (currentValue !== value) {
            hasChanges = true;
            break;
        }
    }
    
    isFormChanged = hasChanges;
    saveBtn.disabled = !hasChanges;
}

function deleteTestCase(id) {
    const testCase = testCases.find(tc => tc.record_id === id);
    if (!testCase) return;
    
    // 設置刪除確認 Modal 的內容
    const deleteList = document.getElementById('deleteList');
    deleteList.innerHTML = `
        <div class="mb-3">
            <p class="mb-2">確定要刪除以下測試案例嗎？</p>
            <div class="border rounded p-3 bg-light">
                <strong class="text-primary">${testCase.test_case_number || testCase.record_id}: ${testCase.title}</strong>
            </div>
        </div>
    `;
    
    // 顯示刪除確認 Modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    
    // 設置確認刪除的處理
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 發送刪除請求
            const response = await fetch(`/api/teams/${currentTeam.id}/testcases/${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '刪除失敗');
            }
            
            // 關閉 Modal
            deleteModal.hide();
            
            // 從本地陣列移除已刪除的項目（背景處理，不顯示載入動畫）
            const deletedId = recordId;
            testCases = testCases.filter(tc => tc.record_id !== deletedId);
            filteredTestCases = filteredTestCases.filter(tc => tc.record_id !== deletedId);

            // 同步移除執行頁快取
            try {
                if (testCase && (testCase.test_case_number || testCase.record_id)) {
                    const number = testCase.test_case_number;
                    if (number) removeExecCachedTestCase(number);
                }
            } catch (e) { console.debug('remove exec cache (delete) skipped:', e); }
            
            // 重新渲染表格和分頁
            renderTestCasesTable();
            updatePagination();
            
            // 用 toast 通知成功
            AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.testCaseDeleted') : '測試案例刪除成功');
            
        } catch (error) {
            console.error('刪除測試案例失敗:', error);
            const message = window.i18n ? window.i18n.t('errors.deleteFailed') : '刪除失敗';
            showError(message + '：' + error.message);
        }
    };
}

async function saveTestCase() {
    const form = document.getElementById('testCaseForm');
    const formData = new FormData(form);
    
    const testCaseData = {
        title: formData.get('title'),
        test_case_number: formData.get('test_case_number'),
        priority: formData.get('priority'),
        precondition: document.getElementById('precondition').value,
        steps: document.getElementById('test_steps').value,
        expected_result: document.getElementById('expected_result').value,
        tcg: document.getElementById('modalTCGInput').value  // 從新的 type-to-search 輸入框取得 TCG（更新 API 支援字串）
        // 注意：不再包含 attachments，因為附件現在是立即附加到記錄的
    };
    
    // 除錯：檢查 test_steps 是否被正確收集
    const testStepsElement = document.getElementById('test_steps');
    console.log('test_steps element:', testStepsElement);
    console.log('test_steps element value:', testStepsElement ? testStepsElement.value : 'element not found');
    console.log('FormData test_steps:', formData.get('test_steps'));
    console.log('All form entries:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    console.log('testCaseData:', testCaseData);
    
    // 表單驗證
    if (!testCaseData.title) {
        showError(window.i18n ? window.i18n.t('errors.testCaseTitleRequired') : '請填寫測試案例標題');
        return;
    }
    if (!testCaseData.test_case_number || !testCaseData.test_case_number.trim()) {
        showError(window.i18n ? window.i18n.t('errors.testCaseNumberRequired') : '請填寫測試案例編號');
        return;
    }
    
    // 檢查測試案例編號唯一性
    if (testCaseData.test_case_number) {
        const testCaseId = document.getElementById('testCaseId').value;
        const isDuplicate = testCases.some(tc => 
            tc.test_case_number === testCaseData.test_case_number &&
            tc.record_id !== testCaseId // 排除當前編輯的記錄
        );
        
        if (isDuplicate) {
            const existsMessage = window.i18n ? window.i18n.t('errors.testCaseNumberExists') : '已存在，請使用其他編號';
            showError(`測試案例編號 '${testCaseData.test_case_number}' ${existsMessage}`);
            return;
        }
    }
    
    // 獲取當前選擇的團隊
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    
    const testCaseId = document.getElementById('testCaseId').value;
    
    // 不關閉 Modal，保持編輯窗開啟以支持快速編輯
    // 重置變更狀態並禁用儲存按鈕
    isFormChanged = false;
    const saveBtn = document.getElementById('saveTestCaseBtn');
    saveBtn.disabled = true;
    const savingText = window.i18n ? window.i18n.t('messages.saving') : '儲存中...';
    saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${savingText}`;
    
    // 顯示儲存中訊息
    const savingMessage = testCaseId ? 
        (window.i18n ? window.i18n.t('messages.testCaseSaving') : '測試案例更新中...') : 
        (window.i18n ? window.i18n.t('messages.testCaseSaving') : '測試案例新增中...');
    showSuccess(savingMessage);
    
    // 背景處理儲存
    setTimeout(async () => {
        try {
            let response;
            
            if (testCaseId) {
                // 更新現有測試案例
                response = await fetch(`/api/teams/${currentTeam.id}/testcases/${testCaseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCaseData)
                });
            } else {
                // 新增測試案例
                // 建立 API 不支援 tcg 字串（僅 update 支援），避免 422 將其移除
                try { delete testCaseData.tcg; } catch (_) {}
                response = await fetch(`/api/teams/${currentTeam.id}/testcases/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testCaseData)
                });
            }
            
            if (!response.ok) {
                let msg = '儲存失敗';
                try {
                    const errorData = await response.json();
                    if (errorData && errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            msg = errorData.detail.map(d => d.msg || d.detail || JSON.stringify(d)).join('; ');
                        } else if (typeof errorData.detail === 'string') {
                            msg = errorData.detail;
                        } else {
                            msg = JSON.stringify(errorData.detail);
                        }
                    }
                } catch (_) {}
                throw new Error(msg);
            }
            
            // 如果是新增測試案例，需要取得新的記錄ID並轉為編輯模式
            if (!testCaseId) {
                const newTestCase = await response.json();
                if (newTestCase && newTestCase.record_id) {
                    document.getElementById('testCaseId').value = newTestCase.record_id;
                    document.getElementById('testCaseModalTitle').textContent = window.i18n ? window.i18n.t('testCase.viewTestCase') : '檢視測試案例';
                }
            }
            
            // 重新載入測試案例（不顯示載入動畫）
            await loadTestCases(false);

            // 同步更新執行頁快取：若編號變更則移除舊快取，並寫入新資料
            try {
                const oldNumber = (originalFormData && originalFormData.test_case_number) ? originalFormData.test_case_number : null;
                const newNumber = testCaseData.test_case_number;
                if (oldNumber && oldNumber !== newNumber) {
                    removeExecCachedTestCase(oldNumber);
                }
                // 從最新列表取得完整資料寫入快取
                const updatedId = document.getElementById('testCaseId').value;
                const updated = testCases.find(tc => (updatedId && tc.record_id === updatedId) || tc.test_case_number === newNumber);
                if (updated && updated.test_case_number) {
                    setExecCachedTestCase(updated.test_case_number, updated);
                }
            } catch (e) { console.debug('sync exec cache skipped:', e); }
            
            // 恢復儲存按鈕狀態
            const saveBtn = document.getElementById('saveTestCaseBtn');
            saveBtn.disabled = false;
            const saveText = window.i18n ? window.i18n.t('common.save') : '儲存';
            saveBtn.innerHTML = `<i class="fas fa-save me-2"></i>${saveText}`;
            
            // 更新成功訊息
            const completedMessage = testCaseId ? 
                (window.i18n ? window.i18n.t('messages.testCaseUpdated') : '測試案例更新完成') : 
                (window.i18n ? window.i18n.t('messages.testCaseCreated') : '測試案例新增完成');
            showSuccess(completedMessage);
            
        } catch (error) {
            console.error('儲存測試案例失敗:', error);
            
            // 恢復儲存按鈕狀態
            const saveBtn = document.getElementById('saveTestCaseBtn');
            saveBtn.disabled = false;
            const saveText = window.i18n ? window.i18n.t('common.save') : '儲存';
            saveBtn.innerHTML = `<i class="fas fa-save me-2"></i>${saveText}`;
            
            const saveFailedMessage = window.i18n ? window.i18n.t('errors.saveFailed') : '儲存失敗';
            showError(saveFailedMessage + '：' + error.message);
        }
    }, 100); // 100ms 延遲確保 UI 響應
}

// 儲存並新增下一筆測試案例
async function saveAndAddNext() {
    const form = document.getElementById('testCaseForm');
    const formData = new FormData(form);
    
    const testCaseData = {
        title: formData.get('title'),
        test_case_number: formData.get('test_case_number'),
        priority: formData.get('priority'),
        precondition: document.getElementById('precondition').value,
        steps: document.getElementById('test_steps').value,
        expected_result: document.getElementById('expected_result').value,
        tcg: document.getElementById('modalTCGInput').value
    };
    
    // 表單驗證
    if (!testCaseData.title) {
        showError(window.i18n ? window.i18n.t('errors.testCaseTitleRequired') : '請填寫測試案例標題');
        return;
    }
    if (!testCaseData.test_case_number || !testCaseData.test_case_number.trim()) {
        showError(window.i18n ? window.i18n.t('errors.testCaseNumberRequired') : '請填寫測試案例編號');
        return;
    }
    
    // 檢查測試案例編號唯一性（新增模式不需要排除任何記錄）
    if (testCaseData.test_case_number) {
        const isDuplicate = testCases.some(tc => 
            tc.test_case_number === testCaseData.test_case_number
        );
        
        if (isDuplicate) {
            const existsMessage = window.i18n ? window.i18n.t('errors.testCaseNumberExists') : '已存在，請使用其他編號';
            showError(`測試案例編號 '${testCaseData.test_case_number}' ${existsMessage}`);
            return;
        }
    }
    
    // 獲取當前選擇的團隊
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    
    // 禁用按鈕並顯示載入狀態
    const saveBtn = document.getElementById('saveTestCaseBtn');
    const saveAndAddNextBtn = document.getElementById('saveAndAddNextBtn');
    saveBtn.disabled = true;
    saveAndAddNextBtn.disabled = true;
    const savingText = window.i18n ? window.i18n.t('messages.saving') : '儲存中...';
    saveAndAddNextBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${savingText}`;
    
    showSuccess(window.i18n ? window.i18n.t('messages.testCaseSaving') : '測試案例新增中...');
    
    try {
        // 新增測試案例
        // 建立 API 不支援 tcg 字串（僅 update 支援），避免 422 將其移除
        try { delete testCaseData.tcg; } catch (_) {}
        const response = await fetch(`/api/teams/${currentTeam.id}/testcases/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testCaseData)
        });
        
        if (!response.ok) {
            let msg = '儲存失敗';
            try {
                const errorData = await response.json();
                if (errorData && errorData.detail) {
                    if (Array.isArray(errorData.detail)) {
                        msg = errorData.detail.map(d => d.msg || d.detail || JSON.stringify(d)).join('; ');
                    } else if (typeof errorData.detail === 'string') {
                        msg = errorData.detail;
                    } else {
                        msg = JSON.stringify(errorData.detail);
                    }
                }
            } catch (_) {}
            throw new Error(msg);
        }
        
        // 重新載入測試案例（不顯示載入動畫）
        await loadTestCases(false);

        // 將新建的案例寫入執行頁快取
        try {
            const created = testCases.find(tc => tc.test_case_number === testCaseData.test_case_number);
            if (created && created.test_case_number) {
                setExecCachedTestCase(created.test_case_number, created);
            }
        } catch (e) { console.debug('set exec cache (create) skipped:', e); }
        
        showSuccess(window.i18n ? window.i18n.t('messages.testCaseCreatedNext') : '測試案例新增完成，準備下一筆');
        
        // 重置表單為新增下一筆狀態
        showTestCaseModal(null); // 呼叫新增模式，會自動清空所有欄位並設定為編輯模式
        
    } catch (error) {
        console.error('儲存測試案例失敗:', error);
        
        // 恢復按鈕狀態
        saveBtn.disabled = false;
        saveAndAddNextBtn.disabled = false;
        const saveAndNextText = window.i18n ? window.i18n.t('testCase.saveAndNext') : '儲存並新增下一筆';
        saveAndAddNextBtn.innerHTML = `<i class="fas fa-plus me-2"></i>${saveAndNextText}`;
        
        const saveFailedMessage = window.i18n ? window.i18n.t('errors.saveFailed') : '儲存失敗';
        showError(saveFailedMessage + '：' + error.message);
    }
}

// 工具函數
function getStatusBadgeClass(status) {
    const classes = {
        'Draft': 'bg-secondary',
        'Review': 'bg-warning',
        'Active': 'bg-success',
        'Deprecated': 'bg-danger'
    };
    return classes[status] || 'bg-secondary';
}

function getStatusText(status) {
    const texts = {
        'Draft': '草稿',
        'Review': '待審核',
        'Active': '啟用',
        'Deprecated': '廢棄'
    };
    return texts[status] || status;
}

function getPriorityBadgeClass(priority) {
    const classes = {
        'High': 'bg-danger',
        'Medium': 'bg-warning',
        'Low': 'bg-info'
    };
    return classes[priority] || 'bg-secondary';
}

function getPriorityText(priority) {
    return priority || '';
}

function getTCGDisplay(testCase) {
    if (!testCase.tcg || testCase.tcg.length === 0) {
        return '-';
    }
    
    // 提取所有 TCG 顯示文字
    const tcgNumbers = [];
    for (const tcgRecord of testCase.tcg) {
        if (tcgRecord.text) {
            tcgNumbers.push(tcgRecord.text);
        } else if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            tcgNumbers.push(...tcgRecord.text_arr);
        }
    }
    
    return tcgNumbers.length > 0 ? tcgNumbers.join(', ') : '-';
}

function getTCGTags(testCase) {
    if (!testCase.tcg || testCase.tcg.length === 0) {
        return '';
    }
    
    // 提取所有 TCG 顯示文字
    const tcgNumbers = [];
    for (const tcgRecord of testCase.tcg) {
        if (tcgRecord.text) {
            tcgNumbers.push(tcgRecord.text);
        } else if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            tcgNumbers.push(...tcgRecord.text_arr);
        }
    }
    
    if (tcgNumbers.length === 0) {
        return '';
    }
    
    // 創建柔和的 tag
    return tcgNumbers.map(tcg => 
        `<span class="tcg-tag">${tcg}</span>`
    ).join('');
}

function applyFilters() {
    const testCaseNumberSearch = document.getElementById('testCaseNumberSearch').value.toLowerCase();
    const search = document.getElementById('searchInput').value.toLowerCase();
    const priority = document.getElementById('priorityFilter').value;
    
    filteredTestCases = testCases.filter(testCase => {
        // Test Case Number 搜尋（包含 TCG 編號和測試案例編號）
        const matchTestCaseNumber = !testCaseNumberSearch || 
            (testCase.test_case_number && testCase.test_case_number.toLowerCase().includes(testCaseNumberSearch)) ||
            (testCase.tcg && testCase.tcg.some(tcgItem => {
                const tcgText = tcgItem.text || tcgItem;
                return tcgText && tcgText.toLowerCase().includes(testCaseNumberSearch);
            }));
        
        // 關鍵字搜尋（標題和描述）
        const matchSearch = !search || 
            testCase.title.toLowerCase().includes(search) ||
            (testCase.description && testCase.description.toLowerCase().includes(search));
        
        // 優先級篩選
        const matchPriority = !priority || testCase.priority === priority;
        
        return matchTestCaseNumber && matchSearch && matchPriority;
    });
    
    currentPage = 1;
    renderTestCasesTable();
    updatePagination();
    updateFilterStatus();
}

function clearFilters() {
    document.getElementById('testCaseNumberSearch').value = '';
    document.getElementById('searchInput').value = '';
    document.getElementById('priorityFilter').value = '';
    
    filteredTestCases = [...testCases];
    currentPage = 1;
    renderTestCasesTable();
    updatePagination();
    updateFilterStatus();
}

function updateFilterStatus() {
    const applyBtn = document.getElementById('applyFiltersBtn');
    const clearBtn = document.getElementById('clearFiltersBtn');
    
    // 檢查是否有任何篩選條件
    const hasFilters = hasAnyFilters();
    
    if (hasFilters) {
        // 有篩選條件時，更新按鈕樣式和文字
        const filteredText = window.i18n ? window.i18n.t('common.filtered', {count: filteredTestCases.length}) : `已篩選 (${filteredTestCases.length})`;
        applyBtn.innerHTML = '<i class="fas fa-filter me-2"></i>' + filteredText;
        applyBtn.className = 'btn btn-success me-2';
        clearBtn.style.display = 'inline-block';
    } else {
        // 無篩選條件時，恢復原始樣式
        const applyFilterText = window.i18n ? window.i18n.t('common.applyFilter') : '套用篩選';
        applyBtn.innerHTML = '<i class="fas fa-filter me-2"></i>' + applyFilterText;
        applyBtn.className = 'btn btn-primary me-2';
        clearBtn.style.display = testCases.length === filteredTestCases.length ? 'none' : 'inline-block';
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.test-case-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const id = checkbox.value; // record_id 是字串，勿轉數字
        if (selectAll) {
            selectedTestCases.add(id);
        } else {
            selectedTestCases.delete(id);
        }
    });
    
    updateBatchToolbar();
}

function updateBatchToolbar() {
    const toolbar = document.getElementById('batchInlineToolbar');
    if (!toolbar) return;
    
    const selectedCount = selectedTestCases ? selectedTestCases.size : 0;
    
    // 更新選中數量顯示
    const countWrapper = document.getElementById('selectedCountWrapper');
    if (countWrapper) {
        // 更新 data-i18n-params
        countWrapper.setAttribute('data-i18n-params', JSON.stringify({count: selectedCount}));
        
        // 如果 i18n 已載入，重新翻譯此元素
        if (window.i18n && window.i18n.updateElement) {
            window.i18n.updateElement(countWrapper);
        } else {
            // 如果 i18n 還未載入或無法更新，手動更新內容
            const currentLang = localStorage.getItem('preferredLanguage') || 'zh-TW';
            if (currentLang === 'zh-TW') {
                countWrapper.textContent = `已選取 ${selectedCount} 個項目`;
            } else {
                countWrapper.textContent = `${selectedCount} items selected`;
            }
        }
    }
    
    // 顯示/隱藏工具列
    if (selectedCount > 0) {
        toolbar.classList.remove('d-none');
    } else {
        toolbar.classList.add('d-none');
    }
    
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function deselectAll() {
    selectedTestCases.clear();
    document.querySelectorAll('.test-case-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateBatchToolbar();
}

function batchEditTestCases() {
    if (selectedTestCases.size === 0) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTestCase') : '請先選擇要編輯的測試案例');
        return;
    }
    // TODO: 實現批次編輯功能
    const msg = window.i18n ? window.i18n.t('messages.operationNotImplemented') : '批次編輯功能開發中...';
    alert(msg);
}

function batchDeleteTestCases() {
    if (selectedTestCases.size === 0) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectForDelete') : '請先選擇要刪除的測試案例');
        return;
    }
    
    // 獲取選中的測試案例
    const selectedIds = Array.from(selectedTestCases);
    const selectedCases = testCases.filter(tc => selectedIds.includes(tc.record_id));
    
    // 設置批次刪除確認 Modal 的內容
    const deleteList = document.getElementById('deleteList');
    deleteList.innerHTML = `
        <div class="mb-3">
            <p class="mb-2">確定要刪除以下 ${selectedCases.length} 個測試案例嗎？</p>
            <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                ${selectedCases.map(tc => `
                    <div class="mb-2">
                        <strong class="text-primary">${tc.test_case_number || tc.record_id}: ${tc.title}</strong>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // 顯示刪除確認 Modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
    
    // 設置確認刪除的處理
    document.getElementById('confirmDeleteBtn').onclick = async function() {
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 發送批次刪除請求
            const response = await fetch(`/api/teams/${currentTeam.id}/testcases/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    operation: 'delete',
                    record_ids: selectedIds
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '批次刪除失敗');
            }
            
            // 關閉 Modal
            deleteModal.hide();
            
            // 清除選擇
            deselectAll();
            
            // 從本地陣列移除已刪除的項目（背景處理，不顯示載入動畫）
            const deletedIds = Array.from(selectedIds);
            testCases = testCases.filter(tc => !deletedIds.includes(tc.record_id));
            filteredTestCases = filteredTestCases.filter(tc => !deletedIds.includes(tc.record_id));
            
            // 重新渲染表格和分頁
            renderTestCasesTable();
            updatePagination();
            
            // 用 toast 通知成功
            const batchDeleteMessage = window.i18n ? 
                window.i18n.t('messages.batchDeleteSuccess', {count: selectedCases.length}) : 
                `成功刪除 ${selectedCases.length} 個測試案例`;
            AppUtils.showSuccess(batchDeleteMessage);
            
        } catch (error) {
            console.error('批次刪除測試案例失敗:', error);
            const batchDeleteFailedMessage = window.i18n ? window.i18n.t('errors.batchDeleteFailed') : '批次刪除失敗';
            showError(batchDeleteFailedMessage + '：' + error.message);
        }
    };
}

function showLoadingState() {
    const tbody = document.getElementById('testCasesTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center" style="padding-top: 4rem; padding-bottom: 4rem; padding-left: 1rem; padding-right: 1rem;">
                <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <div class="mt-2 text-muted fs-6">載入測試案例中...</div>
            </td>
        </tr>
    `;
}

function hideLoadingState() {
    // hideLoadingState 現在由 renderTestCasesTable 來處理
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(filteredTestCases.length / pageSize);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        // 分頁內容清空後也需要重新計算列表高度，以避免 sticky 分頁高度變化造成重疊
        if (typeof adjustTestCasesScrollHeight === 'function') {
            adjustTestCasesScrollHeight();
        }
        return;
    }
    
    let paginationHtml = '';
    
    // 上一頁
    const previousText = window.i18n ? window.i18n.t('pagination.previousPage') : '上一頁';
    paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">${previousText}</a>
        </li>
    `;
    
    // 頁碼
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += `<li class="page-item active"><a class="page-link" href="#">${i}</a></li>`;
        } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">...</a></li>`;
        }
    }
    
    // 下一頁
    const nextText = window.i18n ? window.i18n.t('pagination.nextPage') : '下一頁';
    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">${nextText}</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHtml;
    // 分頁內容更新後，重新計算列表高度，避免與分頁重疊
    if (typeof adjustTestCasesScrollHeight === 'function') {
        adjustTestCasesScrollHeight();
    }
}

function changePage(page) {
    const totalPages = Math.ceil(filteredTestCases.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTestCasesTable();
        updatePagination();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 快速編輯功能
function quickEdit(recordId, field) {
    const testCase = testCases.find(tc => tc.record_id === recordId);
    if (!testCase) return;
    
    const cell = document.querySelector(`[data-record-id="${recordId}"][data-field="${field}"]`);
    if (!cell) return;
    
    // 獲取當前值
    const currentValue = testCase[field] || '';
    
    // 建立輸入框
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.className = 'form-control quick-edit-input';
    input.style.width = '100%';
    input.style.height = 'auto';
    input.style.minHeight = '1.5rem';
    input.style.lineHeight = '1.5';
    input.style.fontSize = '0.875rem';
    input.style.padding = '0.25rem 0.5rem';
    input.style.border = '1px solid #007bff';
    input.style.borderRadius = '4px';
    input.style.margin = '0';
    
    // 儲存原始內容
    const originalContent = cell.innerHTML;
    
    // 替換內容
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
    input.select();
    
    // 處理儲存
    const saveEdit = async () => {
        const newValue = input.value.trim();
        
        if (newValue === currentValue) {
            // 值沒有變更，恢復原始內容
            cell.innerHTML = originalContent;
            return;
        }
        
        // 立即更新本地資料和 UI
        testCase[field] = newValue;
        cell.innerHTML = originalContent; // 先恢復原始結構
        
        // 立即重新渲染表格以顯示新值
        renderTestCasesTable();
        
        // 在背景處理儲存
        try {
            // 獲取當前團隊
            const currentTeam = AppUtils.getCurrentTeam();
            if (!currentTeam || !currentTeam.id) {
                throw new Error('請先選擇團隊');
            }
            
            // 構建更新資料
            const updateData = {};
            updateData[field] = newValue;
            
            // 背景發送更新請求，不等待響應
            fetch(`/api/teams/${currentTeam.id}/testcases/${recordId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            }).then(async response => {
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '更新失敗');
                }
                // 成功後顯示提示，但不重新渲染（已經渲染過了）
                const fieldName = field === 'test_case_number' ? 'Test Case Number' : 
                    (window.i18n ? window.i18n.t('common.title') : '標題');
                const updateSuccessMessage = window.i18n ? window.i18n.t('messages.fieldUpdated') : '更新成功';
                showSuccess(`${fieldName} ${updateSuccessMessage}`);
            }).catch(error => {
                console.error('快速編輯失敗:', error);
                const updateFailedMessage = window.i18n ? window.i18n.t('errors.updateFailed') : '更新失敗';
                showError(updateFailedMessage + '：' + error.message);
                
                // 如果儲存失敗，恢復原值並重新渲染
                testCase[field] = currentValue;
                renderTestCasesTable();
            });
            
        } catch (error) {
            console.error('快速編輯失敗:', error);
            const updateFailedMessage = window.i18n ? window.i18n.t('errors.updateFailed') : '更新失敗';
            showError(updateFailedMessage + '：' + error.message);
            
            // 恢復原值並重新渲染
            testCase[field] = currentValue;
            renderTestCasesTable();
        }
    };
    
    // 處理取消
    const cancelEdit = () => {
        cell.innerHTML = originalContent;
    };
    
    // 綁定事件
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit();
        }
    });
    
    input.addEventListener('blur', saveEdit);
}

// TCG 編輯功能 - 簡化直接編輯
let currentTCGEditor = null;

async function editTCG(recordId) {
    const testCase = testCases.find(tc => tc.record_id === recordId);
    if (!testCase) return;
    
    const cell = document.querySelector(`[data-record-id="${recordId}"][data-field="tcg"]`);
    if (!cell) return;
    
    // 如果已經有編輯器在運行，先關閉
    if (currentTCGEditor && currentTCGEditor.recordId !== recordId) {
        await finishTCGEdit();
    }
    
    // 獲取當前 TCG
    const currentTCGs = [];
    for (const tcgRecord of testCase.tcg || []) {
        if (tcgRecord.text_arr && tcgRecord.text_arr.length > 0) {
            currentTCGs.push(...tcgRecord.text_arr);
        } else if (tcgRecord.text) {
            currentTCGs.push(tcgRecord.text);
        }
    }
    
    // 設置編輯器狀態
    currentTCGEditor = {
        recordId: recordId,
        cell: cell,
        originalTCGs: [...currentTCGs],
        currentTCGs: [...currentTCGs],
        originalContent: cell.innerHTML,
        mode: 'search'
    };
    
    // 直接進入搜尋模式
    startTCGSearch();
}

async function startTCGSearch() {
    if (!currentTCGEditor) return;
    
    const { cell, currentTCGs, recordId } = currentTCGEditor;
    
    // 直接顯示搜尋框 - 隱藏原標籤
    const searchHtml = `
        <div class="tcg-search-container position-relative" style="min-height: 32px; height: 32px; display: flex; align-items: center; overflow: hidden;">
            <input type="text" class="form-control form-control-sm tcg-search-input" 
                   data-i18n-placeholder="testCase.tcgPlaceholder" autocomplete="off" 
                   onkeydown="handleTCGSearchKeydown(event)" 
                   oninput="handleTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="height: 28px; width: 100%; font-size: 0.75rem; padding: 0.125rem 0.375rem; border: 1px solid #dee2e6; box-shadow: none; outline: none;">
            <div class="tcg-dropdown" 
                 style="display: none;">
                <div class="p-2 text-muted small">開始輸入以搜尋 TCG...</div>
            </div>
        </div>
    `;
    
    cell.innerHTML = searchHtml;
    cell.classList.add('editing');
    
    // 聚焦搜尋框並立即載入選項
    const searchInput = cell.querySelector('.tcg-search-input');
    searchInput.focus();
    
    // 立即載入 TCG 選項並顯示下拉選單
    await searchTCGOptions('');
    const dropdown = cell.querySelector('.tcg-dropdown');
    if (dropdown) {
        // 計算輸入框的位置
        const searchInput = cell.querySelector('.tcg-search-input');
        const rect = searchInput.getBoundingClientRect();
        
        // 設定 fixed 定位的座標
        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.width = Math.max(300, rect.width) + 'px';
        dropdown.style.display = 'block';
    }
    
    // 添加點擊外部結束編輯的監聽器
    setTimeout(() => {
        document.addEventListener('click', handleTCGOutsideClick, true);
    }, 100);
}

function handleTCGOutsideClick(event) {
    if (!currentTCGEditor) return;
    
    const { cell } = currentTCGEditor;
    
    // 檢查點擊是否在編輯區域外
    if (!cell.contains(event.target)) {
        finishTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function finishTCGEdit() {
    if (!currentTCGEditor) return;
    
    const { recordId, currentTCGs, originalTCGs, cell } = currentTCGEditor;
    
    // 移除全域點擊監聽器
    document.removeEventListener('click', handleTCGOutsideClick, true);
    
    // 檢查是否有變更
    const hasChanges = JSON.stringify(currentTCGs.sort()) !== JSON.stringify(originalTCGs.sort());
    
    // 立即更新 UI 顯示
    cell.classList.remove('editing');
    updateTCGCellDisplay(cell, currentTCGs);
    
    // 清除編輯器狀態
    currentTCGEditor = null;
    
    // 如果有變更，在背景處理儲存
    if (hasChanges) {
        // 非同步背景儲存，不等待完成
        saveTCGChanges(recordId, currentTCGs).catch(error => {
            console.error('TCG 儲存失敗:', error);
            // 如果儲存失敗，可以考慮顯示錯誤訊息或恢復原值
        });
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function updateTCGCellDisplay(cell, tcgNumbers) {
    // 更新單個 TCG 欄位的顯示，不重新渲染整個表格
    const recordId = cell.getAttribute('data-record-id');
    
    if (tcgNumbers.length === 0) {
        // 清除後留白，但保留點擊事件
        cell.innerHTML = `<div class="tcg-edit-area" onclick="editTCG('${recordId}')" data-i18n-title="tooltips.clickEditTcg"></div>`;
    } else {
        // 顯示 TCG 標籤，保留點擊事件
        const tcgHtml = tcgNumbers.map(tcg => 
            `<span class="tcg-tag">${tcg}</span>`
        ).join('');
        cell.innerHTML = `<div class="tcg-edit-area" onclick="editTCG('${recordId}')" data-i18n-title="tooltips.clickEditTcg">${tcgHtml}</div>`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function restoreTCGDisplay() {
    if (!currentTCGEditor) return;
    
    const { cell } = currentTCGEditor;
    cell.classList.remove('editing');
    renderTestCasesTable(); // 重新渲染以恢復正常顯示
}


let tcgSearchTimeout;

function handleTCGSearchInput(event) {
    clearTimeout(tcgSearchTimeout);
    tcgSearchTimeout = setTimeout(async () => {
        await searchTCGOptions(event.target.value);
    }, 300);
}

function handleTCGSearchKeydown(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        finishTCGEdit();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        // 取消變更
        if (currentTCGEditor) {
            currentTCGEditor.currentTCGs = [...currentTCGEditor.originalTCGs];
        }
        finishTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function searchTCGOptions(keyword) {
    if (!currentTCGEditor) return;
    
    const dropdown = currentTCGEditor.cell.querySelector('.tcg-dropdown');
    if (!dropdown) return;
    
    try {
        console.log('搜尋 TCG:', keyword);
        
        // 優先使用快取
        let results = [];
        if (tcgCache) {
            results = searchTCGFromCache(keyword, 20);
            console.log('從快取取得 TCG 搜尋結果:', results.length, '筆');
        } else {
            // 如果沒有快取，使用 API
            const response = await fetch(`/api/tcg/search?keyword=${encodeURIComponent(keyword)}&limit=20`);
            if (!response.ok) {
                console.error('TCG 搜尋失敗:', response.status, response.statusText);
                throw new Error(`搜尋 TCG 失敗: ${response.status}`);
            }
            const data = await response.json();
            results = data.results;
            console.log('從 API 取得 TCG 搜尋結果:', results.length, '筆');
        }
        
        // 始終顯示清除選項作為第一項
        let dropdownHtml = `
            <div class="tcg-option p-2 border-bottom" 
                  onclick="event.stopPropagation(); clearTCGValue()" 
                  style="cursor: pointer; border-bottom: 1px solid #f8f9fa; background-color: #fff3cd;" 
                  onmouseover="this.style.backgroundColor='#ffeaa7'" 
                  onmouseout="this.style.backgroundColor='#fff3cd'">
                <div class="fw-medium text-warning">
                    <i class="fas fa-times me-2"></i>清除 TCG 單號
                </div>
            </div>
        `;
        
        if (results.length === 0) {
            dropdownHtml += '<div class="p-2 text-muted small">沒有找到其他結果</div>';
        } else {
            dropdownHtml += results.map(tcg => 
                `<div class="tcg-option p-2 border-bottom" 
                      onclick="event.stopPropagation(); selectTCGOption('${tcg.tcg_number}')" 
                      style="cursor: pointer; border-bottom: 1px solid #f8f9fa; padding: 0.25rem 0.75rem;" 
                      onmouseover="this.style.backgroundColor='#f8f9fa'" 
                      onmouseout="this.style.backgroundColor='white'">
                    <div class="fw-medium">${tcg.tcg_number}</div>
                </div>`
            ).join('');
        }
        
        dropdown.innerHTML = dropdownHtml;
        
        // 更新位置並顯示
        const searchInput = currentTCGEditor.cell.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
        
    } catch (error) {
        console.error('搜尋 TCG 失敗:', error);
        const searchFailedMessage = window.i18n ? window.i18n.t('errors.searchFailed') : '搜尋失敗';
        dropdown.innerHTML = `<div class="p-2 text-danger small">${searchFailedMessage}</div>`;
        
        // 更新位置並顯示
        const searchInput = currentTCGEditor.cell.querySelector('.tcg-search-input');
        if (searchInput) {
            const rect = searchInput.getBoundingClientRect();
            dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = Math.max(300, rect.width) + 'px';
        }
        dropdown.style.display = 'block';
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function selectTCGOption(tcgNumber) {
    if (!currentTCGEditor) return;
    
    // 設置單一 TCG 值
    currentTCGEditor.currentTCGs = [tcgNumber];
    
    // 立即完成編輯並儲存
    finishTCGEdit();
}

function clearTCGValue() {
    if (!currentTCGEditor) return;
    
    // 清空 TCG 值
    currentTCGEditor.currentTCGs = [];
    
    // 立即完成編輯並儲存
    finishTCGEdit();
}

async function fetchTCGRecordByNumber(tcgNumber) {
    try {
        // 從 TCG API 獲取對應的記錄資訊
        const response = await fetch(`/api/tcg/search?keyword=${encodeURIComponent(tcgNumber)}&limit=1`);
        if (!response.ok) {
            return null;
        }
        
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            const tcg = data.results[0];
            // 找到完全匹配的 TCG
            if (tcg.tcg_number === tcgNumber) {
                return {
                    record_id: tcg.record_id || `tcg_${tcg.tcg_number}`,
                    table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
                    tcg_number: tcg.tcg_number,
                    title: tcg.title
                };
            }
        }
        
        // 如果找不到對應記錄，創建一個模擬記錄
        return {
            record_id: `tcg_${tcgNumber}`,
            table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
            tcg_number: tcgNumber,
            title: tcgNumber
        };
    } catch (error) {
        console.error('查詢 TCG 記錄失敗:', error);
        // 返回模擬記錄以保持功能運作
        return {
            record_id: `tcg_${tcgNumber}`,
            table_id: 'tblcK6eF3yQCuwwl', // TCG 表格 ID
            tcg_number: tcgNumber,
            title: tcgNumber
        };
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function saveTCGChanges(recordId, tcgNumbers) {
    try {
        // 獲取當前團隊
        const currentTeam = AppUtils.getCurrentTeam();
        if (!currentTeam || !currentTeam.id) {
            throw new Error('請先選擇團隊');
        }
        
        // 將 TCG 編號轉換為 LarkRecord 格式
        const tcgRecords = [];
        for (const tcgNum of tcgNumbers) {
            // 使用 TCG 轉換器查詢對應的記錄 ID
            const tcgRecord = await fetchTCGRecordByNumber(tcgNum);
            if (tcgRecord) {
                tcgRecords.push({
                    record_ids: [tcgRecord.record_id],
                    text: tcgNum,
                    text_arr: [tcgNum],
                    table_id: tcgRecord.table_id || '',
                    type: 'record'
                });
            }
        }
        
        // 構建更新資料
        const updateData = {
            tcg: tcgRecords
        };
        
        // 發送更新請求
        const response = await fetch(`/api/teams/${currentTeam.id}/testcases/${recordId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || '更新失敗');
        }
        
        // 更新本地資料
        const testCase = testCases.find(tc => tc.record_id === recordId);
        if (testCase) {
            testCase.tcg = tcgRecords;
        }
        
        // 重新渲染表格
        renderTestCasesTable();
        
        showSuccess(window.i18n ? window.i18n.t('messages.tcgUpdated') : 'TCG 更新成功');
        
    } catch (error) {
        console.error('更新 TCG 失敗:', error);
        const updateFailedMessage = window.i18n ? window.i18n.t('errors.updateFailed') : '更新失敗';
        showError(updateFailedMessage + '：' + error.message);
        
        // 恢復原始內容
        restoreTCGDisplay();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}


// 通用工具函數
function showSuccess(message) {
    if (AppUtils && AppUtils.showSuccess) {
        AppUtils.showSuccess(message);
    } else {
        alert(message);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function showError(message) {
    if (AppUtils && AppUtils.showError) {
        AppUtils.showError(message);
    } else {
        alert(message);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function formatDate(dateString, format) {
    if (AppUtils && AppUtils.formatDate) {
        return AppUtils.formatDate(dateString, format);
    } else {
        // 備用方案：使用瀏覽器的預設 locale，符合地區標準格式
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        const browserLocale = navigator.language || navigator.userLanguage || 'en-US';
        
        if (format === 'date') {
            return date.toLocaleDateString(browserLocale);
        } else if (format === 'datetime') {
            return date.toLocaleString(browserLocale);
        } else if (format === 'time') {
            return date.toLocaleTimeString(browserLocale);
        }
        
        return date.toLocaleDateString(browserLocale);
    }
}

// Markdown 編輯器功能
let currentEditorMode = 'preview'; // 預設為預覽模式
let markdownPreviewTimeout;
let activeTextarea = null; // 當前焦點的 textarea

// 支援 Markdown 的欄位
const markdownFields = ['precondition', 'test_steps', 'expected_result'];

// 生成 Markdown 工具列 HTML
function generateMarkdownToolbar(targetFieldId) {
    return `
        <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="${targetFieldId}" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
            <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="\`" data-i18n-title="markdown.code">
                    <i class="fas fa-code"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
            </div>
            <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                    <i class="fas fa-list-ol"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                    <i class="fas fa-link"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                    <i class="fas fa-image"></i>
                </button>
            </div>
            <button type="button" class="btn btn-outline-info btn-xs markdown-help-btn" data-i18n-title="tooltips.markdownHelp" style="margin-left: 8px;" onclick="window.open('https://www.markdownguide.org/cheat-sheet/', '_blank')">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    `;
}

// 生成完整的 Markdown 編輯器容器
function generateMarkdownEditor(fieldId, fieldName, placeholder, rows = 6, height = '200px') {
    return `
        <div class="row">
            <div class="col-12 d-none edit-column">
                <!-- 編輯框容器 -->
                <div class="form-control markdown-edit-container" style="padding: 0; height: ${height};">
                    ${generateMarkdownToolbar(fieldId)}
                    <textarea id="${fieldId}" name="${fieldName}" class="markdown-textarea" rows="${rows}" 
                              placeholder="${placeholder}" style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                </div>
            </div>
            <div class="col-12 preview-column">
                <div class="markdown-preview-container" style="height: ${height};">
                    <div class="markdown-preview" id="${fieldId}Preview" style="padding: 8px; height: 100%; overflow-y: auto; background: #f8f9fa; border: 1px solid #ced4da; border-radius: 0.375rem;">
                        <p class="text-muted">預覽內容會在這裡顯示</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 初始化所有 Markdown 編輯器
function initializeAllMarkdownEditors() {
    // 編輯器配置
    const editorConfigs = [
        {
            fieldId: 'precondition',
            fieldName: 'precondition',
            placeholder: '請描述測試前置條件...',
            height: '200px'
        },
        {
            fieldId: 'test_steps',
            fieldName: 'test_steps',
            placeholder: '請描述詳細的測試步驟...',
            height: '250px'
        },
        {
            fieldId: 'expected_result',
            fieldName: 'expected_result',
            placeholder: '請描述預期的測試結果...',
            height: '200px'
        }
    ];
    
    // 為每個編輯器生成 HTML 並替換現有內容
    editorConfigs.forEach(config => {
        const container = document.getElementById(config.fieldId + '_container');
        if (container) {
            container.innerHTML = generateMarkdownEditor(
                config.fieldId,
                config.fieldName,
                config.placeholder,
                6,
                config.height
            ).trim();
        }
    });
    
    // 重新綁定事件
    bindMarkdownEvents();
}

// 綁定 Markdown 事件
function bindMarkdownEvents() {
    // Markdown 工具列按鈕 (個別工具列)
    document.querySelectorAll('.markdown-toolbar button[data-md]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const toolbar = e.currentTarget.closest('.markdown-toolbar');
            const targetFieldId = toolbar.getAttribute('data-target');
            const mdSyntax = e.currentTarget.getAttribute('data-md');
            insertMarkdownToField(targetFieldId, mdSyntax);
        });
    });
    
    // 為所有 Markdown 欄位添加事件監聽
    markdownFields.forEach(fieldId => {
        const textarea = document.getElementById(fieldId);
        if (textarea) {
            // 焦點事件：記住當前活動的 textarea
            textarea.addEventListener('focus', () => {
                activeTextarea = textarea;
            });
            
            // 輸入事件：更新預覽
            textarea.addEventListener('input', () => {
                if (currentEditorMode !== 'edit') {
                    clearTimeout(markdownPreviewTimeout);
                    markdownPreviewTimeout = setTimeout(() => {
                        updateMarkdownPreview(fieldId);
                    }, 300);
                }
            });
        }
    });
    
}

// 安全地添加幫助按鈕到現有工具列
function addHelpButtonsToToolbars() {
    markdownFields.forEach(fieldId => {
        const toolbar = document.querySelector(`.markdown-toolbar[data-target="${fieldId}"]`);
        if (toolbar && !toolbar.querySelector('.markdown-help-btn')) {
            const helpButton = document.createElement('button');
            helpButton.type = 'button';
            helpButton.className = 'btn btn-outline-info btn-xs markdown-help-btn';
            helpButton.setAttribute('data-i18n-title', 'markdown.help');
            helpButton.title = 'Markdown 語法說明'; // fallback
            helpButton.style.marginLeft = '8px';
            helpButton.onclick = () => window.open('https://www.markdownguide.org/cheat-sheet/', '_blank');
            helpButton.innerHTML = '<i class="fas fa-question-circle"></i>';
            toolbar.appendChild(helpButton);
            
            // 手動觸發翻譯
            if (window.i18n && window.i18n.isReady()) {
                const translatedTitle = window.i18n.t('markdown.help');
                if (translatedTitle && translatedTitle !== 'markdown.help') {
                    helpButton.title = translatedTitle;
                }
            }
        }
    });
}

// 初始化 Markdown 編輯器
function initializeMarkdownEditor() {
    // 模式切換按鈕
    document.getElementById('previewModeBtn').addEventListener('click', () => setEditorMode('preview'));
    document.getElementById('splitModeBtn').addEventListener('click', () => setEditorMode('split'));
    
    // 綁定 Markdown 事件
    bindMarkdownEvents();
    
    // 安全地添加幫助按鈕
    addHelpButtonsToToolbars();
    
    // 附件上傳功能
    const attachmentUpload = document.getElementById('attachmentUpload');
    if (attachmentUpload) {
        attachmentUpload.addEventListener('change', handleAttachmentUpload);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 設置編輯器模式
function setEditorMode(mode) {
    currentEditorMode = mode;
    
    // 更新按鈕狀態
    document.querySelectorAll('#previewModeBtn, #splitModeBtn').forEach(btn => {
        btn.classList.remove('active', 'btn-secondary');
        btn.classList.add('btn-outline-secondary');
    });
    const activeBtn = document.getElementById(mode + 'ModeBtn');
    if (activeBtn) {
        activeBtn.classList.remove('btn-outline-secondary');
        activeBtn.classList.add('btn-secondary', 'active');
    }
    
    // 為所有 Markdown 欄位設置模式
    markdownFields.forEach(fieldId => {
        const container = document.querySelector(`#${fieldId}`).closest('.markdown-field-container');
        if (!container) return;
        
        const editColumn = container.querySelector('.edit-column');
        const previewColumn = container.querySelector('.preview-column');
        
        // 重置類別
        editColumn.className = 'edit-column';
        previewColumn.className = 'preview-column';
        
        switch (mode) {
            case 'edit':
                editColumn.className = 'col-12 edit-column';
                previewColumn.className = 'col-12 d-none preview-column';
                break;
            case 'preview':
                editColumn.className = 'col-12 d-none edit-column';
                previewColumn.className = 'col-12 preview-column';
                updateMarkdownPreview(fieldId);
                break;
            case 'split':
                editColumn.className = 'col-6 edit-column';
                previewColumn.className = 'col-6 preview-column';
                updateMarkdownPreview(fieldId);
                break;
        }
    });
    
    // 控制個別工具列顯示
    markdownFields.forEach(fieldId => {
        const toolbar = document.querySelector(`.markdown-toolbar[data-target="${fieldId}"]`);
        if (toolbar) {
            toolbar.style.display = mode === 'preview' ? 'none' : 'block';
        }
    });
}

// 插入 Markdown 語法到指定欄位
function insertMarkdownToField(fieldId, syntax) {
    const textarea = document.getElementById(fieldId);
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    let cursorOffset = 0;
    
    if (syntax === '**' || syntax === '*' || syntax === '`') {
        insertText = syntax + selectedText + syntax;
        cursorOffset = syntax.length;
    } else if (syntax.startsWith('#')) {
        insertText = syntax + selectedText;
        cursorOffset = syntax.length;
    } else if (syntax === '- ' || syntax === '1. ') {
        const lines = selectedText.split('\n');
        if (lines.length === 1 && lines[0] === '') {
            insertText = syntax;
            cursorOffset = syntax.length;
        } else {
            insertText = lines.map((line, index) => {
                if (syntax === '1. ') {
                    return `${index + 1}. ${line}`;
                } else {
                    return `- ${line}`;
                }
            }).join('\n');
            cursorOffset = 0;
        }
    } else if (syntax === '[text](url)') {
        insertText = selectedText ? `[${selectedText}](url)` : '[text](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 1;
    } else if (syntax === '![alt](url)') {
        insertText = selectedText ? `![${selectedText}](url)` : '![alt](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 2;
    }
    
    // 替換選中的文字
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    
    // 設置光標位置
    if (selectedText) {
        textarea.setSelectionRange(start + cursorOffset, start + insertText.length - (syntax === '**' || syntax === '*' || syntax === '`' ? syntax.length : 0));
    } else {
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }
    
    textarea.focus();
    
    // 觸發變更事件
    textarea.dispatchEvent(new Event('input'));
}

// 插入 Markdown 語法到活動欄位 (保留向後兼容)
function insertMarkdownToActiveField(syntax) {
    const textarea = activeTextarea || document.getElementById('test_steps'); // 預設使用 test_steps
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let insertText = '';
    let cursorOffset = 0;
    
    if (syntax === '**' || syntax === '*' || syntax === '`') {
        insertText = syntax + selectedText + syntax;
        cursorOffset = syntax.length;
    } else if (syntax.startsWith('#')) {
        insertText = syntax + selectedText;
        cursorOffset = syntax.length;
    } else if (syntax === '- ' || syntax === '1. ') {
        const lines = selectedText.split('\n');
        if (lines.length === 1 && lines[0] === '') {
            insertText = syntax;
            cursorOffset = syntax.length;
        } else {
            insertText = lines.map((line, index) => {
                if (syntax === '1. ') {
                    return `${index + 1}. ${line}`;
                } else {
                    return `- ${line}`;
                }
            }).join('\n');
            cursorOffset = 0;
        }
    } else if (syntax === '[text](url)') {
        insertText = selectedText ? `[${selectedText}](url)` : '[text](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 1;
    } else if (syntax === '![alt](url)') {
        insertText = selectedText ? `![${selectedText}](url)` : '![alt](url)';
        cursorOffset = selectedText ? insertText.length - 4 : 2;
    }
    
    // 替換選中的文字
    textarea.value = textarea.value.substring(0, start) + insertText + textarea.value.substring(end);
    
    // 設置光標位置
    if (selectedText) {
        textarea.setSelectionRange(start + cursorOffset, start + insertText.length - (syntax === '**' || syntax === '*' || syntax === '`' ? syntax.length : 0));
    } else {
        textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
    }
    
    textarea.focus();
    
    // 觸發變更事件
    textarea.dispatchEvent(new Event('input'));
}

// 更新特定欄位的 Markdown 預覽
function updateMarkdownPreview(fieldId) {
    if (fieldId) {
        // 更新特定欄位
        updateSingleFieldPreview(fieldId);
    } else {
        // 更新所有欄位
        markdownFields.forEach(id => updateSingleFieldPreview(id));
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 更新單一欄位的預覽
function updateSingleFieldPreview(fieldId) {
    const textarea = document.getElementById(fieldId);
    const previewDiv = document.querySelector(`.markdown-preview[data-target="${fieldId}"]`);
    
    if (!textarea || !previewDiv) return;
    
    const content = textarea.value;
    
    if (typeof marked !== 'undefined') {
        try {
            previewDiv.innerHTML = marked.parse(content);
        } catch (error) {
            const markdownErrorMessage = window.i18n ? window.i18n.t('errors.markdownParseError') : 'Markdown 解析錯誤';
            previewDiv.innerHTML = `<p class="text-muted">${markdownErrorMessage}</p>`;
        }
    } else {
        // 簡單的 Markdown 轉換
        let html = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto;">')
            .replace(/\n/g, '<br>');
        
        const previewPlaceholder = window.i18n ? window.i18n.t('messages.previewDisplayHere') : '預覽將在此顯示...';
        previewDiv.innerHTML = html || `<p class="text-muted">${previewPlaceholder}</p>`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 附件管理功能
// 全域變數來儲存上傳的附件
let uploadedAttachments = [];

function handleAttachmentUpload(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // 驗證檔案
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) { // 10MB 限制
            const fileSizeLimitMessage = window.i18n ? window.i18n.t('errors.fileSizeLimit') : '檔案超過10MB大小限制';
            showError(`檔案 "${file.name}" ${fileSizeLimitMessage}`);
            return;
        }
    }
    
    // 顯示上傳中狀態
    const attachmentsList = document.getElementById('attachmentsList');
    const uploadingHtml = Array.from(files).map(file => `
        <div class="attachment-item d-flex align-items-center justify-content-between p-2 border rounded mb-2">
            <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-muted"></i>
                <span>${file.name}</span>
                <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
            </div>
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">上傳中...</span>
            </div>
        </div>
    `).join('');
    
    attachmentsList.innerHTML = uploadingHtml;
    
    // 實際上傳檔案到伺服器
    uploadFilesToServer(Array.from(files));
}

async function uploadFilesToServer(files) {
    const currentTeam = AppUtils.getCurrentTeam();
    if (!currentTeam || !currentTeam.id) {
        showError(window.i18n ? window.i18n.t('errors.pleaseSelectTeam') : '請先選擇團隊');
        return;
    }
    
    const attachmentsList = document.getElementById('attachmentsList');
    const uploadedFiles = [];
    let totalFiles = files.length;
    let completedFiles = 0;
    
    try {
        // 顯示上傳進度區域
        attachmentsList.innerHTML = `
            <div class="upload-progress-container mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">正在上傳附件...</span>
                    <span class="text-muted">${completedFiles}/${totalFiles}</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">請稍等，正在處理您的檔案</small>
                </div>
            </div>
        `;
        
        const progressBar = attachmentsList.querySelector('.progress-bar');
        const progressText = attachmentsList.querySelector('span.text-muted');
        
        // 逐個上傳檔案並顯示進度
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // 更新當前上傳的檔案名稱
            const statusText = attachmentsList.querySelector('.mt-2 small');
            const uploadingMessage = window.i18n ? window.i18n.t('messages.uploadingFile') : '正在上傳';
            statusText.textContent = `${uploadingMessage}: ${file.name}`;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`/api/attachments/teams/${currentTeam.id}/upload-file-token`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // 立即附加到測試案例記錄
                    const currentRecordId = getCurrentRecordId();
                    if (currentRecordId) {
                        const statusText = attachmentsList.querySelector('.mt-2 small');
                        const attachingMessage = window.i18n ? window.i18n.t('messages.attachingFile') : '正在附加';
                        statusText.textContent = `${attachingMessage}: ${file.name}`;
                        
                        const attachFormData = new FormData();
                        attachFormData.append('file_token', result.file_token);
                        attachFormData.append('field_name', 'Attachment');
                        attachFormData.append('append', 'true');
                        
                        const attachResponse = await fetch(`/api/attachments/teams/${currentTeam.id}/testcases/${currentRecordId}/attach-token`, {
                            method: 'POST',
                            body: attachFormData
                        });
                        
                        if (attachResponse.ok) {
                            const attachResult = await attachResponse.json();
                            console.log(`附件 ${file.name} 已成功附加到記錄`);
                            
                            // 加到本地數組以供顯示
                            uploadedFiles.push({
                                file_token: result.file_token,
                                name: result.file_name,
                                size: result.file_size,
                                type: file.type || 'application/octet-stream'
                            });
                            
                            // 同時更新原始資料中的附件
                            const testCaseIndex = testCases.findIndex(tc => tc.record_id === currentRecordId);
                            if (testCaseIndex !== -1) {
                                if (!testCases[testCaseIndex].attachments) {
                                    testCases[testCaseIndex].attachments = [];
                                }
                                testCases[testCaseIndex].attachments.push({
                                    file_token: result.file_token,
                                    name: result.file_name,
                                    size: result.file_size,
                                    type: file.type || 'application/octet-stream'
                                });
                            }
                            
                            // 更新 filteredTestCases
                            const filteredIndex = filteredTestCases.findIndex(tc => tc.record_id === currentRecordId);
                            if (filteredIndex !== -1) {
                                if (!filteredTestCases[filteredIndex].attachments) {
                                    filteredTestCases[filteredIndex].attachments = [];
                                }
                                filteredTestCases[filteredIndex].attachments.push({
                                    file_token: result.file_token,
                                    name: result.file_name,
                                    size: result.file_size,
                                    type: file.type || 'application/octet-stream'
                                });
                            }
                        } else {
                            const attachError = await attachResponse.json();
                            throw new Error(`附加檔案失敗: ${attachError.detail || '未知錯誤'}`);
                        }
                    } else {
                        throw new Error('無法取得當前記錄ID，無法附加檔案');
                    }
                    
                    completedFiles++;
                    
                    // 更新進度條
                    const progress = (completedFiles / totalFiles) * 100;
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    if (progressText) {
                        progressText.textContent = `${completedFiles}/${totalFiles}`;
                    }
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `上傳 "${file.name}" 失敗`);
                }
            } catch (fileError) {
                console.error(`上傳檔案 ${file.name} 失敗:`, fileError);
                // 繼續上傳其他檔案，但記錄錯誤
                const uploadFailedMessage = window.i18n ? window.i18n.t('errors.uploadFailed') : '上傳失敗';
                showError(`${uploadFailedMessage} "${file.name}": ${fileError.message}`);
            }
        }
        
        // 將上傳成功的檔案加到全域變數
        uploadedAttachments = uploadedAttachments.concat(uploadedFiles);
        
        // 更新附件列表顯示
        renderAttachmentsList();
        
        if (uploadedFiles.length > 0) {
            const attachmentsUploadedMessage = window.i18n ? 
                window.i18n.t('messages.attachmentsUploaded', {count: uploadedFiles.length}) : 
                `成功上傳並附加 ${uploadedFiles.length} 個附件`;
            showSuccess(attachmentsUploadedMessage);
            // 注意：現在不需要觸發表單變更檢查，因為附件已經立即附加到記錄
        }
        
    } catch (error) {
        console.error('上傳附件過程發生錯誤:', error);
        const uploadAttachmentFailedMessage = window.i18n ? window.i18n.t('errors.uploadAttachmentFailed') : '上傳附件失敗';
        showError(uploadAttachmentFailedMessage + '：' + error.message);
        
        // 上傳失敗時顯示錯誤狀態
        attachmentsList.innerHTML = `
            <div class="alert alert-danger d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>附件上傳失敗，請重試</div>
            </div>
        `;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function renderAttachmentsList() {
    const attachmentsList = document.getElementById('attachmentsList');
    if (!uploadedAttachments || uploadedAttachments.length === 0) {
        const noAttachmentsMessage = window.i18n ? window.i18n.t('errors.noAttachments') : '尚無附件';
        attachmentsList.innerHTML = `<p class="text-muted small mb-0">${noAttachmentsMessage}</p>`;
        return;
    }
    
    const attachmentsHtml = uploadedAttachments.map((attachment, index) => `
        <div class="attachment-item d-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-light">
            <div class="d-flex align-items-center">
                <i class="fas fa-file me-2 text-primary"></i>
                <div>
                    <div class="fw-medium">${attachment.name}</div>
                    <div class="small text-muted">${formatFileSize(attachment.size || 0)}</div>
                </div>
            </div>
            <div>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeAttachment('${attachment.file_token}', '${attachment.name}', ${index})" data-i18n-title="tooltips.removeAttachment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    attachmentsList.innerHTML = `
        <div class="attachments-header mb-2">
            <h6 class="mb-0 text-secondary">${window.i18n ? window.i18n.t('form.uploadedAttachments') : '已上傳的附件'} (${uploadedAttachments.length})</h6>
        </div>
        ${attachmentsHtml}
    `;
}

function removeAttachment(index) {
    uploadedAttachments.splice(index, 1);
    renderAttachmentsList();
    checkFormChanges(); // 觸發表單變更檢查
}

// 格式化檔案大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 下載附件
function downloadAttachment(filename) {
    // 實際應該呼叫 API 來下載檔案
    console.log(`下載附件: ${filename}`);
}

// 移除附件
async function removeAttachment(fileToken, filename, index) {
    const confirmMessage = window.i18n ? 
        window.i18n.t('confirm.deleteAttachment', {filename: filename}) : 
        `確定要刪除附件 "${filename}" 嗎？`;
    if (confirm(confirmMessage)) {
        try {
            console.log(`正在刪除附件: ${filename}...`);
            
            // 取得當前記錄的 ID
            const currentRecordId = getCurrentRecordId();
            if (!currentRecordId) {
                throw new Error('無法取得當前記錄 ID');
            }
            
            // 呼叫後端 API 刪除附件
            const response = await fetch(`/api/attachments/teams/1/testcases/${currentRecordId}/attachments/${fileToken}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '刪除附件失敗');
            }
            
            const result = await response.json();
            
            if (result.success) {
                // 從本地陣列中移除
                uploadedAttachments.splice(index, 1);
                
                // 同時更新原始 testCases 資料中的附件資訊
                const currentRecordId = getCurrentRecordId();
                if (currentRecordId) {
                    // 更新 testCases 陣列中對應記錄的附件
                    const testCaseIndex = testCases.findIndex(tc => tc.record_id === currentRecordId);
                    if (testCaseIndex !== -1) {
                        if (!testCases[testCaseIndex].attachments) {
                            testCases[testCaseIndex].attachments = [];
                        }
                        // 從原始資料中移除該附件
                        testCases[testCaseIndex].attachments = testCases[testCaseIndex].attachments.filter(
                            att => att.file_token !== fileToken
                        );
                    }
                    
                    // 同時更新 filteredTestCases 中的資料
                    const filteredIndex = filteredTestCases.findIndex(tc => tc.record_id === currentRecordId);
                    if (filteredIndex !== -1) {
                        if (!filteredTestCases[filteredIndex].attachments) {
                            filteredTestCases[filteredIndex].attachments = [];
                        }
                        filteredTestCases[filteredIndex].attachments = filteredTestCases[filteredIndex].attachments.filter(
                            att => att.file_token !== fileToken
                        );
                    }
                }
                
                // 重新渲染附件列表
                renderAttachmentsList();
                const attachmentDeletedMessage = window.i18n ? 
                    window.i18n.t('messages.attachmentDeleted') : '已成功刪除附件';
                showSuccess(`${attachmentDeletedMessage}: ${filename}`);
            } else {
                throw new Error(result.message || '刪除附件失敗');
            }
            
        } catch (error) {
            console.error('刪除附件錯誤:', error);
            const attachmentDeleteFailedMessage = window.i18n ? window.i18n.t('errors.attachmentDeleteFailed') : '刪除附件失敗';
            showError(`${attachmentDeleteFailedMessage}: ${error.message}`);
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 重置 modal 內所有滾動位置的輔助函數
function resetModalScrollPositions(modal) {
    // 立即重置主要滾動容器
    const modalBody = modal.querySelector('.modal-body');
    if (modalBody) {
        modalBody.scrollTop = 0;
    }
    
    const scrollableContent = modal.querySelector('.scrollable-content');
    if (scrollableContent) {
        scrollableContent.scrollTop = 0;
    }
    
    // 重置所有 textarea 和其他可滾動元素
    const textareas = modal.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.scrollTop = 0;
    });
    
    // 重置所有 markdown 預覽區域
    const markdownPreviews = modal.querySelectorAll('.markdown-preview');
    markdownPreviews.forEach(preview => {
        preview.scrollTop = 0;
    });
    
    // 重置任何其他可能的滾動容器
    const scrollableElements = modal.querySelectorAll('[style*="overflow-y: auto"], .overflow-auto');
    scrollableElements.forEach(el => {
        el.scrollTop = 0;
    });
}

// 取得當前記錄 ID 的輔助函數
function getCurrentRecordId() {
    // 從 modal 或其他地方取得當前記錄的 ID
    const modal = document.getElementById('testCaseModal');
    if (modal && modal.dataset.recordId) {
        return modal.dataset.recordId;
    }
    
    // 如果沒有 modal，可能在其他地方，需要根據實際情況調整
    const recordIdElement = document.querySelector('[data-record-id]');
    if (recordIdElement) {
        return recordIdElement.dataset.recordId;
    }
    
    return null;
}

// Modal TCG 編輯功能
let currentModalTCGEditor = null;

async function editModalTCG() {
    const container = document.getElementById('modalTCGContainer');
    if (!container) return;
    
    // 如果已經在編輯中，直接返回
    if (currentModalTCGEditor) return;
    
    // 獲取當前 TCG 值
    const tcgInput = document.getElementById('tcg');
    const currentTCGText = tcgInput ? tcgInput.value : '';
    const currentTCGs = currentTCGText ? currentTCGText.split(', ').filter(t => t.trim()) : [];
    
    // 設置編輯器狀態
    currentModalTCGEditor = {
        container: container,
        originalTCGs: [...currentTCGs],
        currentTCGs: [...currentTCGs],
        originalContent: container.innerHTML
    };
    
    // 直接進入搜尋模式
    startModalTCGSearch();
}

async function startModalTCGSearch() {
    if (!currentModalTCGEditor) return;
    
    const { container, currentTCGs } = currentModalTCGEditor;
    
    // 顯示搜尋框
    const searchHtml = `
        <div class="tcg-modal-search-container position-relative" style="width: 100%;">
            <input type="text" class="form-control tcg-modal-search-input" 
                   data-i18n-placeholder="testCase.tcgPlaceholder" autocomplete="off" 
                   onkeydown="handleModalTCGSearchKeydown(event)" 
                   oninput="handleModalTCGSearchInput(event)"
                   onclick="event.stopPropagation()"
                   style="width: 100%;">
            <div class="tcg-modal-dropdown" 
                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; background: white; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 0.375rem 0.375rem; max-height: 200px; overflow-y: auto;">
                <div class="p-2 text-muted small">開始輸入以搜尋 TCG...</div>
            </div>
        </div>
    `;
    
    container.innerHTML = searchHtml;
    container.classList.add('editing');
    
    // 聚焦搜尋框
    const searchInput = container.querySelector('.tcg-modal-search-input');
    searchInput.focus();
    
    // 立即載入 TCG 選項
    await searchModalTCGOptions('');
    const dropdown = container.querySelector('.tcg-modal-dropdown');
    if (dropdown) {
        dropdown.style.display = 'block';
    }
    
    // 添加點擊外部結束編輯的監聽器
    setTimeout(() => {
        document.addEventListener('click', handleModalTCGOutsideClick, true);
    }, 100);
}

function handleModalTCGOutsideClick(event) {
    if (!currentModalTCGEditor) return;
    
    const { container } = currentModalTCGEditor;
    
    // 檢查點擊是否在編輯區域外
    if (!container.contains(event.target)) {
        finishModalTCGEdit();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function finishModalTCGEdit() {
    if (!currentModalTCGEditor) return;
    
    const { container, currentTCGs, originalTCGs } = currentModalTCGEditor;
    
    // 移除全域點擊監聽器
    document.removeEventListener('click', handleModalTCGOutsideClick, true);
    
    // 更新隱藏的 input 值 (為了向後兼容)
    const tcgInput = document.getElementById('tcg');
    if (tcgInput) {
        tcgInput.value = currentTCGs.join(', ');
    }
    
    // 更新顯示
    container.classList.remove('editing');
    updateModalTCGDisplay(container, currentTCGs);
    
    // 清除編輯器狀態
    currentModalTCGEditor = null;
    
    // 觸發表單變更檢查
    checkFormChanges();
}

function updateModalTCGDisplay(container, tcgs) {
    if (tcgs.length === 0) {
        const clickToEditMessage = window.i18n ? window.i18n.t('errors.clickToEditTcg') : '點擊編輯 TCG';
        container.innerHTML = `<span class="text-muted">${clickToEditMessage}</span>`;
    } else {
        container.innerHTML = tcgs.join(', ');
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

async function searchModalTCGOptions(keyword) {
    if (!currentModalTCGEditor) return;
    
    const container = currentModalTCGEditor.container;
    const dropdown = container.querySelector('.tcg-modal-dropdown');
    if (!dropdown) return;
    
    try {
        // 使用相同的 TCG 搜尋邏輯
        const results = searchTCGFromCache(keyword, 20);
        
        if (results.length === 0) {
            dropdown.innerHTML = `
                <div class="p-2 text-muted small">沒有找到匹配的 TCG</div>
                ${currentModalTCGEditor.currentTCGs.length > 0 ? 
                  `<div class="p-2 border-top">
                     <button class="btn btn-sm btn-outline-danger" onclick="clearModalTCG()">清除目前選擇</button>
                   </div>` : ''}
            `;
        } else {
            const optionsHtml = results.map(tcg => {
                const isSelected = currentModalTCGEditor.currentTCGs.includes(tcg.tcg_number);
                return `
                    <div class="tcg-modal-option p-2 d-flex justify-content-between align-items-center" 
                         style="cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                         onclick="selectModalTCG('${tcg.tcg_number}')"
                         onmouseover="this.style.backgroundColor='#f8f9fa'" 
                         onmouseout="this.style.backgroundColor='white'">
                        <div>
                            <strong class="text-primary">${tcg.tcg_number}</strong>
                        </div>
                        ${isSelected ? '<i class="fas fa-check text-success"></i>' : ''}
                    </div>
                `;
            }).join('');
            
            dropdown.innerHTML = optionsHtml + `
                <div class="p-2 border-top">
                    <small class="text-muted">
                        找到 ${results.length} 個結果
                        ${currentModalTCGEditor.currentTCGs.length > 0 ? 
                          `<button class="btn btn-sm btn-outline-danger ms-2" onclick="clearModalTCG()">清除目前選擇</button>` : ''}
                    </small>
                </div>
            `;
        }
    } catch (error) {
        console.error('搜尋 TCG 失敗:', error);
        const searchFailedRetryMessage = window.i18n ? window.i18n.t('errors.searchFailedRetry') : '搜尋失敗，請重試';
        dropdown.innerHTML = `<div class="p-2 text-danger small">${searchFailedRetryMessage}</div>`;
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function handleModalTCGSearchKeydown(event) {
    if (event.key === 'Escape') {
        finishModalTCGEdit();
    } else if (event.key === 'Enter') {
        event.preventDefault();
        // Enter 直接選擇第一個結果
        const firstOption = document.querySelector('.tcg-modal-option');
        if (firstOption) {
            firstOption.click();
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function handleModalTCGSearchInput(event) {
    const keyword = event.target.value;
    searchModalTCGOptions(keyword);
}

function selectModalTCG(tcgNumber) {
    if (!currentModalTCGEditor) return;
    
    // 單選模式：只選擇一個 TCG
    currentModalTCGEditor.currentTCGs = [tcgNumber];
    
    // 完成編輯
    finishModalTCGEdit();
}

function clearModalTCG() {
    if (!currentModalTCGEditor) return;
    
    // 清空選擇
    currentModalTCGEditor.currentTCGs = [];
    
    // 完成編輯
    finishModalTCGEdit();
}

function clearModalTCGDirect(event) {
    event.preventDefault(); // 阻止右鍵選單
    event.stopPropagation(); // 阻止冒泡
    
    // 清空新的 TCG 輸入框
    const modalTCGInput = document.getElementById('modalTCGInput');
    const tcgInput = document.getElementById('tcg');
    
    if (modalTCGInput) {
        modalTCGInput.value = '';
    }
    if (tcgInput) {
        tcgInput.value = '';
    }
    
    // 隱藏下拉選單
    hideTCGDropdown();
    checkFormChanges();
}

// 新的 type-to-search 支援函數
function handleTCGSearch(input) {
    const keyword = input.value.trim();
    const dropdown = document.getElementById('modalTCGDropdown');
    
    if (!dropdown) return;
    
    if (keyword.length < 1) {
        // 顯示熱門 TCG
        showPopularTCG();
        return;
    }
    
    // 搜尋 TCG
    const results = searchTCGFromCache(keyword, 10);
    updateTCGDropdown(results);
    showTCGDropdown();
}

function showTCGDropdown() {
    const dropdown = document.getElementById('modalTCGDropdown');
    if (!dropdown) return;
    
    dropdown.style.display = 'block';
    
    // 如果沒有內容，顯示熱門 TCG
    if (dropdown.innerHTML.trim() === '') {
        showPopularTCG();
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

function hideTCGDropdown() {
    // 延遲隱藏，允許點擊選項
    setTimeout(() => {
        const dropdown = document.getElementById('modalTCGDropdown');
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }, 150);
}

function showPopularTCG() {
    const results = searchTCGFromCache('', 10); // 取前 10 個
    updateTCGDropdown(results);
}

function updateTCGDropdown(results) {
    const dropdown = document.getElementById('modalTCGDropdown');
    if (!dropdown) return;
    
    if (results.length === 0) {
        const noTcgMatchesMessage = window.i18n ? window.i18n.t('errors.noTcgMatches') : '找不到匹配的 TCG';
        dropdown.innerHTML = `<div class="p-2 text-muted">${noTcgMatchesMessage}</div>`;
        return;
    }
    
    const html = results.map(tcg => `
        <div class="dropdown-item-custom p-2 border-bottom" 
             onclick="selectTCG('${tcg.tcg_number}', '${tcg.title || ''}')" 
             style="cursor: pointer; transition: background-color 0.2s;"
             onmouseover="this.style.backgroundColor='#f8f9fa'"
             onmouseout="this.style.backgroundColor='white'">
            <div class="fw-bold">${tcg.tcg_number}</div>
        </div>
    `).join('');
    
    dropdown.innerHTML = html;
}

function selectTCG(tcgNumber, title) {
    const modalTCGInput = document.getElementById('modalTCGInput');
    const tcgInput = document.getElementById('tcg');
    
    if (modalTCGInput) {
        modalTCGInput.value = tcgNumber;
    }
    if (tcgInput) {
        tcgInput.value = tcgNumber;
    }
    
    hideTCGDropdown();
    checkFormChanges();
}

// 計算動態高度
function calculateDynamicHeights() {
    const modal = document.getElementById('testCaseModal');
    const modalContent = modal.querySelector('.modal-content');
    const fixedSection = modal.querySelector('.fixed-section');
    const fixedButtons = modal.querySelector('.fixed-buttons');
    const scrollableContent = modal.querySelector('.scrollable-content');
    
    // 取得視窗高度
    const viewportHeight = window.innerHeight;
    
    // 設定模態框高度為視窗高度的 90%
    const modalHeight = Math.floor(viewportHeight * 0.9);
    const modalDialog = modal.querySelector('.modal-dialog');
    modalDialog.style.height = modalHeight + 'px';
    modalDialog.style.maxHeight = modalHeight + 'px';
    
    // 等待DOM更新後計算
    setTimeout(() => {
        // 計算固定區域高度
        const modalHeader = modal.querySelector('.modal-header');
        const headerHeight = modalHeader ? modalHeader.offsetHeight : 0;
        const fixedSectionHeight = fixedSection ? fixedSection.offsetHeight : 0;
        const fixedButtonsHeight = fixedButtons ? fixedButtons.offsetHeight : 0;
        
        // 計算可滾動內容區域的可用高度
        const availableHeight = modalHeight - headerHeight - fixedSectionHeight - fixedButtonsHeight - 2; // 2px for borders
        
        if (scrollableContent) {
            scrollableContent.style.height = availableHeight + 'px';
            scrollableContent.style.maxHeight = availableHeight + 'px';
        }
        
        // 根據可用空間決定是否需要滾動
        if (scrollableContent) {
            const contentHeight = scrollableContent.scrollHeight;
            if (contentHeight <= availableHeight) {
                // 內容夠小，不需要滾動
                scrollableContent.style.overflowY = 'hidden';
            } else {
                // 內容太大，需要滾動
                scrollableContent.style.overflowY = 'auto';
            }
        }
    }, 100);
}

// 監聽視窗大小變化
window.addEventListener('resize', function() {
    const modal = document.getElementById('testCaseModal');
    if (modal && modal.classList.contains('show')) {
        calculateDynamicHeights();
    }
    // 視窗尺寸改變時，調整列表高度
    adjustTestCasesScrollHeight();
});

// 更新導航按鈕狀態
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevTestCaseBtn');
    const nextBtn = document.getElementById('nextTestCaseBtn');
    
    if (currentTestCaseIndex === -1 || filteredTestCases.length <= 1) {
        // 新增模式或只有一筆資料時，隱藏導航按鈕
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'inline-block';
        nextBtn.style.display = 'inline-block';
        
        // 第一筆時，上一隻按鈕反灰
        if (currentTestCaseIndex === 0) {
            prevBtn.disabled = true;
            prevBtn.classList.add('disabled');
        } else {
            prevBtn.disabled = false;
            prevBtn.classList.remove('disabled');
        }
        
        // 最後一筆時，下一隻按鈕反灰
        if (currentTestCaseIndex === filteredTestCases.length - 1) {
            nextBtn.disabled = true;
            nextBtn.classList.add('disabled');
        } else {
            nextBtn.disabled = false;
            nextBtn.classList.remove('disabled');
        }
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 顯示上一隻測試案例
function showPrevTestCase() {
    if (currentTestCaseIndex > 0) {
        const prevTestCase = filteredTestCases[currentTestCaseIndex - 1];
        showTestCaseModal(prevTestCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 只讓 Test Case 列表區域可滾動：依據可視高度調整列表容器高度
function adjustTestCasesScrollHeight() {
    try {
        const scrollBox = document.getElementById('testCasesScroll');
        if (!scrollBox) return;
        const nav = document.getElementById('testCasesPagination');
        const ul = document.getElementById('pagination');
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const rect = scrollBox.getBoundingClientRect();
        const top = rect.top; // 距離視窗頂部
        const paginationHeight = (nav ? nav.getBoundingClientRect().height : (ul ? ul.getBoundingClientRect().height : 0));
        const gap = 16; // 與下方的間距緩衝
        let available = viewportHeight - top - paginationHeight - gap;
        if (available < 200) available = 200; // 設置最小高度
        scrollBox.style.maxHeight = available + 'px';
        scrollBox.style.height = available + 'px';
        scrollBox.style.overflowY = 'auto';
        // 避免 sticky 分頁覆蓋列表最後一行，預留底部內距
        scrollBox.style.paddingBottom = (paginationHeight + gap) + 'px';
    } catch (e) {
        console.warn('adjustTestCasesScrollHeight failed:', e);
    }
}

// 顯示下一隻測試案例
function showNextTestCase() {
    if (currentTestCaseIndex < filteredTestCases.length - 1) {
        const nextTestCase = filteredTestCases[currentTestCaseIndex + 1];
        showTestCaseModal(nextTestCase);
    }
    // 工具列顯示狀態可能改變整體高度，需重新計算列表高度
    adjustTestCasesScrollHeight();
}

// 更新頁面標題翻譯
function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('testCase.management') : '測試案例管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// 監聽 i18n 初始化和語言變更事件
document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);
</script>
{% endblock %}
