{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.execution') if i18n else 'Test Run 執行' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script>
// Configure marked to treat single newlines as <br> so previews show line breaks
if (window.marked && typeof window.marked.setOptions === 'function') {
    window.marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
    });
}
</script>

<!-- Test Run 執行頁面樣式 -->
<style>
/* Test Run 執行頁面整體布局 */
.test-run-execution {
    height: calc(100vh - 140px);
    display: flex;
    flex-direction: column;
}

/* 移除狀態指示器和控制按鈕樣式（已移至 header） */

/* 統計資訊樣式 */
.execution-stats {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.stat-item {
    background: var(--tr-bg-light);
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid var(--tr-border-light);
    min-width: 120px;
    text-align: center;
}

.stat-number {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--tr-primary);
    line-height: 1.2;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--tr-text-muted);
    line-height: 1.2;
}

/* Test Run Items 表格樣式 */
.test-run-items-container {
    flex: 1;
    overflow: hidden;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.375rem;
}

.test-run-items-table {
    height: 100%;
    overflow-y: auto;
}

.test-run-items-table table {
    margin-bottom: 0;
}

.test-run-items-table th {
    position: sticky;
    top: 0;
    background: var(--tr-bg-sidebar);
    z-index: 10;
    border-bottom: 2px solid var(--tr-border);
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    font-weight: 600;
    white-space: nowrap; /* 防止標頭折行 */
}

.test-run-items-table td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

/* 表格欄位寬度標準化 */
.test-run-items-table th:nth-child(1), 
.test-run-items-table td:nth-child(1) { /* checkbox */
    width: 25px;
    min-width: 25px;
    text-align: center;
    padding: 0.5rem 0.25rem;
}

.test-run-items-table th:nth-child(2), 
.test-run-items-table td:nth-child(2) { /* 案例編號 */
    width: 170px;
    min-width: 170px;
    text-align: left;
}

.test-run-items-table th:nth-child(3), 
.test-run-items-table td:nth-child(3) { /* 標題 */
    min-width: 200px;
    text-align: left;
}

.test-run-items-table th:nth-child(4), 
.test-run-items-table td:nth-child(4) { /* 優先級 */
    width: 120px;
    min-width: 120px;
    text-align: center;
}

.test-run-items-table th:nth-child(5), 
.test-run-items-table td:nth-child(5) { /* 測試結果 */
    width: 170px;
    min-width: 170px;
    text-align: center;
}

.test-run-items-table th:nth-child(6), 
.test-run-items-table td:nth-child(6) { /* 執行者 */
    width: 175px;
    min-width: 175px;
    text-align: center;
}

.test-run-items-table th:nth-child(7), 
.test-run-items-table td:nth-child(7) { /* 執行時間 */
    width: 160px;
    min-width: 160px;
    text-align: center;
}

.test-run-items-table th:nth-child(8), 
.test-run-items-table td:nth-child(8) { /* 操作 */
    width: 100px;
    min-width: 100px;
    text-align: center;
}

/* 測試結果選擇器樣式 */
.result-selector {
    min-width: 140px;
}

.result-selector select {
    border: none;
    background: transparent;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

/* 大尺寸測試結果選擇器 */
.result-selector-lg {
    min-width: 150px;
    text-align: center; /* 讓容器內文字置中（對部分瀏覽器有幫助） */
}

.result-selector-lg select {
    font-size: 0.95rem;
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.25rem;
    text-align: center;           /* 置中文本 */
    text-align-last: center;      /* 大多數瀏覽器對齊選中項 */
    -moz-text-align-last: center; /* Firefox 專用前綴 */
}

/* 作為回退，讓下拉選項本身也置中 */
.result-selector-lg select option {
    text-align: center;
}

/* 大尺寸優先級 badge */
.priority-badge-lg {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
}

/* 大尺寸測試結果 badge */
.result-badge-lg {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
    display: inline-block;        /* 讓寬度可控制並可置中內容 */
    text-align: center;           /* 置中文本 */
    min-width: 140px;             /* 與下拉寬度接近，視覺對齊 */
}

/* 執行者編輯器樣式 */
.assignee-editor {
    border: 1px solid transparent;
    background: transparent;
    transition: all 0.2s ease;
    text-align: center;
    width: 100%;
}

.assignee-editor:hover {
    border-color: var(--tr-border-light);
    background: var(--tr-bg-light);
}

.assignee-editor:focus {
    border-color: var(--tr-primary);
    background: white;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
}

.result-passed { color: var(--tr-success-dark); background: var(--tr-success-light); }
.result-failed { color: var(--tr-danger-dark); background: var(--tr-danger-light); }
.result-retest { color: var(--tr-warning-dark); background: var(--tr-warning-light); }
.result-na { color: var(--tr-secondary-dark); background: var(--tr-secondary-light); }
.result-pending { color: var(--tr-text-muted); background: var(--tr-bg-light); }

/* 操作按鈕樣式 */
.item-actions {
    display: flex;
    gap: 0.25rem;
}

.btn-icon-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* 可點擊項目樣式 */
.test-run-items-table a {
    color: var(--tr-primary);
    cursor: pointer;
}

.test-run-items-table a:hover {
    color: var(--tr-primary-dark, #0056b3);
    text-decoration: underline !important;
}

.test-run-items-table code a {
    color: inherit;
}

.test-run-items-table code a:hover {
    color: var(--tr-primary);
}

/* 表格行 hover 效果優化 */
.test-run-items-table tbody tr:hover {
    background-color: var(--tr-bg-light, #f8f9fa);
    transition: background-color 0.15s ease-in-out;
}

/* 表格整體美化 */
.test-run-items-table table {
    border-collapse: separate;
    border-spacing: 0;
}

.test-run-items-table th:first-child {
    border-top-left-radius: 0.375rem;
}

.test-run-items-table th:last-child {
    border-top-right-radius: 0.375rem;
}

/* Checkbox 欄位狀態控制 */
.checkbox-cell {
    width: 25px !important;
    padding: 0.5rem 0.25rem !important;
}

/* 隱藏 checkbox 欄位的樣式（completed 狀態） */
.test-run-items-table.hide-checkbox #checkbox-header,
.test-run-items-table.hide-checkbox .checkbox-cell {
    display: none !important;
}

/* 批次操作工具區樣式 */
#batchOperationsToolbar {
    background: rgba(13, 110, 253, 0.1);
    border: 1px solid rgba(13, 110, 253, 0.2);
    border-radius: 0.375rem;
    padding: 0.5rem 1rem;
    white-space: nowrap;
}

/* 響應式調整 */
@media (max-width: 768px) {
    .execution-stats {
        justify-content: center;
    }
    
    .stat-item {
        min-width: 100px;
    }
    
    /* 小螢幕時批次操作區域換行顯示 */
    .d-flex.flex-wrap.gap-3.align-items-center {
        flex-direction: column;
        align-items: stretch !important;
        gap: 1rem !important;
    }
    
    #batchOperationsToolbar {
        justify-content: center;
    }
    
    /* 小螢幕時隱藏部分欄位 */
    .test-run-items-table th:nth-child(7),
    .test-run-items-table td:nth-child(7),
    .test-run-items-table th:nth-child(8),
    .test-run-items-table td:nth-child(8) {
        display: none;
    }
}
/* Test Case 詳細資料 Modal 內部固定與捲動區域 */
#testCaseDetailModal .modal-dialog { max-height: 95vh; }
#testCaseDetailModal .modal-content { display: flex; max-height: 95vh; }
#testCaseDetailModal .modal-body { display: flex; flex-direction: column; overflow: hidden; }
#testCaseDetailFixed { flex: 0 0 auto; }
#testCaseDetailScrollable { flex: 1 1 auto; overflow-y: auto; min-height: 0; max-height: 100%; }

/* Timeline 樣式 */
.timeline-item { position: relative; padding-left: 1rem; margin-bottom: 0.75rem; }
.timeline-item::before { content: ''; position: absolute; left: 0.38rem; top: 0.2rem; width: 8px; height: 8px; border-radius: 50%; background-color: var(--tr-primary, #0d6efd); }
.timeline-item .time { font-size: 0.75rem; color: var(--tr-text-muted); }
.timeline-item .status { font-size: 0.85rem; font-weight: 500; }
.timeline-divider { height: 1px; background: var(--tr-border-light); margin: 0.25rem 0 0.5rem; }

/* 淡色區塊配色（保留配色，不影響捲動） */
.section-block { padding: 0.75rem; border-radius: 0.375rem; border: 1px solid var(--tr-border-light); }
.section-precondition { background: rgba(13, 110, 253, 0.06); border-color: rgba(13, 110, 253, 0.2); }
.section-steps { background: rgba(255, 193, 7, 0.08); border-color: rgba(255, 193, 7, 0.25); }
.section-expected { background: rgba(25, 135, 84, 0.08); border-color: rgba(25, 135, 84, 0.25); }
/* 僅內容可捲動：限制內容高度，讓外框固定 */
/* 外框（#testCaseDetailScrollable）負責捲動；內容區塊不產生次級卷軸 */
.section-attachments { background: rgba(108, 117, 125, 0.06); border-color: rgba(108, 117, 125, 0.25); }

/* Markdown 內容樣式（Test Case Detail Modal） */
#testCaseDetailModal .markdown-preview {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}
#testCaseDetailModal .markdown-preview h1,
#testCaseDetailModal .markdown-preview h2,
#testCaseDetailModal .markdown-preview h3,
#testCaseDetailModal .markdown-preview h4,
#testCaseDetailModal .markdown-preview h5,
#testCaseDetailModal .markdown-preview h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}
#testCaseDetailModal .markdown-preview h1 { font-size: 1.4rem; }
#testCaseDetailModal .markdown-preview h2 { font-size: 1.2rem; }
#testCaseDetailModal .markdown-preview h3 { font-size: 1.05rem; }
#testCaseDetailModal .markdown-preview h4 { font-size: 0.95rem; }
#testCaseDetailModal .markdown-preview h5 { font-size: 0.9rem; }
#testCaseDetailModal .markdown-preview h6 { font-size: 0.85rem; }
#testCaseDetailModal .markdown-preview ul,
#testCaseDetailModal .markdown-preview ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}
#testCaseDetailModal .markdown-preview code {
    background-color: var(--tr-bg-sidebar);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}
#testCaseDetailModal .markdown-preview pre {
    background-color: var(--tr-bg-sidebar);
    padding: 0.75rem;
    border-radius: 0.375rem;
    overflow-x: auto;
}
#testCaseDetailModal .markdown-preview pre code {
    background: none;
    padding: 0;
}
#testCaseDetailModal .markdown-preview a {
    color: var(--tr-primary);
    text-decoration: none;
}
#testCaseDetailModal .markdown-preview a:hover {
    text-decoration: underline;
}
#testCaseDetailModal .markdown-preview blockquote {
    border-left: 4px solid var(--tr-primary);
    margin: 1rem 0;
    padding-left: 1rem;
    color: var(--tr-text-muted);
}
#testCaseDetailModal .markdown-preview table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
}
#testCaseDetailModal .markdown-preview th,
#testCaseDetailModal .markdown-preview td {
    border: 1px solid var(--tr-border-light);
    padding: 0.5rem;
    text-align: left;
}
#testCaseDetailModal .markdown-preview th {
    background-color: var(--tr-bg-light);
    font-weight: 600;
}
</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.execution">Test Run 執行</span>
{% endblock %}

{% block page_subtitle_text %}
<span id="test-run-subtitle" data-i18n="testRun.executeTestRun">執行測試案例並記錄結果</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-success" id="startBtn" style="display: none;">
        <i class="fas fa-play me-2"></i><span data-i18n="testRun.startExecution">開始執行</span>
    </button>
    <button type="button" class="btn btn-warning" id="completeBtn" style="display: none;">
        <i class="fas fa-stop me-2"></i><span data-i18n="testRun.completeExecution">結束執行</span>
    </button>
    <button type="button" class="btn btn-info" id="restartBtn" style="display: none;">
        <i class="fas fa-redo me-2"></i><span data-i18n="testRun.restartExecution">重新執行</span>
    </button>
    <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" id="exportBtn">
            <i class="fas fa-download me-2"></i><span data-i18n="testRun.exportResults">匯出結果</span>
        </button>
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <a href="/test-run-management" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="navigation.backToManagement">回到管理</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid test-run-execution">
    <!-- 移除全頁載入狀態，改在列表區顯示載入動畫 -->

    <!-- Test Run 資訊與控制區 -->
    <div id="test-run-header" style="display: none;">
        <!-- 統計資訊區域已簡化 -->

        <!-- 統計資訊和批次操作一體化區域 -->
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <!-- 統計資訊 -->
            <div class="execution-stats flex-grow-1">
                <div class="stat-item">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label" data-i18n="testRun.totalItems">總項目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="executed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.executedItems">已執行</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-success" id="passed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.passedItems">通過</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-danger" id="failed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.failedItems">失敗</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="execution-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.executionRate">執行率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pass-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.passRate">通過率</div>
                </div>
            </div>
            
            <!-- 批次操作工具區 -->
            <div id="batchOperationsToolbar" class="d-none d-flex align-items-center gap-2">
                <span class="text-muted" id="selectedItemsCount" data-i18n="testRun.selectedItemsCount" data-i18n-params='{"count": 0}'>已選取 0 個項目</span>
                <button type="button" class="btn btn-primary btn-sm" id="batchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.batchModify">批次修改</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Test Run Items 表格 -->
    <div id="test-run-items-container" class="test-run-items-container" style="display: none;">
        <!-- 列表區載入動畫（預設隱藏） -->
        <div id="items-loading" class="align-items-center justify-content-center py-5 d-none" style="min-height: 240px;">
            <div class="text-center text-muted">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-2" data-i18n="testRun.loadingItems">載入測試項目中...</div>
            </div>
        </div>

        <div class="test-run-items-table">
            <table class="table table-hover table-sm">
                <thead>
                    <tr id="table-header-row">
                        <th id="checkbox-header">
                            <input type="checkbox" class="form-check-input" id="selectAllItemsCheckbox">
                        </th>
                        <th><span data-i18n="testRun.caseNumber">案例編號</span></th>
                        <th><span data-i18n="testRun.caseTitle">標題</span></th>
                        <th><span data-i18n="testRun.priority">優先級</span></th>
                        <th><span data-i18n="testRun.testResult">測試結果</span></th>
                        <th><span data-i18n="testRun.assignee">執行者</span></th>
                        <th><span data-i18n="testRun.executedAt">執行時間</span></th>
                        <th><span data-i18n="common.actions">操作</span></th>
                    </tr>
                </thead>
                <tbody id="items-table-body">
                    <!-- Test Run Items 將在此處動態載入 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Test Run Item 詳情 Modal -->
<div class="modal fade" id="itemDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.itemDetails">測試項目詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="item-detail-content">
                <!-- 詳情內容將動態載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 確認對話框 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span data-i18n="common.confirm">確認操作</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-action-btn" data-i18n="common.confirm">確認</button>
            </div>
        </div>
    </div>
</div>

<!-- 批次修改模態框 -->
<div class="modal fade" id="batchModifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    <span data-i18n="testRun.batchModify">批次修改</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <span data-i18n="testRun.batchModifyDescription">將對選中的</span>
                    <strong id="batchModifyCount">0</strong>
                    <span data-i18n="testRun.itemsApplyChanges">個項目套用以下變更：</span>
                </p>
                
                <!-- 執行者批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyAssignee" checked>
                        <label class="form-check-label" for="batchModifyAssignee">
                            <strong data-i18n="testRun.batchSetAssignee">批次設定執行者</strong>
                        </label>
                    </div>
                    <input type="text" class="form-control" id="batchAssigneeInput" 
                           data-assignee-selector
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}">
                </div>
                
                <!-- 測試結果批次設定 -->
                <div class="mb-3" id="batchResultSection">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyResult">
                        <label class="form-check-label" for="batchModifyResult">
                            <strong data-i18n="testRun.batchSetResult">批次設定測試結果</strong>
                            <br><small class="text-muted" data-i18n="testRun.onlyActiveStatus">（僅適用於執行中狀態）</small>
                        </label>
                    </div>
                    <select class="form-select" id="batchResultSelect" disabled>
                        <option value="" data-i18n="testRun.selectResult">請選擇結果</option>
                        <option value="Passed" data-i18n="testRun.passed">通過</option>
                        <option value="Failed" data-i18n="testRun.failed">失敗</option>
                        <option value="Retest" data-i18n="testRun.retest">重測</option>
                        <option value="Not Available" data-i18n="testRun.notAvailable">不適用</option>
                    </select>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.batchModifyNote">只會套用已勾選的項目，空白值將不會變更現有資料。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.confirmModify">確認修改</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 重新執行模態框 -->
<div class="modal fade" id="restartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-redo text-info me-2"></i>
                    <span data-i18n="testRun.restartExecution">重新執行 Test Run</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" data-i18n="testRun.selectRestartMode">請選擇重新執行模式：</p>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartAll" value="all" checked>
                    <label class="form-check-label" for="restartAll">
                        <strong data-i18n="testRun.restartAllItems">全部重新執行</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartAllDescription">清空所有項目的測試結果，重新開始執行</small>
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartFailed" value="failed">
                    <label class="form-check-label" for="restartFailed">
                        <strong data-i18n="testRun.restartFailedItems">只執行失敗的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartFailedDescription">只清空標記為「失敗」和「重測」的項目結果</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartPending" value="pending">
                    <label class="form-check-label" for="restartPending">
                        <strong data-i18n="testRun.restartPendingItems">只執行未完成的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartPendingDescription">只清空尚未執行的項目，保留已通過的結果</small>
                    </label>
                </div>
                
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.restartWarning">重新執行會將 Test Run 狀態重置為「執行中」，請確認後繼續。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-info" id="confirmRestartBtn">
                    <i class="fas fa-redo me-2"></i><span data-i18n="testRun.confirmRestart">確認重新執行</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 詳細資料 Modal -->
<div class="modal fade" id="testCaseDetailModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header align-items-center">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-tasks me-2"></i>
                    <span data-i18n="testRun.testCaseDetails">Test Case 詳細資料</span>
                </h5>
                <!-- Test Result 下拉/Badge：緊貼在標題後面 -->
                <div id="testCaseDetailHeaderResult" class="ms-3" style="min-width: 170px;"></div>
                <!-- 標頭靠右：上一隻 / 下一隻 / 關閉 -->
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prevExecCaseBtn" title="上一隻">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="nextExecCaseBtn" title="下一隻">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div id="testCaseDetailLoading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="common.loading">載入中...</span>
                </div>
                <!-- 內容 + 歷程並排區域 -->
                <div id="testCaseDetailBodyRow" class="d-none" style="flex: 1; min-height: 0; display: flex; gap: 12px;">
                    <!-- 左側：Basic Info（固定）+ 詳情（可捲動） -->
                    <div id="testCaseDetailLeft" style="flex: 1 1 auto; min-width: 0; display: flex; flex-direction: column; overflow: hidden;">
                        <!-- 固定區：Basic Info + 測試詳情標題 -->
                        <div id="testCaseDetailFixed" style="display:none;"></div>
                        <!-- 可捲動區：僅測試詳情內容 -->
                        <div id="testCaseDetailScrollable" style="display:none;"></div>
                    </div>
                    <!-- 右側：結果歷程 Timeline（1/4 寬） -->
                    <aside id="testCaseDetailTimelinePane" style="flex: 0 0 25%; max-width: 25%; border-left: 1px solid var(--tr-border-light); padding-left: 10px; display: none; min-width: 240px;">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i><span data-i18n="testRun.resultHistory">結果歷程</span></h6>
                            <button type="button" id="refreshTimelineBtn" class="btn btn-sm btn-outline-secondary" title="刷新"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="timelineLoading" class="text-center py-2" style="display:none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div id="timelineEmpty" class="text-muted small" style="display:none;">
                            <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noHistory">尚無歷程</span>
                        </div>
                        <div id="timelineList" style="height: calc(100% - 28px); overflow-y: auto;"></div>
                    </aside>
                </div>
                <div id="testCaseDetailError" style="display: none;">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span data-i18n="testRun.loadTestCaseError">載入 Test Case 詳細資料失敗</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    <span data-i18n="common.close">關閉</span>
                </button>
                <button type="button" class="btn btn-primary" id="openFullTestCaseBtn" style="display: none;">
                    <i class="fas fa-external-link-alt me-2"></i>
                    <span data-i18n="testRun.openInTestCaseManagement">在測試案例管理中開啟</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/assignee-selector.js"></script>
<script>
// Test Run 執行頁面
let currentConfigId = null;
let currentTeamId = null; // 由 AppUtils 取得，無則退回 1
let testRunConfig = null;
let testRunItems = [];
let itemDetailModal = null;
let confirmModal = null;
let restartModal = null;
let batchModifyModal = null;
let selectedItems = new Set(); // 追踪選中的測試執行項目
// Test Case 詳細快取（localStorage），以測試案例編號為 key
const TEST_CASE_CACHE_PREFIX = 'tr_exec_tc_cache_v1';
const TEST_CASE_CACHE_TTL_MS = 60 * 60 * 1000; // 1 小時

// 頁面初始化
document.addEventListener('DOMContentLoaded', function() {
    // 從 URL 參數取得 config ID
    const urlParams = new URLSearchParams(window.location.search);
    currentConfigId = parseInt(urlParams.get('config_id'));
    
    if (!currentConfigId) {
        AppUtils.showError('{{ i18n.t("testRun.missingConfigId") if i18n else "缺少測試執行配置 ID" }}');
        window.location.href = '/test-run-management';
        return;
    }
    
    initializePage();
    bindEventListeners();
});

function initializePage() {
    // 取得目前團隊 ID（與管理頁一致），無則暫用 1
    currentTeamId = AppUtils.getCurrentTeam()?.id;
    if (!currentTeamId) {
        currentTeamId = 1;
        console.log('Using temporary hardcoded team ID:', currentTeamId);
    }

    itemDetailModal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    restartModal = new bootstrap.Modal(document.getElementById('restartModal'));
    batchModifyModal = new bootstrap.Modal(document.getElementById('batchModifyModal'));
    
    // 綁定重新執行確認按鈕事件
    document.getElementById('confirmRestartBtn').addEventListener('click', handleRestartConfirm);
    
    // 綁定批次修改相關事件
    document.getElementById('confirmBatchModifyBtn').addEventListener('click', handleBatchModifyConfirm);
    document.getElementById('batchModifyAssignee').addEventListener('change', toggleBatchAssigneeInput);
    document.getElementById('batchModifyResult').addEventListener('change', toggleBatchResultSelect);
    
    // 初始化 AssigneeSelector 元件（批次修改模態框中的）
    if (window.AssigneeSelector && currentTeamId) {
        // 為批次修改的 input 初始化 AssigneeSelector
        const batchInput = document.getElementById('batchAssigneeInput');
        if (batchInput && batchInput.dataset.assigneeSelector !== undefined) {
            const options = {
                teamId: currentTeamId,
                allowCustomValue: true,  // 批次修改允許自定義值
                onSelect: (contact) => {
                    // 批次修改不需要立即更新，只需要設定值
                    console.log('Batch assignee selected:', contact.name);
                }
            };
            
            if (batchInput._assigneeSelector) {
                batchInput._assigneeSelector.destroy();
            }
            batchInput._assigneeSelector = new AssigneeSelector(batchInput, options);
        }
    }
    
    loadTestRunConfig();
}

function bindEventListeners() {
    document.getElementById('refreshBtn').addEventListener('click', async () => {
        try {
            showItemsLoading();
            // 重新載入 Items
            await loadTestRunItems();
            // 強制重新抓取 Test Case 詳細並更新快取
            await preloadAllTeamTestCasesForRun(testRunItems);
            // 更新統計
            await updateStatistics();
            // 若詳情 Modal 開啟中則刷新 timeline（以目前顯示的 test case）
            try {
                const modalEl = document.getElementById('testCaseDetailModal');
                const isShown = modalEl && modalEl.classList.contains('show');
                if (isShown && currentDetailTestCase && currentDetailTestCase.test_case_number) {
                    renderResultHistoryTimeline({ test_case_number: currentDetailTestCase.test_case_number });
                }
            } catch (_) {}
        } finally {
            hideItemsLoading();
        }
    });
    
    document.getElementById('startBtn').addEventListener('click', () => {
        confirmStatusChange('active', '{{ i18n.t("testRun.startExecutionConfirm") if i18n else "開始執行此 Test Run？" }}');
    });
    
    document.getElementById('completeBtn').addEventListener('click', () => {
        confirmStatusChange('completed', '{{ i18n.t("testRun.completeExecutionConfirm") if i18n else "結束此 Test Run？結束後將無法再修改測試結果。" }}');
    });
    
    document.getElementById('restartBtn').addEventListener('click', showRestartModal);
    
    document.getElementById('exportBtn').addEventListener('click', exportResults);
    
    // 全選 checkbox 事件
    document.getElementById('selectAllItemsCheckbox').addEventListener('change', toggleSelectAllItems);
    
    // 批次修改按鈕事件
    document.getElementById('batchModifyBtn').addEventListener('click', showBatchModifyModal);
    
    // 監聽個別項目 checkbox 變化
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('test-run-item-checkbox')) {
            const itemId = parseInt(e.target.value);
            if (e.target.checked) {
                selectedItems.add(itemId);
            } else {
                selectedItems.delete(itemId);
            }
            updateItemSelectionUI();
        }
    });
}

async function loadTestRunConfig() {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunConfig = await response.json();
        updateHeader();
        await loadTestRunItems();
        await updateStatistics();
        
    } catch (error) {
        console.error('Failed to load Test Run config:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadFailed") if i18n else "載入失敗" }}' + ': ' + error.message);
    } finally {
        hideItemsLoading();
    }
}

async function loadTestRunItems() {
    try {
        showItemsLoading();
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunItems = await response.json();
        // 比照 Test Case Management：一次抓取整個團隊的測試案例清單，
        // 並將本次 Test Run 需要的案例寫入本地快取（改為背景預抓，不阻塞列表顯示）。
        Promise.resolve().then(() => preloadAllTeamTestCasesForRun(testRunItems)).catch(() => {});
        renderTestRunItems();
        hideItemsLoading();
        
    } catch (error) {
        console.error('Failed to load test items:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadItemsFailed") if i18n else "載入測試項目失敗" }}' + ': ' + error.message);
        hideItemsLoading();
    }
}

function updateHeader() {
    if (!testRunConfig) return;
    
    // 更新頁面標題
    document.getElementById('test-run-subtitle').textContent = testRunConfig.name;
    
    // 顯示對應的控制按鈕
    updateControlButtons(testRunConfig.status);
    
    // 顯示頁面內容
    document.getElementById('test-run-header').style.display = 'block';
    document.getElementById('test-run-items-container').style.display = 'block';
}

function updateControlButtons(status) {
    // 隱藏所有按鈕
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('completeBtn').style.display = 'none';
    document.getElementById('restartBtn').style.display = 'none';
    
    // 根據狀態顯示對應按鈕
    switch (status) {
        case 'draft':
            document.getElementById('startBtn').style.display = 'inline-block';
            break;
        case 'active':
            document.getElementById('completeBtn').style.display = 'inline-block';
            break;
        case 'completed':
            document.getElementById('restartBtn').style.display = 'inline-block';
            break;
    }
}

function renderTestRunItems() {
    const tbody = document.getElementById('items-table-body');
    const canUpdate = testRunConfig && testRunConfig.status === 'active';
    
    // 更新表格標頭顯示
    updateTableHeader();
    
    tbody.innerHTML = testRunItems.map((item, index) => {
        return createItemRow(item, index + 1, canUpdate);
    }).join('');
    
    // 綁定事件處理器
    bindItemEventHandlers(canUpdate);

    // 確保載入動畫關閉，顯示列表
    hideItemsLoading();
}

// 列表區載入動畫控制（顯示空框 + spinner）
function showItemsLoading() {
    try {
        const container = document.getElementById('test-run-items-container');
        const loading = document.getElementById('items-loading');
        const tableWrap = container.querySelector('.test-run-items-table');
        if (container) container.style.display = 'block';
        if (loading) {
            loading.classList.remove('d-none');
            loading.classList.add('d-flex');
            loading.style.display = '';
        }
        if (tableWrap) tableWrap.style.display = 'none';
        const tbody = document.getElementById('items-table-body');
        if (tbody) tbody.innerHTML = '';
    } catch (_) {}
}

function hideItemsLoading() {
    try {
        const container = document.getElementById('test-run-items-container');
        const loading = document.getElementById('items-loading');
        const tableWrap = container.querySelector('.test-run-items-table');
        if (loading) {
            loading.classList.remove('d-flex');
            loading.classList.add('d-none');
            loading.style.display = '';
        }
        if (tableWrap) tableWrap.style.display = 'block';
    } catch (_) {}
}

function shouldShowCheckbox(status) {
    return status === 'draft' || status === 'active';
}

function updateTableHeader() {
    const table = document.querySelector('.test-run-items-table');
    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');
    
    if (showCheckbox) {
        table.classList.remove('hide-checkbox');
    } else {
        table.classList.add('hide-checkbox');
        // 清空選擇狀態
        selectedItems.clear();
        updateItemSelectionUI();
    }
}

function createItemRow(item, index, canUpdate) {
    const resultClass = getResultClass(item.test_result);
    const resultText = getResultText(item.test_result);
    const executedAt = item.executed_at ? AppUtils.formatDate(item.executed_at, 'datetime') : '-';
    const assigneeName = (item.assignee_name || (item.assignee && item.assignee.name)) || '-';
    const canEditAssignee = testRunConfig && testRunConfig.status !== 'completed';
    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');
    
    return `
        <tr data-item-id="${item.id}">
            ${showCheckbox ? `
                <td class="checkbox-cell">
                    <input type="checkbox" class="form-check-input test-run-item-checkbox" value="${item.id}">
                </td>
            ` : ''}
            <td><code><a href="#" class="text-decoration-none" onclick="navigateToTestCase('${item.test_case_number}'); return false;">${escapeHtml(item.test_case_number)}</a></code></td>
            <td class="text-truncate" title="${escapeHtml(item.title)}"><a href="#" class="text-decoration-none" onclick="navigateToTestCase('${item.test_case_number}'); return false;">${escapeHtml(item.title)}</a></td>
            <td><span class="badge bg-secondary priority-badge-lg">${escapeHtml(item.priority || 'Medium')}</span></td>
            <td>
                ${canUpdate ? `
                    <select class="form-select result-selector-lg ${resultClass}" 
                            data-item-id="${item.id}" onchange="updateTestResult(${item.id}, this.value)">
                        <option value="">${escapeHtml('{{ i18n.t("testRun.notExecuted") if i18n else "未執行" }}')}</option>
                        <option value="Passed" ${item.test_result === 'Passed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.passed") if i18n else "通過" }}')}</option>
                        <option value="Failed" ${item.test_result === 'Failed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.failed") if i18n else "失敗" }}')}</option>
                        <option value="Retest" ${item.test_result === 'Retest' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.retest") if i18n else "重測" }}')}</option>
                        <option value="Not Available" ${item.test_result === 'Not Available' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notAvailable") if i18n else "不適用" }}')}</option>
                    </select>
                ` : `
                    <span class="badge result-badge-lg ${resultClass}">${resultText}</span>
                `}
            </td>
            <td>
                ${canEditAssignee ? `
                    <input type="text" class="form-control form-control-sm assignee-editor" 
                           value="${escapeHtml(assigneeName === '-' ? '' : assigneeName)}"
                           data-item-id="${item.id}" 
                           data-assignee-selector
                           data-i18n-placeholder="testRun.enterAssigneeName"
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}"
                           onblur="updateAssignee(${item.id}, this.value)">
                ` : `
                    ${assigneeName}
                `}
            </td>
            <td class="small text-muted">${executedAt}</td>
            <td>
                <!-- 操作按鈕保留為未來擴展使用 -->
            </td>
        </tr>
    `;
}

function bindItemEventHandlers(canUpdate) {
    if (!canUpdate) return;
    
    // 結果選擇器樣式更新（同時支援 .result-selector 與 .result-selector-lg）
    document.querySelectorAll('.result-selector, .result-selector-lg').forEach(select => {
        select.addEventListener('change', function() {
            updateSelectClass(this);
        });
        updateSelectClass(select);
    });
    
    // 初始化新渲染的 AssigneeSelector 元件（行內編輯器）
    if (window.initAssigneeSelectors && currentTeamId) {
        // 清理之前的 AssigneeSelector 實例
        document.querySelectorAll('.assignee-editor[data-assignee-selector]').forEach(input => {
            if (input._assigneeSelector) {
                input._assigneeSelector.destroy();
            }
        });
        
        // 為每個 assignee editor 設定自訂選項，包含選擇回調
        document.querySelectorAll('.assignee-editor[data-assignee-selector]').forEach(input => {
            const itemId = parseInt(input.dataset.itemId);
            
            if (input._assigneeSelector) {
                input._assigneeSelector.destroy();
            }
            
            const options = {
                teamId: currentTeamId,
                allowCustomValue: true,
                onSelect: (contact) => {
                    // 當選擇聯絡人時，自動更新 assignee
                    updateAssignee(itemId, contact.name);
                },
                onClear: () => {
                    // 當清空選擇時，自動清空 assignee
                    updateAssignee(itemId, '');
                }
            };
            
            input._assigneeSelector = new AssigneeSelector(input, options);
        });
    }
}

function updateSelectClass(select) {
    const value = select.value;
    const hasSm = select.classList.contains('form-select-sm');
    const sizeClass = hasSm ? 'form-select-sm ' : '';
    select.className = `form-select ${sizeClass}result-selector-lg ${getResultClass(value)}`;
}

async function updateTestResult(itemId, result) {
    try {
        const executedAt = result ? new Date().toISOString() : null;
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                test_result: result || null,
                executed_at: executedAt
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // 更新本地資料
        const itemIndex = testRunItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            testRunItems[itemIndex].test_result = result || null;
            testRunItems[itemIndex].executed_at = executedAt;
        }
        
        // 更新統計
        await updateStatistics();
        // 若詳情 Modal 開啟中且為同一測試案例，刷新右側 timeline
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            const item = testRunItems.find(i => i.id === itemId);
            if (isShown && item && currentDetailTestCase && currentDetailTestCase.test_case_number === item.test_case_number) {
                renderResultHistoryTimeline({ test_case_number: item.test_case_number });
            }
        } catch (_) {}
        
    } catch (error) {
        console.error('Failed to update test result:', error);
        AppUtils.showError('{{ i18n.t("testRun.updateFailed") if i18n else "更新失敗" }}' + ': ' + error.message);
        // 重新載入項目以恢復狀態
        await loadTestRunItems();
    }
}

async function updateStatistics() {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/statistics`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const stats = await response.json();
        
        document.getElementById('total-count').textContent = stats.total_runs;
        document.getElementById('executed-count').textContent = stats.executed_runs;
        document.getElementById('passed-count').textContent = stats.passed_runs;
        document.getElementById('failed-count').textContent = stats.failed_runs;
        // 顯示為無條件捨去之整數百分比
        document.getElementById('execution-rate').textContent = Math.floor(stats.execution_rate) + '%';
        // 通過率顯示為無條件捨去之整數百分比
        document.getElementById('pass-rate').textContent = Math.floor(stats.pass_rate) + '%';
        
        // 同步配置統計
        await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/sync`);
        
    } catch (error) {
        console.error('Failed to update statistics:', error);
    }
}

function showItemDetail(itemId) {
    const item = testRunItems.find(i => i.id === itemId);
    if (!item) return;
    
    const basicInfoLabel = '{{ i18n.t("testRun.basicInfo") if i18n else "基本資訊" }}';
    const executionInfoLabel = '{{ i18n.t("testRun.executionInfo") if i18n else "執行資訊" }}';
    const testCaseNumberLabel = '{{ i18n.t("testRun.testCaseNumber") if i18n else "測試案例編號" }}';
    const titleLabel = '{{ i18n.t("common.title") if i18n else "標題" }}';
    const priorityLabel = '{{ i18n.t("testRun.priority") if i18n else "優先級" }}';
    const testResultLabel = '{{ i18n.t("testRun.testResult") if i18n else "測試結果" }}';
    const executorLabel = '{{ i18n.t("testRun.executor") if i18n else "執行者" }}';
    const executionTimeLabel = '{{ i18n.t("testRun.executionTime") if i18n else "執行時間" }}';
    const executionDurationLabel = '{{ i18n.t("testRun.executionDuration") if i18n else "執行時長" }}';
    const attachmentCountLabel = '{{ i18n.t("testRun.attachmentCount") if i18n else "附件數量" }}';
    const preconditionsLabel = '{{ i18n.t("testRun.preconditions") if i18n else "前置條件" }}';
    const testStepsLabel = '{{ i18n.t("testRun.testSteps") if i18n else "測試步驟" }}';
    const expectedResultsLabel = '{{ i18n.t("testRun.expectedResults") if i18n else "預期結果" }}';
    const minutesLabel = '{{ i18n.t("testRun.minutes") if i18n else "分鐘" }}';
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>${basicInfoLabel}</h6>
                <table class="table table-sm">
                    <tr><td>${testCaseNumberLabel}</td><td><code>${escapeHtml(item.test_case_number)}</code></td></tr>
                    <tr><td>${titleLabel}</td><td>${escapeHtml(item.title)}</td></tr>
                    <tr><td>${priorityLabel}</td><td>${escapeHtml(item.priority || 'Medium')}</td></tr>
                    <tr><td>${testResultLabel}</td><td><span class="badge ${getResultClass(item.test_result)}">${getResultText(item.test_result)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>${executionInfoLabel}</h6>
                <table class="table table-sm">
                    <tr><td>${executorLabel}</td><td>${escapeHtml(item.assignee_name || '-')}</td></tr>
                    <tr><td>${executionTimeLabel}</td><td>${item.executed_at ? AppUtils.formatDate(item.executed_at, 'datetime') : '-'}</td></tr>
                    <tr><td>${executionDurationLabel}</td><td>${item.execution_duration ? item.execution_duration + ' ' + minutesLabel : '-'}</td></tr>
                    <tr><td>${attachmentCountLabel}</td><td>${item.attachment_count || 0}</td></tr>
                </table>
            </div>
        </div>
        ${item.precondition ? `<div class="mt-3"><h6>${preconditionsLabel}</h6><p class="text-muted">${escapeHtml(item.precondition)}</p></div>` : ''}
        ${item.steps ? `<div class="mt-3"><h6>${testStepsLabel}</h6><p class="text-muted">${escapeHtml(item.steps).replace(/\n/g, '<br>')}</p></div>` : ''}
        ${item.expected_result ? `<div class="mt-3"><h6>${expectedResultsLabel}</h6><p class="text-muted">${escapeHtml(item.expected_result)}</p></div>` : ''}
    `;
    
    document.getElementById('item-detail-content').innerHTML = content;
    itemDetailModal.show();
}

function confirmStatusChange(newStatus, message) {
    document.getElementById('confirm-message').textContent = message;
    const confirmBtn = document.getElementById('confirm-action-btn');
    
    confirmBtn.onclick = async () => {
        try {
            await changeTestRunStatus(newStatus);
            confirmModal.hide();
        } catch (error) {
            AppUtils.showError('{{ i18n.t("testRun.statusChangeFailed") if i18n else "狀態變更失敗" }}' + ': ' + error.message);
        }
    };
    
    confirmModal.show();
}

async function changeTestRunStatus(newStatus) {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunConfig.status = newStatus;
        updateHeader();
        
        // 重新渲染項目以更新 checkbox 顯示和編輯權限
        renderTestRunItems();
        
        const statusMsg = {
            'active': '{{ i18n.t("testRun.executionStarted") if i18n else "已開始執行" }}',
            'completed': '{{ i18n.t("testRun.executionCompleted") if i18n else "已結束執行" }}'
        };
        
        AppUtils.showSuccess(statusMsg[newStatus] || '{{ i18n.t("testRun.statusUpdated") if i18n else "狀態已更新" }}');
        
    } catch (error) {
        console.error('Failed to change status:', error);
        throw error;
    }
}

function showRestartModal() {
    if (!testRunConfig || testRunConfig.status !== 'completed') {
        AppUtils.showWarning('{{ i18n.t("testRun.onlyCompletedCanRestart") if i18n else "只有已完成的 Test Run 才能重新執行" }}');
        return;
    }
    
    // 重置選項為默認值
    document.getElementById('restartAll').checked = true;
    restartModal.show();
}

async function handleRestartConfirm() {
    const selectedMode = document.querySelector('input[name="restartMode"]:checked');
    if (!selectedMode) {
        AppUtils.showWarning('{{ i18n.t("testRun.selectRestartMode") if i18n else "請選擇重新執行模式" }}');
        return;
    }
    
    try {
        await restartTestRun(selectedMode.value);
        restartModal.hide();
        
    } catch (error) {
        AppUtils.showError('{{ i18n.t("testRun.restartFailed") if i18n else "重新執行失敗" }}' + ': ' + error.message);
    }
}

async function restartTestRun(mode) {
    try {
        // 調用重新執行 API
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/restart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        // 更新本地狀態
        testRunConfig.status = 'active';
        updateHeader();
        
        // 重新載入項目和統計
        await loadTestRunItems();
        await updateStatistics();
        
        const modeMessages = {
            'all': '{{ i18n.t("testRun.restartAllSuccess") if i18n else "已重新執行所有項目" }}',
            'failed': '{{ i18n.t("testRun.restartFailedSuccess") if i18n else "已重新執行失敗項目" }}',
            'pending': '{{ i18n.t("testRun.restartPendingSuccess") if i18n else "已重新執行未完成項目" }}'
        };
        
        AppUtils.showSuccess(modeMessages[mode] || '{{ i18n.t("testRun.restartSuccess") if i18n else "重新執行成功" }}');
        
    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.restartFailed')
            : '重新執行 Test Run 失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

function exportResults() {
    // TODO: 實現匯出功能
    AppUtils.showInfo('{{ i18n.t("testRun.exportNotImplemented") if i18n else "匯出功能開發中..." }}');
}

// 輔助函數（狀態文字映射已移除，因為不再需要狀態指示器）

function getResultClass(result) {
    const classMap = {
        'Passed': 'result-passed',
        'Failed': 'result-failed', 
        'Retest': 'result-retest',
        'Not Available': 'result-na'
    };
    return classMap[result] || 'result-pending';
}

function getResultText(result) {
    const textMap = {
        'Passed': '{{ i18n.t("testRun.passed") if i18n else "通過" }}',
        'Failed': '{{ i18n.t("testRun.failed") if i18n else "失敗" }}',
        'Retest': '{{ i18n.t("testRun.retest") if i18n else "重測" }}', 
        'Not Available': '{{ i18n.t("testRun.notAvailable") if i18n else "不適用" }}'
    };
    return textMap[result] || '{{ i18n.t("testRun.notExecuted") if i18n else "未執行" }}';
}

// 全頁載入已移除，使用列表區載入動畫（showItemsLoading/hideItemsLoading）

function toggleSelectAllItems() {
    const selectAll = document.getElementById('selectAllItemsCheckbox').checked;
    const checkboxes = document.querySelectorAll('.test-run-item-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const itemId = parseInt(checkbox.value);
        if (selectAll) {
            selectedItems.add(itemId);
        } else {
            selectedItems.delete(itemId);
        }
    });
    
    updateItemSelectionUI();
}

function updateItemSelectionUI() {
    const totalCheckboxes = document.querySelectorAll('.test-run-item-checkbox').length;
    const selectedCount = selectedItems.size;
    const selectAllCheckbox = document.getElementById('selectAllItemsCheckbox');
    const toolbar = document.getElementById('batchOperationsToolbar');
    const countDisplay = document.getElementById('selectedItemsCount');
    
    // 如果不顯示 checkbox，隱藏工具列
    if (!shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft')) {
        toolbar.classList.add('d-none');
        return;
    }
    
    // 更新全選 checkbox 狀態
    if (selectedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        toolbar.classList.add('d-none');
    } else if (selectedCount === totalCheckboxes) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
        toolbar.classList.remove('d-none');
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
        toolbar.classList.remove('d-none');
    }
    
    // 更新選中項目計數
    if (window.i18n && window.i18n.isReady()) {
        countDisplay.textContent = window.i18n.t('testRun.selectedItemsCount', {count: selectedCount});
    } else {
        countDisplay.textContent = `已選取 ${selectedCount} 個項目`;
    }
    // 更新 data-i18n-params 屬性以支持語言切換
    countDisplay.setAttribute('data-i18n-params', JSON.stringify({count: selectedCount}));
}

function showBatchModifyModal() {
    if (selectedItems.size === 0) {
        const noSelectionMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.noItemsSelected')
            : '{{ i18n.t("testRun.noItemsSelected") if i18n else "請先選擇要修改的項目" }}';
        AppUtils.showWarning(noSelectionMsg);
        return;
    }
    
    // 更新選中項目數量
    document.getElementById('batchModifyCount').textContent = selectedItems.size;
    
    // 根據當前狀態顯示/隱藏測試結果選項
    const canUpdateResult = testRunConfig && testRunConfig.status === 'active';
    const resultSection = document.getElementById('batchResultSection');
    
    if (canUpdateResult) {
        resultSection.style.display = 'block';
    } else {
        resultSection.style.display = 'none';
        document.getElementById('batchModifyResult').checked = false;
    }
    
    // 重置表單
    document.getElementById('batchAssigneeInput').value = '';
    document.getElementById('batchResultSelect').value = '';
    document.getElementById('batchModifyAssignee').checked = true;
    document.getElementById('batchModifyResult').checked = false;
    
    toggleBatchAssigneeInput();
    toggleBatchResultSelect();
    
    batchModifyModal.show();
}

function toggleBatchAssigneeInput() {
    const checkbox = document.getElementById('batchModifyAssignee');
    const input = document.getElementById('batchAssigneeInput');
    input.disabled = !checkbox.checked;
}

function toggleBatchResultSelect() {
    const checkbox = document.getElementById('batchModifyResult');
    const select = document.getElementById('batchResultSelect');
    select.disabled = !checkbox.checked;
}

async function handleBatchModifyConfirm() {
    try {
        const modifyAssignee = document.getElementById('batchModifyAssignee').checked;
        const modifyResult = document.getElementById('batchModifyResult').checked;
        const assigneeName = document.getElementById('batchAssigneeInput').value.trim();
        const testResult = document.getElementById('batchResultSelect').value;
        
        if (!modifyAssignee && !modifyResult) {
            const selectOptionMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.selectAtLeastOneOption')
                : '{{ i18n.t("testRun.selectAtLeastOneOption") if i18n else "請至少選擇一個要修改的項目" }}';
            AppUtils.showWarning(selectOptionMsg);
            return;
        }
        
        if (modifyAssignee && !assigneeName) {
            const enterAssigneeMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.enterAssigneeName')
                : '{{ i18n.t("testRun.enterAssigneeName") if i18n else "請輸入執行者姓名" }}';
            AppUtils.showWarning(enterAssigneeMsg);
            return;
        }
        
        if (modifyResult && !testResult) {
            const selectResultMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.selectTestResult')
                : '{{ i18n.t("testRun.selectTestResult") if i18n else "請選擇測試結果" }}';
            AppUtils.showWarning(selectResultMsg);
            return;
        }
        
        await batchModifyItems({ modifyAssignee, modifyResult, assigneeName, testResult });
        batchModifyModal.hide();
        
    } catch (error) {
        const batchFailedMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.batchModifyFailed')
            : '{{ i18n.t("testRun.batchModifyFailed") if i18n else "批次修改失敗" }}';
        AppUtils.showError(batchFailedMsg + ': ' + error.message);
    }
}

async function batchModifyItems(modifications) {
    try {
        const itemsToModify = Array.from(selectedItems);
        
        // 為每個選中的項目建立更新資料
        const updates = itemsToModify.map(itemId => {
            const updateData = { id: itemId };
            
            if (modifications.modifyAssignee) {
                updateData.assignee_name = modifications.assigneeName || null;
            }
            
            if (modifications.modifyResult) {
                updateData.test_result = modifications.testResult;
                updateData.executed_at = new Date().toISOString();
            }
            
            return updateData;
        });
        
        // 批次修改 API 調用（使用正確的端點）
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/batch-update-results`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                updates: updates
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`HTTP ${response.status}: ${errorData.detail || 'Unknown error'}`);
        }
        
        // 解析API響應
        const result = await response.json();
        
        // 樂觀更新本地列表（避免等待重載也能即時看到變更）
        try {
            updates.forEach(u => {
                const id = u.id;
                const idx = testRunItems.findIndex(it => it.id === id);
                if (idx !== -1) {
                    if ('assignee_name' in u) {
                        testRunItems[idx].assignee_name = (u.assignee_name || null);
                    }
                    if ('test_result' in u) {
                        testRunItems[idx].test_result = (u.test_result || null);
                        testRunItems[idx].executed_at = u.executed_at || new Date().toISOString();
                    }
                }
            });
            renderTestRunItems();
        } catch (_) {}

        // 再從伺服器重載一次，確保資料正確
        await loadTestRunItems();
        await updateStatistics();

        // 若詳情 Modal 開啟中則刷新 timeline（以目前顯示的 test case）
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            if (isShown && currentDetailTestCase && currentDetailTestCase.test_case_number) {
                renderResultHistoryTimeline({ test_case_number: currentDetailTestCase.test_case_number });
            }
        } catch (_) {}
        
        // 清空選擇狀態並更新 UI
        selectedItems.clear();
        updateItemSelectionUI();
        
        // 顯示成功訊息，包括處理結果
        if (result.success) {
            const successMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.batchModifySuccess', {count: result.success_count})
                : `成功修改 ${result.success_count} 個測試執行項目`;
            AppUtils.showSuccess(successMsg);
        } else {
            // 部分成功的情況
            const partialMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.batchModifyPartial', {success: result.success_count, total: result.processed_count})
                : `已處理 ${result.processed_count} 個項目，成功 ${result.success_count} 個`;
            AppUtils.showWarning(partialMsg);
            
            if (result.error_messages && result.error_messages.length > 0) {
                console.warn('批次修改錯誤:', result.error_messages);
            }
        }
        
    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.batchModifyFailed')
            : '批次修改測試執行項目失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

function navigateToTestCase(testCaseNumber) {
    if (!testCaseNumber) {
        AppUtils.showWarning('{{ i18n.t("testRun.invalidTestCaseNumber") if i18n else "無效的測試案例編號" }}');
        return;
    }
    
    // 顯示 Test Case 詳細資料 Modal
    showTestCaseDetailModal(testCaseNumber);
}

// Test Case 詳細資料 Modal 相關函數
let testCaseDetailModalInstance = null;
let currentDetailTestCase = null; // 目前顯示於執行頁 Modal 的 Test Case，用於鍵盤導航

async function showTestCaseDetailModal(testCaseNumber) {
    // 初始化 Modal
    const modalElement = document.getElementById('testCaseDetailModal');
    if (!testCaseDetailModalInstance) {
        testCaseDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    
    // 重置 Modal 狀態
    document.getElementById('testCaseDetailLoading').style.display = 'block';
    const fixedDiv = document.getElementById('testCaseDetailFixed');
    const scrollDiv = document.getElementById('testCaseDetailScrollable');
    fixedDiv.style.display = 'none';
    scrollDiv.style.display = 'none';
    document.getElementById('testCaseDetailError').style.display = 'none';
    document.getElementById('openFullTestCaseBtn').style.display = 'none';
    // 在載入期間先隱藏/清空標頭的 Test Result，避免顯示舊資料
    const headerResult = document.getElementById('testCaseDetailHeaderResult');
    if (headerResult) {
        headerResult.innerHTML = '';
        headerResult.style.visibility = 'hidden';
    }
    
    // 顯示 Modal
    testCaseDetailModalInstance.show();
    // 綁定鍵盤左右鍵支援
    const modalEl = document.getElementById('testCaseDetailModal');
    if (!modalEl._keydownBound) {
        modalEl.addEventListener('shown.bs.modal', function() {
            document.addEventListener('keydown', handleExecDetailModalKeydown);
        });
        modalEl.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handleExecDetailModalKeydown);
        });
        modalEl._keydownBound = true;
    }
    
    try {
        // 載入 Test Case 資料
        await loadTestCaseDetail(testCaseNumber);
    } catch (error) {
        console.error('Failed to load test case detail:', error);
        showTestCaseDetailError();
    }
}

async function loadTestCaseDetail(testCaseNumber) {
    try {
        // 先嘗試從 localStorage 讀取快取，若 1 小時內則直接顯示
        const cached = getCachedTestCase(testCaseNumber);
        if (cached && (Date.now() - cached.ts) < TEST_CASE_CACHE_TTL_MS) {
            displayTestCaseDetail(cached.data);
            return; // 使用快取，不發出請求
        }

        // 從當前團隊的測試案例中搜尋
        const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
        url.searchParams.set('search', testCaseNumber);
        url.searchParams.set('limit', '1');
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const testCases = await response.json();
        
        if (testCases.length === 0) {
            throw new Error('找不到指定的測試案例');
        }
        
        const testCase = testCases.find(tc => tc.test_case_number === testCaseNumber);
        if (!testCase) {
            throw new Error('找不到指定的測試案例');
        }

        // 寫入快取
        setCachedTestCase(testCaseNumber, testCase);

        // 顯示 Test Case 詳細資料
        displayTestCaseDetail(testCase);
        
    } catch (error) {
        console.error('Error loading test case detail:', error);
        throw error;
    }
}

function displayTestCaseDetail(testCase) {
    // 隱藏載入狀態
    document.getElementById('testCaseDetailLoading').style.display = 'none';
    
    // 準備顯示資料
    const fixedDiv = document.getElementById('testCaseDetailFixed');
    const scrollDiv = document.getElementById('testCaseDetailScrollable');
    const openBtn = document.getElementById('openFullTestCaseBtn');
    
    // 生成詳細資料 HTML（拆分固定與可捲動內容）
    const { fixedHtml, scrollableHtml } = createTestCaseDetailHtml(testCase);
    fixedDiv.innerHTML = fixedHtml;
    scrollDiv.innerHTML = scrollableHtml;
    
    // 顯示內容和開啟按鈕
    const bodyRow = document.getElementById('testCaseDetailBodyRow');
    if (bodyRow) bodyRow.classList.remove('d-none');
    fixedDiv.style.display = 'block';
    scrollDiv.style.display = 'block';
    openBtn.style.display = 'inline-block';
    // 記錄目前展示的 Test Case，供鍵盤導航使用
    currentDetailTestCase = testCase;
    
    // 設定開啟按鈕的點擊事件
    openBtn.onclick = function() {
        const url = `/test-case-management?tc=${encodeURIComponent(testCase.test_case_number)}&team_id=${encodeURIComponent(currentTeamId)}&minimal=1&mode=edit`;
        window.open(url, 'TestCaseEditor', 'width=1200,height=800,noopener,noreferrer');
    };
    
    // 應用 i18n 翻譯
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(fixedDiv);
        window.i18n.retranslate(scrollDiv);
    }

    // 在標頭區渲染 Test Result 下拉或唯讀 badge
    renderModalHeaderResult(testCase);

    // 渲染右側 Timeline（結果歷程）
    renderResultHistoryTimeline(testCase);
    // 載入完成後再顯示，避免切換時顯示上一筆資料
    const headerResult = document.getElementById('testCaseDetailHeaderResult');
    if (headerResult) {
        headerResult.style.visibility = 'visible';
    }

    // 綁定上一隻、下一隻按鈕
    const prevBtn = document.getElementById('prevExecCaseBtn');
    const nextBtn = document.getElementById('nextExecCaseBtn');
    if (prevBtn && nextBtn) {
        prevBtn.onclick = () => navigateExecCase(testCase, -1);
        nextBtn.onclick = () => navigateExecCase(testCase, 1);
        // 依序號狀態啟用/停用
        const idx = (testRunItems || []).findIndex(i => i.test_case_number === testCase.test_case_number);
        prevBtn.disabled = idx <= 0;
        nextBtn.disabled = idx < 0 || idx >= testRunItems.length - 1;
    }
}

function createTestCaseDetailHtml(testCase) {
    const assigneeName = testCase.assignee ? testCase.assignee.name || testCase.assignee.en_name : '';
    const tcgText = testCase.tcg && testCase.tcg.length > 0 ? testCase.tcg.map(t => t.text || t).join(', ') : '';
    const attachmentCount = testCase.attachments ? testCase.attachments.length : 0;

    const fixedHtml = `
        <!-- Basic Info 區域 -->
        <div class="card mb-2">
            <div class="card-header py-1">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.basicInfo">基本資訊</span>
                </h6>
            </div>
            <div class="card-body px-2" style="padding-top: 0.25rem; padding-bottom: 0.25rem;">
                <table class="table table-sm table-borderless mb-0" style="line-height: 1.2;">
                    <tr>
                        <td class="fw-bold" style="width: 15%; font-size: 0.85rem; padding: 0.15rem 0.5rem;" data-i18n="testRun.testCaseNumber">編號</td>
                        <td style="width: 35%; padding: 0.15rem 0.5rem;"><code style="font-size: 0.85rem;">${escapeHtml(testCase.test_case_number)}</code></td>
                        <td class="fw-bold" style="width: 10%; font-size: 0.85rem; padding: 0.15rem 0.5rem;">${tcgText ? 'TCG' : ''}</td>
                        <td style="padding: 0.15rem 0.5rem;">${tcgText ? '<code style="font-size: 0.85rem;">' + escapeHtml(tcgText) + '</code>' : ''}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold" style="font-size: 0.85rem; padding: 0.15rem 0.5rem;" data-i18n="testRun.title">標題</td>
                        <td class="text-break" colspan="3" style="padding: 0.15rem 0.5rem; font-size: 0.9rem;">${escapeHtml(testCase.title)}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold" style="font-size: 0.85rem; padding: 0.15rem 0.5rem;" data-i18n="testRun.priority">優先級</td>
                        <td style="padding: 0.15rem 0.5rem;"><span class="badge bg-secondary" style="font-size: 0.75rem;">${escapeHtml(testCase.priority || 'Medium')}</span></td>
                        <td class="fw-bold" style="font-size: 0.85rem; padding: 0.15rem 0.5rem;" data-i18n="testRun.assignee">執行者</td>
                        <td style="padding: 0.15rem 0.5rem; font-size: 0.9rem;">${escapeHtml(assigneeName || '未分配')}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold align-top" style="font-size: 0.85rem; padding: 0.15rem 0.5rem;" data-i18n="testRun.attachments">附件</td>
                        <td colspan="3" style="padding: 0.15rem 0.5rem;">
                            <div class="d-flex align-items-center">
                                ${attachmentCount > 0 ? `
                                    <a href="#" class="text-decoration-none" onclick="scrollToAttachments(); return false;" title="${escapeHtml('{{ i18n.t("testRun.attachments") if i18n else "附件" }}')}">
                                        <i class="fas fa-paperclip me-1"></i>
                                        ${attachmentCount} <span data-i18n="testRun.files">個文件</span>
                                    </a>
                                ` : `
                                    <span class="text-muted"><i class="fas fa-paperclip me-1"></i>0 <span data-i18n="testRun.files">個文件</span></span>
                                `}
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- Test Details 標題（固定） -->
        <div class="card mb-2">
            <div class="card-header py-2">
                <h6 class="card-title mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.testDetails">測試詳情</span>
                </h6>
            </div>
        </div>`;

    const scrollableHtml = `
        <div class="card">
            <div class="card-body" style="padding: 1rem;">
                ${testCase.precondition ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.precondition">前置條件</h6>
                    <div class="section-block section-precondition">
                        <div class="markdown-preview mb-0" style="font-size: 0.9rem;">${renderMarkdown(testCase.precondition)}</div>
                    </div>
                </div>
                ` : ''}
                ${testCase.steps ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.steps">測試步驟</h6>
                    <div class="section-block section-steps">
                        <div class="markdown-preview mb-0" style="font-size: 0.9rem;">${renderMarkdown(testCase.steps)}</div>
                    </div>
                </div>
                ` : ''}
                ${testCase.expected_result ? `
                <div class="mb-0">
                    <h6 class="mb-2" data-i18n="testRun.expectedResult">預期結果</h6>
                    <div class="section-block section-expected">
                        <div class="markdown-preview mb-0" style="font-size: 0.9rem;">${renderMarkdown(testCase.expected_result)}</div>
                    </div>
                </div>
                ` : ''}
                ${attachmentCount > 0 ? `
                <div class="mt-3" id="attachmentsSection">
                    <h6 class="mb-2" data-i18n="testRun.attachments">附件</h6>
                    <div class="section-block section-attachments">
                    <div class="d-flex flex-wrap align-items-center">
                        ${testCase.attachments.map((attachment, index) => {
                            const fileExtension = attachment.name ? attachment.name.split('.').pop().toLowerCase() : '';
                            let iconClass = 'fas fa-file';
                            let iconColor = 'text-secondary';
                            switch(fileExtension) {
                                case 'pdf': iconClass = 'fas fa-file-pdf'; iconColor = 'text-danger'; break;
                                case 'doc': case 'docx': iconClass = 'fas fa-file-word'; iconColor = 'text-primary'; break;
                                case 'xls': case 'xlsx': iconClass = 'fas fa-file-excel'; iconColor = 'text-success'; break;
                                case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': case 'webp': iconClass = 'fas fa-file-image'; iconColor = 'text-info'; break;
                                case 'txt': iconClass = 'fas fa-file-alt'; iconColor = 'text-secondary'; break;
                                case 'zip': case 'rar': case '7z': iconClass = 'fas fa-file-archive'; iconColor = 'text-warning'; break;
                                default: iconClass = 'fas fa-file'; iconColor = 'text-secondary';
                            }
                            const attachmentToken = attachment.file_token || attachment.token || '';
                            const attachmentName = attachment.name || ('附件 ' + (index + 1));
                            const attachmentUrl = attachment.url || '';
                            return '<span class="d-inline-flex align-items-center me-3 mb-2 attachment-item" '
                                + 'style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background-color 0.15s;" '
                                + 'onclick="handleAttachmentClick(\'' + escapeHtml(attachmentName) + '\', \'' + attachmentToken + '\', \'' + attachmentUrl + '\')" '
                                + 'onmouseover="this.style.backgroundColor=\'var(--tr-bg-light)\'" '
                                + 'onmouseout="this.style.backgroundColor=\'transparent\'" '
                                + 'title="點擊查看附件: ' + escapeHtml(attachmentName) + '">'
                                + '<i class="' + iconClass + ' ' + iconColor + ' me-1"></i>'
                                + '<small style="text-decoration: underline; color: var(--tr-primary);">' + escapeHtml(attachmentName) + '</small>'
                                + '</span>';
                        }).join('')}
                    </div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>`;

    return { fixedHtml, scrollableHtml };
}


function renderModalHeaderResult(testCase) {
    const container = document.getElementById('testCaseDetailHeaderResult');
    if (!container) return;

    const item = getItemByTestCaseNumber(testCase.test_case_number);
    const currentResult = item ? (item.test_result || '') : '';
    const canEdit = testRunConfig && testRunConfig.status === 'active';

    if (canEdit && item) {
        container.innerHTML = `
            <select class="form-select form-select-sm result-selector-lg ${getResultClass(currentResult)}" 
                    onchange="updateSelectClass(this); updateTestResult(${item.id}, this.value)">
                <option value="">${escapeHtml('{{ i18n.t("testRun.notExecuted") if i18n else "未執行" }}')}</option>
                <option value="Passed" ${currentResult === 'Passed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.passed") if i18n else "通過" }}')}</option>
                <option value="Failed" ${currentResult === 'Failed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.failed") if i18n else "失敗" }}')}</option>
                <option value="Retest" ${currentResult === 'Retest' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.retest") if i18n else "重測" }}')}</option>
                <option value="Not Available" ${currentResult === 'Not Available' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notAvailable") if i18n else "不適用" }}')}</option>
            </select>
        `;
        const select = container.querySelector('select');
        if (select) updateSelectClass(select);
    } else {
        container.innerHTML = `
            <span class="badge result-badge-lg ${getResultClass(currentResult)}">${getResultText(currentResult)}</span>
        `;
    }
}

// 依 test_case_number 找到對應 item
function getItemByTestCaseNumber(testCaseNumber) {
    return (testRunItems || []).find(i => i.test_case_number === testCaseNumber);
}

async function renderResultHistoryTimeline(testCase) {
    try {
        const pane = document.getElementById('testCaseDetailTimelinePane');
        const loading = document.getElementById('timelineLoading');
        const empty = document.getElementById('timelineEmpty');
        const list = document.getElementById('timelineList');
        if (!pane || !list) return;

        // 顯示區塊與載入中
        pane.style.display = 'block';
        loading.style.display = 'block';
        empty.style.display = 'none';
        list.innerHTML = '';

        const item = getItemByTestCaseNumber(testCase.test_case_number);
        if (!item) { loading.style.display = 'none'; empty.style.display = 'block'; return; }

        const resp = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${item.id}/result-history?limit=50`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const records = await resp.json();
        loading.style.display = 'none';

        if (!Array.isArray(records) || records.length === 0) {
            empty.style.display = 'block';
            return;
        }

        // 生成 timeline 項目
        const rows = records.map(r => {
            const time = r.changed_at ? AppUtils.formatDate(r.changed_at, 'datetime') : '';
            const from = r.prev_result ? getResultText(r.prev_result) : '{{ i18n.t("testRun.notExecuted") if i18n else "未執行" }}';
            const to = r.new_result ? getResultText(r.new_result) : '{{ i18n.t("testRun.notExecuted") if i18n else "未執行" }}';
            const badgeFrom = `<span class="badge ${getResultClass(r.prev_result)}">${from}</span>`;
            const badgeTo = `<span class="badge ${getResultClass(r.new_result)}">${to}</span>`;
            const who = r.changed_by_name || '';
            const reason = r.change_reason ? `<div class="text-muted small">${escapeHtml(r.change_reason)}</div>` : '';
            return `
                <div class="timeline-item">
                    <div class="time">${time}${who ? ` · ${escapeHtml(who)}` : ''}</div>
                    <div class="status">${badgeFrom} <i class="fas fa-arrow-right mx-1"></i> ${badgeTo}</div>
                    ${reason}
                    <div class="timeline-divider"></div>
                </div>
            `;
        }).join('');
        list.innerHTML = rows;

        // 綁定刷新按鈕
        const refreshBtn = document.getElementById('refreshTimelineBtn');
        if (refreshBtn) refreshBtn.onclick = () => renderResultHistoryTimeline(testCase);
    } catch (e) {
        const loading = document.getElementById('timelineLoading');
        const empty = document.getElementById('timelineEmpty');
        if (loading) loading.style.display = 'none';
        if (empty) empty.style.display = 'block';
        console.warn('load result history failed:', e);
    }
}

// 點擊 Basic Info 的附件摘要時，捲動到內容區的附件區塊
function scrollToAttachments() {
    try {
        const container = document.getElementById('testCaseDetailScrollable');
        const target = container ? container.querySelector('#attachmentsSection') : null;
        if (container && target) {
            const top = target.offsetTop - 8; // 預留一點上邊距
            container.scrollTo({ top, behavior: 'smooth' });
        }
    } catch (_) {}
}

// 鍵盤支援：在執行頁的 Test Case 詳細 Modal 使用左右鍵切換
function handleExecDetailModalKeydown(e) {
    try {
        const modal = document.getElementById('testCaseDetailModal');
        if (!modal || !modal.classList.contains('show')) return;
        // 避免在輸入元件或可編輯區域觸發
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        const isEditable = e.target && (e.target.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select');
        if (isEditable) return;
        if (!currentDetailTestCase) return;
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateExecCase(currentDetailTestCase, -1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateExecCase(currentDetailTestCase, 1);
        }
    } catch (_) {}
}

// ====== 本地快取（localStorage）工具 ======
function getCacheKey(testCaseNumber) {
    // 以 teamId + testCaseNumber 組成個人快取 key
    const team = currentTeamId || 'unknown';
    return `${TEST_CASE_CACHE_PREFIX}:${team}:${testCaseNumber}`;
}

function getCachedTestCase(testCaseNumber) {
    try {
        const key = getCacheKey(testCaseNumber);
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed.ts !== 'number' || !parsed.data) return null;
        return parsed;
    } catch (_) {
        return null;
    }
}

function setCachedTestCase(testCaseNumber, testCaseData) {
    try {
        const key = getCacheKey(testCaseNumber);
        const payload = { ts: Date.now(), data: testCaseData };
        localStorage.setItem(key, JSON.stringify(payload));
    } catch (_) {
        // 忽略快取錯誤（例如超出容量）
    }
}

// 判斷是否為新鮮快取
function isFreshCache(cached) {
    return cached && (Date.now() - cached.ts) < TEST_CASE_CACHE_TTL_MS;
}

// 以 test_case_number 從後端取得詳細並寫入快取
async function fetchAndCacheTestCase(testCaseNumber) {
    if (!testCaseNumber) return;
    try {
        const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
        url.searchParams.set('search', testCaseNumber);
        url.searchParams.set('limit', '1');
        const resp = await fetch(url);
        if (!resp.ok) return;
        const list = await resp.json();
        const tc = Array.isArray(list) ? list.find(t => t.test_case_number === testCaseNumber) : null;
        if (tc) setCachedTestCase(testCaseNumber, tc);
    } catch (_) {}
}

// 針對目前的 Test Run Items 預先載入所有 Test Case 詳細
async function prefetchTestCasesForItems(items) {
    try {
        const numbers = (items || []).map(i => i.test_case_number).filter(Boolean);
        if (numbers.length === 0) return;
        // 過濾已新鮮快取者
        const toFetch = numbers.filter(n => !isFreshCache(getCachedTestCase(n)));
        if (toFetch.length === 0) return;
        // 控制併發量，避免過多同時請求
        const queue = Array.from(new Set(toFetch)); // 去重
        const concurrency = 5;
        const workers = new Array(Math.min(concurrency, queue.length)).fill(0).map(async () => {
            while (queue.length > 0) {
                const n = queue.pop(); // 先取出，再 await，避免競態
                await fetchAndCacheTestCase(n);
            }
        });
        await Promise.all(workers);
    } catch (e) {
        console.debug('prefetch test cases skipped:', e);
    }
}

// 參考 Test Case Management 的做法：
// 一次性抓取整個團隊的 Test Cases，將與本次 Test Run 有關的案例寫入快取
async function preloadAllTeamTestCasesForRun(items) {
    try {
        const resp = await fetch(`/api/teams/${currentTeamId}/testcases/`);
        if (!resp.ok) {
            // 若整批抓取失敗，退回逐筆預抓策略
            await prefetchTestCasesForItems(items);
            return;
        }
        const all = await resp.json();
        const need = new Set((items || []).map(i => i.test_case_number).filter(Boolean));
        if (!all || !Array.isArray(all)) return;
        for (const tc of all) {
            if (tc && tc.test_case_number && need.has(tc.test_case_number)) {
                setCachedTestCase(tc.test_case_number, tc);
            }
        }
    } catch (e) {
        console.debug('preloadAllTeamTestCasesForRun failed, fallback to prefetch each:', e);
        await prefetchTestCasesForItems(items);
    }
}

// 在 Test Run 項目清單中，根據目前 Test Case 移動到前/後一筆
async function navigateExecCase(currentTestCase, step) {
    if (!Array.isArray(testRunItems) || testRunItems.length === 0) return;
    const idx = testRunItems.findIndex(i => i.test_case_number === currentTestCase.test_case_number);
    if (idx < 0) return;
    const newIdx = idx + step;
    if (newIdx < 0 || newIdx >= testRunItems.length) return;
    const nextItem = testRunItems[newIdx];
    if (!nextItem) return;
    // 重用現有流程：以 test_case_number 載入詳細
    await showTestCaseDetailModal(nextItem.test_case_number);
}

// 移除 Modal 內更新結果的輔助函式（已回滾設計）

function showTestCaseDetailError() {
    document.getElementById('testCaseDetailLoading').style.display = 'none';
    document.getElementById('testCaseDetailContent').style.display = 'none';
    document.getElementById('testCaseDetailError').style.display = 'block';
}

async function updateAssignee(itemId, assigneeName) {
    try {
        // 清理輸入值
        const cleanAssignee = assigneeName ? assigneeName.trim() : '';
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                assignee_name: cleanAssignee || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        // 更新本地資料
        const itemIndex = testRunItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            testRunItems[itemIndex].assignee_name = cleanAssignee || null;
        }
        
        // 不顯示成功訊息，讓編輯過程更流暢
        
    } catch (error) {
        console.error('Failed to update assignee:', error);
        AppUtils.showError('{{ i18n.t("testRun.updateAssigneeFailed") if i18n else "更新執行者失敗" }}' + ': ' + error.message);
        
        // 恢復原始值
        const input = document.querySelector(`input[data-item-id="${itemId}"]`);
        if (input) {
            const originalItem = testRunItems.find(item => item.id === itemId);
            input.value = originalItem ? (originalItem.assignee_name || '') : '';
        }
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Markdown 渲染輔助函數
function renderMarkdown(content) {
    if (!content) return '';
    
    if (typeof marked !== 'undefined') {
        try {
            return marked.parse(content);
        } catch (error) {
            console.error('Markdown parse error:', error);
            // 如果 Markdown 渲染失敗，回退到純文字顯示
            return `<pre style="white-space: pre-wrap; font-size: 0.9rem;">${escapeHtml(content)}</pre>`;
        }
    } else {
        // 如果 marked 庫未載入，回退到純文字顯示
        return `<pre style="white-space: pre-wrap; font-size: 0.9rem;">${escapeHtml(content)}</pre>`;
    }
}

// 處理附件點擊事件
function handleAttachmentClick(attachmentName, fileToken, fileUrl) {
    console.log('附件點擊:', { attachmentName, fileToken, fileUrl });
    
    // 如果有 file_token 或 file_url，嘗試通過代理 API 下載
    if ((fileToken && fileToken.trim() !== '') || (fileUrl && fileUrl.trim() !== '')) {
        try {
            // 構建代理下載 URL
            const proxyUrl = new URL(`/api/attachments/teams/${currentTeamId}/attachments/download`, window.location.origin);
            
            if (fileUrl && fileUrl.trim() !== '') {
                proxyUrl.searchParams.set('file_url', fileUrl);
            } else if (fileToken && fileToken.trim() !== '') {
                proxyUrl.searchParams.set('file_token', fileToken);
            }
            
            if (attachmentName && attachmentName.trim() !== '') {
                proxyUrl.searchParams.set('filename', attachmentName);
            }
            
            // 在新窗口中打開代理下載 URL
            window.open(proxyUrl.toString(), '_blank', 'noopener,noreferrer');
            return;
        } catch (error) {
            console.error('構建代理下載 URL 失敗:', error);
        }
    }
    
    // 如果沒有有效的 token 或 URL，顯示附件信息
    console.log('沒有有效的附件 token 或 URL，顯示附件信息');
    showAttachmentInfo(attachmentName, fileToken, fileUrl);
}

// 顯示附件信息
function showAttachmentInfo(attachmentName, fileToken, fileUrl) {
    const modalHtml = `
        <div class="modal fade" id="attachmentInfoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-paperclip me-2"></i>
                            <span data-i18n="testRun.attachmentDetails">附件詳情</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold" data-i18n="testRun.attachmentName">附件名稱:</td>
                                <td>${escapeHtml(attachmentName)}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">File Token:</td>
                                <td><code style="font-size: 0.8rem; word-break: break-all;">${escapeHtml(fileToken)}</code></td>
                            </tr>
                            ${fileUrl ? `
                            <tr>
                                <td class="fw-bold">URL:</td>
                                <td><a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener">${escapeHtml(fileUrl)}</a></td>
                            </tr>
                            ` : ''}
                        </table>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span data-i18n="testRun.attachmentNote">此附件存儲在 Lark 中。如需下載，請前往原始 Lark 多維表格查看。</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                        ${(fileUrl || fileToken) ? `
                        <button type="button" class="btn btn-primary" onclick="handleAttachmentDownload('${escapeHtml(attachmentName)}', '${fileToken}', '${escapeHtml(fileUrl)}')">
                            <i class="fas fa-download me-2"></i>
                            <span data-i18n="testRun.downloadAttachment">下載附件</span>
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>`;
    
    // 移除舊的模態框（如果存在）
    const existingModal = document.getElementById('attachmentInfoModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新的模態框到頁面
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('attachmentInfoModal'));
    
    // 應用翻譯（如果可用）
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(document.getElementById('attachmentInfoModal'));
    }
    
    modal.show();
    
    // 模態框關閉後清理
    document.getElementById('attachmentInfoModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// 處理附件下載（從信息模態框中）
function handleAttachmentDownload(attachmentName, fileToken, fileUrl) {
    console.log('附件下載:', { attachmentName, fileToken, fileUrl });
    
    if ((fileToken && fileToken.trim() !== '') || (fileUrl && fileUrl.trim() !== '')) {
        try {
            // 構建代理下載 URL
            const proxyUrl = new URL(`/api/attachments/teams/${currentTeamId}/attachments/download`, window.location.origin);
            
            if (fileUrl && fileUrl.trim() !== '') {
                proxyUrl.searchParams.set('file_url', fileUrl);
            } else if (fileToken && fileToken.trim() !== '') {
                proxyUrl.searchParams.set('file_token', fileToken);
            }
            
            if (attachmentName && attachmentName.trim() !== '') {
                proxyUrl.searchParams.set('filename', attachmentName);
            }
            
            // 在新窗口中打開代理下載 URL
            window.open(proxyUrl.toString(), '_blank', 'noopener,noreferrer');
        } catch (error) {
            console.error('構建附件下載 URL 失敗:', error);
            AppUtils.showError('附件下載失敗: ' + error.message);
        }
    } else {
        AppUtils.showWarning('沒有可用的附件下載信息');
    }
}
</script>
{% endblock %}
/* reverted: no fixed height for attachments list */
