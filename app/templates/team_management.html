{% extends "base.html" %}

{% block title %}團隊管理 - Test Case Repository Web Tool{% endblock %}

{% block page_title_text %}
<span class="text-primary" data-i18n="team.management">團隊管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="team.subtitle">管理各團隊的 Lark 多維表格連結設定</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
    <button type="button" class="btn btn-primary" id="createTeamBtn">
        <i class="fas fa-plus me-2"></i><span data-i18n="team.createTeam">新增團隊</span>
    </button>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- 載入狀態 -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="messages.loadingTeams">載入團隊資料中...</div>
    </div>

    <!-- 團隊列表區域 -->
    <div id="teams-section">
        <div class="row" id="teams-container">
            <!-- 團隊卡片將在此處動態生成 -->
        </div>
    </div>

    <!-- 無團隊時的提示 -->
    <div id="no-teams-section" class="text-center py-5" style="display: none;">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted mb-2" data-i18n="team.noTeams">尚未建立任何團隊</h5>
        <p class="text-muted" data-i18n="team.noTeamsHint">點擊上方「新增團隊」按鈕開始建立第一個團隊</p>
    </div>
</div>

<!-- 建立/編輯團隊模態視窗 -->
<div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamModalLabel" data-i18n="team.createTeam">新增團隊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <form id="teamForm">
                    <!-- 基本資訊 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3" data-i18n="team.basicInfo">基本資訊</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="teamName" class="form-label"><span data-i18n="team.teamName">團隊名稱</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teamName" name="name" required 
                                       data-i18n-placeholder="team.teamNamePlaceholder">
                            </div>
                            <div class="col-md-6">
                                <label for="teamDescription" class="form-label" data-i18n="team.teamDescription">團隊描述</label>
                                <input type="text" class="form-control" id="teamDescription" name="description" 
                                       data-i18n-placeholder="team.teamDescriptionPlaceholder">
                            </div>
                        </div>
                    </div>

                    <!-- Lark 設定 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-table me-2"></i><span data-i18n="team.larkSettings">Lark 多維表格設定</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="wikiToken" class="form-label"><span data-i18n="team.wikiToken">Wiki Token</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="wikiToken" name="wiki_token" required 
                                       data-i18n-placeholder="team.wikiTokenPlaceholder">
                                <div class="form-text" data-i18n="team.wikiTokenHelp">從 Lark 多維表格分享連結中取得</div>
                            </div>
                            <div class="col-md-6">
                                <label for="testCaseTableId" class="form-label"><span data-i18n="team.testCaseTableId">Test Case 表格 ID</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseTableId" name="test_case_table_id" required 
                                       data-i18n-placeholder="team.testCaseTableIdPlaceholder">
                                <div class="form-text" data-i18n="team.testCaseTableIdHelp">測試案例表格的 ID</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-info" id="validateLarkBtn">
                                        <i class="fas fa-check me-2"></i><span data-i18n="team.validateConnection">驗證 Lark 連線</span>
                                    </button>
                                    <div id="larkValidationResult" class="ms-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- 團隊設定 -->
                    <div class="mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i><span data-i18n="team.teamSettings">團隊設定</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableNotifications" name="enable_notifications" checked>
                                    <label class="form-check-label" for="enableNotifications" data-i18n="team.enableNotifications">啟用通知</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCreateBugs" name="auto_create_bugs">
                                    <label class="form-check-label" for="autoCreateBugs" data-i18n="team.autoCreateBugs">自動建立 Bug</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeamBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="team.saveTeam">儲存團隊</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let teams = [];
let currentEditTeam = null;

document.addEventListener('DOMContentLoaded', function() {
    initTeamManagement();
});

function initTeamManagement() {
    // 綁定事件監聽器
    document.getElementById('createTeamBtn').addEventListener('click', showCreateTeamModal);
    document.getElementById('refreshBtn').addEventListener('click', loadTeams);
    document.getElementById('saveTeamBtn').addEventListener('click', saveTeam);
    document.getElementById('validateLarkBtn').addEventListener('click', validateLarkConnection);

    // 載入團隊列表
    loadTeams();
}

async function loadTeams() {
    try {
        showLoading();
        
        const response = await fetch('/api/teams/');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        teams = await response.json();
        renderTeams();
        
    } catch (error) {
        console.error('Load teams failed:', error);
        if (AppUtils && AppUtils.showError) {
            const errorMsg = window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗';
            AppUtils.showError(errorMsg + '：' + error.message);
        } else {
            console.error('AppUtils not available:', error.message);
        }
        showNoTeams();
    } finally {
        hideLoading();
    }
}

function renderTeams() {
    if (!teams || teams.length === 0) {
        showNoTeams();
        return;
    }
    
    showTeamsList();
    renderTeamCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('teams-section').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function showNoTeams() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'block';
}

function showTeamsList() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function renderTeamCards() {
    const container = document.getElementById('teams-container');
    
    const teamsHtml = teams.map(team => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 team-card">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 18px; font-weight: bold;">
                                ${getTeamInitials(team.name)}
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title text-primary mb-1">${escapeHtml(team.name)}</h5>
                            <p class="card-text text-muted small mb-0">
                                ${escapeHtml(team.description || (window.i18n ? window.i18n.t('common.noDescription') : '無描述'))}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-table me-2 text-success"></i>
                            <small class="text-muted">Lark: ${team.is_lark_configured ? 
                                (window.i18n ? window.i18n.t('team.configured') : '已設定') : 
                                (window.i18n ? window.i18n.t('team.notConfigured') : '未設定')}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-list me-2 text-muted"></i>
                            <small class="text-muted">${window.i18n ? 
                                window.i18n.t('team.testCaseCount', {count: team.test_case_count || 0}) : 
                                `${team.test_case_count || 0} 個測試案例`}</small>
                        </div>
                    </div>
                    
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTeam(${team.id})" title="${window.i18n ? window.i18n.t('common.edit') : '編輯'}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="selectTeam(${team.id})" title="${window.i18n ? window.i18n.t('tooltips.enterTeam') : '進入團隊'}">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTeam(${team.id})" title="${window.i18n ? window.i18n.t('common.delete') : '刪除'}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = teamsHtml;
    
    // Retranslate the newly added content
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate();
    }
}

function showCreateTeamModal() {
    currentEditTeam = null;
    const modalTitle = window.i18n ? window.i18n.t('team.createTeam') : '新增團隊';
    document.getElementById('teamModalLabel').textContent = modalTitle;
    document.getElementById('teamForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

function editTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    currentEditTeam = team;
    const modalTitle = window.i18n ? window.i18n.t('team.editTeam') : '編輯團隊';
    document.getElementById('teamModalLabel').textContent = modalTitle;
    
    // 填入表單資料
    document.getElementById('teamName').value = team.name;
    document.getElementById('teamDescription').value = team.description || '';
    document.getElementById('wikiToken').value = team.lark_config.wiki_token;
    document.getElementById('testCaseTableId').value = team.lark_config.test_case_table_id;
    
    document.getElementById('enableNotifications').checked = team.settings.enable_notifications;
    document.getElementById('autoCreateBugs').checked = team.settings.auto_create_bugs;
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

async function saveTeam() {
    const form = document.getElementById('teamForm');
    const formData = new FormData(form);
    
    // 構建團隊資料
    const teamData = {
        name: formData.get('name'),
        description: formData.get('description') || null,
        lark_config: {
            wiki_token: formData.get('wiki_token'),
            test_case_table_id: formData.get('test_case_table_id')
        },
        settings: {
            enable_notifications: formData.get('enable_notifications') === 'on',
            auto_create_bugs: formData.get('auto_create_bugs') === 'on',
            default_priority: 'Medium'
        }
    };
    
    // 驗證必填欄位
    if (!teamData.name || !teamData.lark_config.wiki_token || !teamData.lark_config.test_case_table_id) {
        const errorMsg = window.i18n ? window.i18n.t('messages.fillRequiredFields') : '請填寫所有必填欄位';
        AppUtils.showError(errorMsg);
        return;
    }
    
    try {
        let url = '/api/teams';
        let method = 'POST';
        
        if (currentEditTeam) {
            url = `/api/teams/${currentEditTeam.id}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(teamData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            const defaultMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
            throw new Error(error.detail || defaultMsg);
        }
        
        const successMsg = currentEditTeam ? 
            (window.i18n ? window.i18n.t('team.teamUpdated') : '團隊更新成功') :
            (window.i18n ? window.i18n.t('team.teamSaved') : '團隊建立成功');
        AppUtils.showSuccess(successMsg);
        
        // 關閉模態視窗
        const modal = bootstrap.Modal.getInstance(document.getElementById('teamModal'));
        modal.hide();
        
        // 重新載入團隊列表
        await loadTeams();
        
    } catch (error) {
        console.error('Save team failed:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
    }
}

async function validateLarkConnection() {
    const wikiToken = document.getElementById('wikiToken').value;
    const testCaseTableId = document.getElementById('testCaseTableId').value;
    const resultDiv = document.getElementById('larkValidationResult');
    
    if (!wikiToken || !testCaseTableId) {
        const warningMsg = window.i18n ? window.i18n.t('team.pleaseEnterToken') : '請先填寫 Wiki Token 和 Test Case 表格 ID';
        showValidationMessage(warningMsg, 'warning');
        return;
    }
    
    const validateBtn = document.getElementById('validateLarkBtn');
    validateBtn.disabled = true;
    const validatingMsg = window.i18n ? window.i18n.t('team.validating') : '驗證中...';
    validateBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${validatingMsg}`;
    
    try {
        const response = await fetch('/api/teams/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: 'test',
                lark_config: {
                    wiki_token: wikiToken,
                    test_case_table_id: testCaseTableId
                },
                settings: {
                    enable_notifications: true,
                    auto_create_bugs: false,
                    default_priority: 'Medium'
                }
            })
        });
        
        const result = await response.json();
        
        if (result.valid) {
            const successMsg = window.i18n ? window.i18n.t('team.connectionValid') : '連線驗證成功';
            showValidationMessage(successMsg, 'success');
        } else {
            const failMsg = window.i18n ? window.i18n.t('team.connectionInvalid') : '連線驗證失敗';
            showValidationMessage(failMsg, 'danger');
        }
        
    } catch (error) {
        console.error('Validation failed:', error);
        const errorMsg = window.i18n ? window.i18n.t('team.connectionError') : '驗證過程發生錯誤';
        showValidationMessage(errorMsg, 'danger');
    } finally {
        validateBtn.disabled = false;
        const validateText = window.i18n ? window.i18n.t('team.validateConnection') : '驗證 Lark 連線';
        validateBtn.innerHTML = `<i class="fas fa-check me-2"></i>${validateText}`;
    }
}

function selectTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    // 儲存選擇的團隊
    if (AppUtils && AppUtils.setCurrentTeam) {
        AppUtils.setCurrentTeam(team);
        const successMsg = window.i18n ? 
            window.i18n.t('team.teamSelected', {name: team.name}) : 
            `已選擇團隊：${team.name}`;
        AppUtils.showSuccess(successMsg);
        
        // 跳轉到測試案例管理
        setTimeout(() => {
            window.location.href = '/test-case-management';
        }, 500);
    }
}

async function deleteTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    const confirmMsg = window.i18n ? 
        window.i18n.t('team.confirmDelete', {name: team.name}) : 
        `確定要刪除團隊「${team.name}」嗎？此操作無法復原。`;
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/teams/${teamId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
            throw new Error(errorMsg);
        }
        
        const successMsg = window.i18n ? window.i18n.t('team.teamDeleted') : '團隊刪除成功';
        AppUtils.showSuccess(successMsg);
        await loadTeams();
        
    } catch (error) {
        console.error('Delete team failed:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
    }
}

function getTeamInitials(name) {
    if (!name) return 'T';
    
    return name
        .split(' ')
        .map(word => word.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
}

function showValidationMessage(message, type) {
    const resultDiv = document.getElementById('larkValidationResult');
    
    // 設定顏色和圖示
    let iconClass, textClass;
    switch(type) {
        case 'success':
            iconClass = 'fas fa-check-circle';
            textClass = 'text-success';
            break;
        case 'danger':
            iconClass = 'fas fa-times-circle';
            textClass = 'text-danger';
            break;
        case 'warning':
            iconClass = 'fas fa-exclamation-triangle';
            textClass = 'text-warning';
            break;
        default:
            iconClass = 'fas fa-info-circle';
            textClass = 'text-info';
    }
    
    // 顯示訊息
    resultDiv.innerHTML = `<small class="${textClass}"><i class="${iconClass} me-1"></i>${message}</small>`;
    
    // 3秒後自動清除
    setTimeout(() => {
        resultDiv.innerHTML = '';
    }, 3000);
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// 更新頁面標題翻譯
function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('team.management') : '團隊管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// 監聽 i18n 初始化和語言變更事件
document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);
</script>

<style>
.team-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
}

.team-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.btn-group .btn {
    flex: 1;
}

.form-text {
    font-size: 0.8rem;
}

#teamModal .modal-lg {
    max-width: 800px;
}
</style>
{% endblock %}