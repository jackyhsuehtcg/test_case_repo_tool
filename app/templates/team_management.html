{% extends "base.html" %}

{% block title %}團隊管理 - Test Case Repository Web Tool{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頂部標題列 -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="text-primary mb-1">團隊管理</h1>
                    <p class="text-muted mb-0">管理各團隊的 Lark 多維表格連結設定</p>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-home me-2"></i>回到首頁
                    </a>
                    <button type="button" class="btn btn-primary" id="createTeamBtn">
                        <i class="fas fa-plus me-2"></i>新增團隊
                    </button>
                    <button type="button" class="btn btn-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>重新整理
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入狀態 -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">載入中...</span>
        </div>
        <div class="mt-3 text-muted">載入團隊資料中...</div>
    </div>

    <!-- 團隊列表區域 -->
    <div id="teams-section">
        <div class="row" id="teams-container">
            <!-- 團隊卡片將在此處動態生成 -->
        </div>
    </div>

    <!-- 無團隊時的提示 -->
    <div id="no-teams-section" class="text-center py-5" style="display: none;">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted mb-2">尚未建立任何團隊</h5>
        <p class="text-muted">點擊上方「新增團隊」按鈕開始建立第一個團隊</p>
    </div>
</div>

<!-- 建立/編輯團隊模態視窗 -->
<div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamModalLabel">新增團隊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <form id="teamForm">
                    <!-- 基本資訊 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">基本資訊</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="teamName" class="form-label">團隊名稱 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teamName" name="name" required 
                                       placeholder="例：Frontend Team">
                            </div>
                            <div class="col-md-6">
                                <label for="teamDescription" class="form-label">團隊描述</label>
                                <input type="text" class="form-control" id="teamDescription" name="description" 
                                       placeholder="團隊簡短描述">
                            </div>
                        </div>
                    </div>

                    <!-- Lark 設定 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-table me-2"></i>Lark 多維表格設定
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="wikiToken" class="form-label">Wiki Token <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="wikiToken" name="wiki_token" required 
                                       placeholder="例：Q4XxwaS2Cif80DkAku9lMKuAgof">
                                <div class="form-text">從 Lark 多維表格分享連結中取得</div>
                            </div>
                            <div class="col-md-6">
                                <label for="testCaseTableId" class="form-label">Test Case 表格 ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseTableId" name="test_case_table_id" required 
                                       placeholder="例：tblEAg8srqYs0rzi">
                                <div class="form-text">測試案例表格的 ID</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-info" id="validateLarkBtn">
                                        <i class="fas fa-check me-2"></i>驗證 Lark 連線
                                    </button>
                                    <div id="larkValidationResult" class="ms-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- 團隊設定 -->
                    <div class="mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-cog me-2"></i>團隊設定
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableNotifications" name="enable_notifications" checked>
                                    <label class="form-check-label" for="enableNotifications">啟用通知</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCreateBugs" name="auto_create_bugs">
                                    <label class="form-check-label" for="autoCreateBugs">自動建立 Bug</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeamBtn">
                    <i class="fas fa-save me-2"></i>儲存團隊
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let teams = [];
let currentEditTeam = null;

document.addEventListener('DOMContentLoaded', function() {
    initTeamManagement();
});

function initTeamManagement() {
    // 綁定事件監聽器
    document.getElementById('createTeamBtn').addEventListener('click', showCreateTeamModal);
    document.getElementById('refreshBtn').addEventListener('click', loadTeams);
    document.getElementById('saveTeamBtn').addEventListener('click', saveTeam);
    document.getElementById('validateLarkBtn').addEventListener('click', validateLarkConnection);

    // 載入團隊列表
    loadTeams();
}

async function loadTeams() {
    try {
        showLoading();
        
        const response = await fetch('/api/teams/');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        teams = await response.json();
        renderTeams();
        
    } catch (error) {
        console.error('載入團隊失敗:', error);
        if (AppUtils && AppUtils.showError) {
            AppUtils.showError('載入團隊失敗：' + error.message);
        } else {
            console.error('AppUtils 不可用:', error.message);
        }
        showNoTeams();
    } finally {
        hideLoading();
    }
}

function renderTeams() {
    if (!teams || teams.length === 0) {
        showNoTeams();
        return;
    }
    
    showTeamsList();
    renderTeamCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('teams-section').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function showNoTeams() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('teams-section').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'block';
}

function showTeamsList() {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('no-teams-section').style.display = 'none';
    document.getElementById('teams-section').style.display = 'block';
}

function renderTeamCards() {
    const container = document.getElementById('teams-container');
    
    const teamsHtml = teams.map(team => `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 team-card">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 18px; font-weight: bold;">
                                ${getTeamInitials(team.name)}
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title text-primary mb-1">${escapeHtml(team.name)}</h5>
                            <p class="card-text text-muted small mb-0">
                                ${escapeHtml(team.description || '無描述')}
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-table me-2 text-success"></i>
                            <small class="text-muted">Lark: ${team.is_lark_configured ? '已設定' : '未設定'}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-list me-2 text-muted"></i>
                            <small class="text-muted">${team.test_case_count || 0} 個測試案例</small>
                        </div>
                    </div>
                    
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTeam(${team.id})" title="編輯">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="selectTeam(${team.id})" title="進入團隊">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTeam(${team.id})" title="刪除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = teamsHtml;
}

function showCreateTeamModal() {
    currentEditTeam = null;
    document.getElementById('teamModalLabel').textContent = '新增團隊';
    document.getElementById('teamForm').reset();
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

function editTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    currentEditTeam = team;
    document.getElementById('teamModalLabel').textContent = '編輯團隊';
    
    // 填入表單資料
    document.getElementById('teamName').value = team.name;
    document.getElementById('teamDescription').value = team.description || '';
    document.getElementById('wikiToken').value = team.lark_config.wiki_token;
    document.getElementById('testCaseTableId').value = team.lark_config.test_case_table_id;
    
    document.getElementById('enableNotifications').checked = team.settings.enable_notifications;
    document.getElementById('autoCreateBugs').checked = team.settings.auto_create_bugs;
    
    const modal = new bootstrap.Modal(document.getElementById('teamModal'));
    modal.show();
}

async function saveTeam() {
    const form = document.getElementById('teamForm');
    const formData = new FormData(form);
    
    // 構建團隊資料
    const teamData = {
        name: formData.get('name'),
        description: formData.get('description') || null,
        lark_config: {
            wiki_token: formData.get('wiki_token'),
            test_case_table_id: formData.get('test_case_table_id')
        },
        settings: {
            enable_notifications: formData.get('enable_notifications') === 'on',
            auto_create_bugs: formData.get('auto_create_bugs') === 'on',
            default_priority: 'Medium'
        }
    };
    
    // 驗證必填欄位
    if (!teamData.name || !teamData.lark_config.wiki_token || !teamData.lark_config.test_case_table_id) {
        AppUtils.showError('請填寫所有必填欄位');
        return;
    }
    
    try {
        let url = '/api/teams';
        let method = 'POST';
        
        if (currentEditTeam) {
            url = `/api/teams/${currentEditTeam.id}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(teamData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '儲存團隊失敗');
        }
        
        AppUtils.showSuccess(currentEditTeam ? '團隊更新成功' : '團隊建立成功');
        
        // 關閉模態視窗
        const modal = bootstrap.Modal.getInstance(document.getElementById('teamModal'));
        modal.hide();
        
        // 重新載入團隊列表
        await loadTeams();
        
    } catch (error) {
        console.error('儲存團隊失敗:', error);
        AppUtils.showError('儲存團隊失敗：' + error.message);
    }
}

async function validateLarkConnection() {
    const wikiToken = document.getElementById('wikiToken').value;
    const testCaseTableId = document.getElementById('testCaseTableId').value;
    const resultDiv = document.getElementById('larkValidationResult');
    
    if (!wikiToken || !testCaseTableId) {
        showValidationMessage('請先填寫 Wiki Token 和 Test Case 表格 ID', 'warning');
        return;
    }
    
    const validateBtn = document.getElementById('validateLarkBtn');
    validateBtn.disabled = true;
    validateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';
    
    try {
        const response = await fetch('/api/teams/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: 'test',
                lark_config: {
                    wiki_token: wikiToken,
                    test_case_table_id: testCaseTableId
                },
                settings: {
                    enable_notifications: true,
                    auto_create_bugs: false,
                    default_priority: 'Medium'
                }
            })
        });
        
        const result = await response.json();
        
        if (result.valid) {
            showValidationMessage('連線驗證成功', 'success');
        } else {
            showValidationMessage('連線驗證失敗', 'danger');
        }
        
    } catch (error) {
        console.error('驗證失敗:', error);
        showValidationMessage('驗證過程發生錯誤', 'danger');
    } finally {
        validateBtn.disabled = false;
        validateBtn.innerHTML = '<i class="fas fa-check me-2"></i>驗證 Lark 連線';
    }
}

function selectTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    // 儲存選擇的團隊
    if (AppUtils && AppUtils.setCurrentTeam) {
        AppUtils.setCurrentTeam(team);
        AppUtils.showSuccess(`已選擇團隊：${team.name}`);
        
        // 跳轉到測試案例管理
        setTimeout(() => {
            window.location.href = '/test-case-management';
        }, 500);
    }
}

async function deleteTeam(teamId) {
    const team = teams.find(t => t.id === teamId);
    if (!team) return;
    
    if (!confirm(`確定要刪除團隊「${team.name}」嗎？此操作無法復原。`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/teams/${teamId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('刪除團隊失敗');
        }
        
        AppUtils.showSuccess('團隊刪除成功');
        await loadTeams();
        
    } catch (error) {
        console.error('刪除團隊失敗:', error);
        AppUtils.showError('刪除團隊失敗：' + error.message);
    }
}

function getTeamInitials(name) {
    if (!name) return 'T';
    
    return name
        .split(' ')
        .map(word => word.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
}

function showValidationMessage(message, type) {
    const resultDiv = document.getElementById('larkValidationResult');
    
    // 設定顏色和圖示
    let iconClass, textClass;
    switch(type) {
        case 'success':
            iconClass = 'fas fa-check-circle';
            textClass = 'text-success';
            break;
        case 'danger':
            iconClass = 'fas fa-times-circle';
            textClass = 'text-danger';
            break;
        case 'warning':
            iconClass = 'fas fa-exclamation-triangle';
            textClass = 'text-warning';
            break;
        default:
            iconClass = 'fas fa-info-circle';
            textClass = 'text-info';
    }
    
    // 顯示訊息
    resultDiv.innerHTML = `<small class="${textClass}"><i class="${iconClass} me-1"></i>${message}</small>`;
    
    // 3秒後自動清除
    setTimeout(() => {
        resultDiv.innerHTML = '';
    }, 3000);
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

<style>
.team-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
}

.team-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.btn-group .btn {
    flex: 1;
}

.form-text {
    font-size: 0.8rem;
}

#teamModal .modal-lg {
    max-width: 800px;
}
</style>
{% endblock %}