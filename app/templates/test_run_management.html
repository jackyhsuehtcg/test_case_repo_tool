{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.management') if i18n else '測試執行管理' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Test Run 入口頁面樣式 -->
<style>
/* Test Run 卡片樣式 */
.test-run-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
    cursor: pointer;
}

.test-run-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.test-run-card:hover .card-title {
    color: var(--tr-primary-dark) !important;
}

.test-run-card .card-body {
    padding: 1.25rem;
}

/* 新增 Test Run 卡片樣式 */
.add-test-run-card {
    transition: all 0.2s ease;
    border: 2px dashed var(--tr-border-light);
    cursor: pointer;
    background-color: var(--tr-bg-light);
}

.add-test-run-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
    background-color: var(--tr-primary-light);
}

.add-test-run-card:hover h5,
.add-test-run-card:hover h6 {
    color: var(--tr-primary-dark) !important;
}

.add-test-run-card:hover .fas {
    color: var(--tr-primary-dark) !important;
}

/* 進度條樣式 */
.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    border-radius: 4px;
}

/* 狀態標籤樣式 */
.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
}

.status-active { background-color: #d1ecf1; color: #0c5460; }
.status-completed { background-color: #d4edda; color: #155724; }
.status-draft { background-color: #fff3cd; color: #856404; }
.status-archived { background-color: #f8d7da; color: #721c24; }

/* 統計資訊樣式 */
.stats-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.stats-item:last-child {
    margin-bottom: 0;
}

.stats-icon {
    width: 1.25rem;
    text-align: center;
    margin-right: 0.5rem;
    opacity: 0.7;
}

/* 載入動畫 */
.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頁面標題與工具列 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1" data-i18n="testRun.management">測試執行管理</h1>
            <p class="text-muted" data-i18n="testRun.subtitle">管理測試執行記錄，追蹤測試進度和結果</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
            </a>
            <button type="button" class="btn btn-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
            </button>
        </div>
    </div>

    <!-- 載入狀態 -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="testRun.loadingConfigs">載入測試執行配置中...</div>
    </div>

    <!-- 無配置時的提示區域 -->
    <div id="no-configs-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card text-center add-test-run-card" onclick="openCreateTestRunConfigModal()">
                    <div class="card-body py-5">
                        <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 64px; height: 64px; font-size: 24px; border: 2px dashed var(--tr-primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <h5 class="text-primary mb-2" data-i18n="testRun.createFirstConfig">建立第一個測試執行</h5>
                        <p class="text-muted small mb-0" data-i18n="testRun.createFirstConfigHint">
                            設定 Lark 資料表開始測試執行
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Run 配置卡片區域 -->
    <div id="test-run-configs-section">
        <div class="row" id="test-run-configs-container">
            <!-- Test Run 配置卡片將在此處動態生成 -->
        </div>
    </div>
</div>

<!-- 建立 Test Run 配置 Modal -->
<div class="modal fade" id="createTestRunConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i><span data-i18n="testRun.createConfig">建立 Test Run 配置</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testRunConfigForm">
                    <div class="mb-3">
                        <label for="configName" class="form-label">
                            <span data-i18n="testRun.configName">Test Run 名稱</span> 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="configName" name="name" required 
                               data-i18n-placeholder="testRun.configNamePlaceholder"
                               placeholder="輸入 Test Run 名稱">
                    </div>
                    
                    <div class="mb-3">
                        <label for="tableId" class="form-label">
                            <span data-i18n="testRun.larkTableId">Lark 表格 ID</span> 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="tableId" name="table_id" required 
                               placeholder="tbl..." pattern="tbl.*">
                        <div class="form-text" data-i18n="testRun.tableIdHint">
                            請輸入 Lark 表格的 Table ID，格式為以 "tbl" 開頭
                        </div>
                    </div>
                    
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label" data-i18n="common.description">描述</label>
                        <textarea class="form-control" id="configDescription" name="description" rows="3" 
                                data-i18n-placeholder="testRun.descriptionPlaceholder"
                                placeholder="描述這次測試執行配置的目的和範圍"></textarea>
                    </div>
                    
                    <!-- 驗證狀態顯示 -->
                    <div id="connectionStatus" class="d-none">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            <span data-i18n="testRun.verifyingConnection">驗證 Lark 表格連線中...</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-secondary" id="verifyConnectionBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="testRun.verifyConnection">驗證連線</span>
                </button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="testRun.createConfig">建立配置</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run 配置詳情 Modal -->
<div class="modal fade" id="configDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>
                    <span id="configDetailTitle" data-i18n="testRun.configDetails">Test Run 配置詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="configDetailContent">
                <!-- 配置詳情將由 JavaScript 動態載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                <button type="button" class="btn btn-warning" id="editConfigBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="common.edit">編輯</span>
                </button>
                <button type="button" class="btn btn-danger" id="deleteConfigBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Test Run 配置管理

let testRunConfigs = [];
let currentTeamId = null;
let configDetailModalInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化頁面
    initializePage();
    
    // 綁定事件監聽器
    bindEventListeners();
});

function initializePage() {
    // 取得當前團隊 ID
    currentTeamId = AppUtils.getCurrentTeam()?.id;
    if (!currentTeamId) {
        AppUtils.showError(window.i18n ? window.i18n.t('messages.pleaseSelectTeam') : '請先選擇一個團隊');
        window.location.href = '/';
        return;
    }
    
    // 載入 Test Run 配置
    loadTestRunConfigs();
}

function bindEventListeners() {
    // 重新整理按鈕
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadTestRunConfigs();
    });
    
    // 建立配置按鈕
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-test-run-card')) {
            openCreateTestRunConfigModal();
        }
    });
    
    // Modal 相關事件
    document.getElementById('saveConfigBtn').addEventListener('click', saveTestRunConfig);
    document.getElementById('verifyConnectionBtn').addEventListener('click', verifyTableConnection);
}

async function loadTestRunConfigs() {
    try {
        showLoading();
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        testRunConfigs = await response.json();
        renderTestRunConfigs();
        
    } catch (error) {
        console.error('載入 Test Run 配置失敗:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.loadConfigsFailed') : '載入 Test Run 配置失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
        showNoConfigs();
    } finally {
        hideLoading();
    }
}

function renderTestRunConfigs() {
    if (!testRunConfigs || testRunConfigs.length === 0) {
        showNoConfigs();
        return;
    }
    
    showConfigsSection();
    renderConfigCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
    document.getElementById('no-configs-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
}

function showNoConfigs() {
    document.getElementById('no-configs-section').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
}

function showConfigsSection() {
    document.getElementById('no-configs-section').style.display = 'none';
    document.getElementById('test-run-configs-section').style.display = 'block';
}

function renderConfigCards() {
    const container = document.getElementById('test-run-configs-container');
    
    // 現有配置卡片
    const configsHtml = testRunConfigs.map(config => createConfigCard(config)).join('');
    
    // 新增配置卡片
    const addConfigCard = `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 add-test-run-card text-center">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h6 class="text-primary mb-1">${window.i18n ? window.i18n.t('testRun.addMoreConfigs') : '新增更多 Test Run'}</h6>
                    <small class="text-muted">${window.i18n ? window.i18n.t('testRun.addMoreConfigsHint') : '建立新的測試執行配置'}</small>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = configsHtml + addConfigCard;
    
    // 重新翻譯新增的內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate();
    }
}

function createConfigCard(config) {
    const statusClass = getStatusClass(config.status);
    const statusText = getStatusText(config.status);
    const progressPercentage = config.execution_rate || 0;
    const passPercentage = config.pass_rate || 0;
    
    const createdDate = AppUtils.formatDate(config.created_at, 'datetime-tz');
    
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 test-run-card" onclick="enterTestRun(${config.id})">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 16px; font-weight: bold;">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <h5 class="card-title text-primary mb-1 text-truncate">${escapeHtml(config.name)}</h5>
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-badge ${statusClass} me-2">${statusText}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 進度資訊 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">${window.i18n ? window.i18n.t('testRun.progressLabel') : '執行進度'}</small>
                            <small class="text-muted">${progressPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" style="width: ${progressPercentage}%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">${window.i18n ? window.i18n.t('testRun.passRateLabel') : '通過率'}</small>
                            <small class="text-muted">${passPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${passPercentage}%"></div>
                        </div>
                    </div>
                    
                    <!-- 統計資訊 -->
                    <div class="mb-3">
                        <div class="stats-item">
                            <i class="fas fa-list-ul stats-icon"></i>
                            <small class="text-muted">${window.i18n ? window.i18n.t('testRun.totalExecuted', {total: config.total_test_cases, executed: config.executed_cases}) : `總數: ${config.total_test_cases} | 已執行: ${config.executed_cases}`}</small>
                        </div>
                        <div class="stats-item">
                            <i class="fas fa-calendar stats-icon"></i>
                            <small class="text-muted">${window.i18n ? window.i18n.t('testRun.createdLabel', {date: createdDate}) : `建立: ${createdDate}`}</small>
                        </div>
                    </div>
                    
                    <!-- 操作按鈕 -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm flex-grow-1" onclick="event.stopPropagation(); enterTestRun(${config.id})">
                            <i class="fas fa-arrow-right me-1"></i>${window.i18n ? window.i18n.t('testRun.enterButton') : '進入'}
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); showConfigDetails(${config.id})">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getStatusClass(status) {
    switch (status) {
        case 'active': return 'status-active';
        case 'completed': return 'status-completed';
        case 'draft': return 'status-draft';
        case 'archived': return 'status-archived';
        default: return 'status-draft';
    }
}

function getStatusText(status) {
    if (window.i18n) {
        const statusKey = `testRun.status.${status}`;
        const translated = window.i18n.t(statusKey);
        // If translation key doesn't exist, fall back to default
        if (translated === statusKey) {
            return getDefaultStatusText(status);
        }
        return translated;
    }
    
    return getDefaultStatusText(status);
}

function getDefaultStatusText(status) {
    switch (status) {
        case 'active': return '進行中';
        case 'completed': return '已完成';
        case 'draft': return '草稿';
        case 'archived': return '已歸檔';
        default: return '未知';
    }
}

function openCreateTestRunConfigModal() {
    // 清空表單
    document.getElementById('testRunConfigForm').reset();
    document.getElementById('connectionStatus').classList.add('d-none');
    
    // 顯示 Modal
    const modal = new bootstrap.Modal(document.getElementById('createTestRunConfigModal'));
    modal.show();
}

async function saveTestRunConfig() {
    const form = document.getElementById('testRunConfigForm');
    const formData = new FormData(form);
    
    // 驗證表單
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // 準備資料
    const configData = {
        team_id: currentTeamId,
        name: formData.get('name'),
        table_id: formData.get('table_id'),
        description: formData.get('description')
    };
    
    try {
        // 禁用按鈕
        const saveBtn = document.getElementById('saveConfigBtn');
        saveBtn.disabled = true;
        const creatingText = window.i18n ? window.i18n.t('testRun.creatingConfig') : '建立中...';
        saveBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${creatingText}`;
        
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(configData)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || '建立失敗');
        }
        
        const newConfig = await response.json();
        
        // 關閉 Modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('createTestRunConfigModal'));
        modal.hide();
        
        // 顯示成功訊息
        const successMsg = window.i18n ? window.i18n.t('testRun.createConfigSuccess') : '成功建立 Test Run 配置';
        AppUtils.showSuccess(successMsg);
        
        // 重新載入列表
        loadTestRunConfigs();
        
    } catch (error) {
        console.error('建立 Test Run 配置失敗:', error);
        const errorMsg = window.i18n ? window.i18n.t('testRun.createConfigFailed', {error: error.message}) : '建立失敗：' + error.message;
        AppUtils.showError(errorMsg);
    } finally {
        // 恢復按鈕
        const saveBtn = document.getElementById('saveConfigBtn');
        saveBtn.disabled = false;
        const createText = window.i18n ? window.i18n.t('testRun.createConfig') : '建立配置';
        saveBtn.innerHTML = `<i class="fas fa-save me-2"></i>${createText}`;
    }
}

async function verifyTableConnection() {
    const tableId = document.getElementById('tableId').value;
    if (!tableId) {
        const errorMsg = window.i18n ? window.i18n.t('testRun.pleaseEnterTableId') : '請先輸入 Table ID';
        AppUtils.showError(errorMsg);
        return;
    }
    
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.classList.remove('d-none');
    const verifyingText = window.i18n ? window.i18n.t('testRun.verifyingConnection') : '驗證 Lark 表格連線中...';
    statusDiv.innerHTML = `
        <div class="alert alert-info mb-0">
            <i class="fas fa-spinner fa-spin me-2"></i>
            ${verifyingText}
        </div>
    `;
    
    try {
        // 這裡可以實作實際的驗證邏輯
        // 目前先模擬驗證
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const successText = window.i18n ? window.i18n.t('testRun.connectionSuccess') : 'Lark 表格連線成功';
        statusDiv.innerHTML = `
            <div class="alert alert-success mb-0">
                <i class="fas fa-check me-2"></i>
                ${successText}
            </div>
        `;
        
    } catch (error) {
        const failText = window.i18n ? window.i18n.t('testRun.connectionFailed', {error: error.message}) : `連線失敗：${error.message}`;
        statusDiv.innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${failText}
            </div>
        `;
    }
}

function enterTestRun(configId) {
    // 這裡會跳轉到實際的 Test Run 內容頁面
    // 模擬跳轉
    const config = testRunConfigs.find(c => c.id === configId);
    if (config) {
        const infoMsg = window.i18n ? window.i18n.t('testRun.enterTestRun', {name: config.name}) : `將進入 Test Run: ${config.name}`;
        AppUtils.showInfo(infoMsg);
        // TODO: 實作跳轉到實際的 Test Run 內容頁面
        // window.location.href = `/test-run/${configId}`;
    }
}

function showConfigDetails(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) return;

    const modalElement = document.getElementById('configDetailModal');
    
    // Singleton pattern for modal instance
    if (!configDetailModalInstance) {
        configDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    
    // 填入詳情內容
    document.getElementById('configDetailTitle').textContent = config.name;
    document.getElementById('configDetailContent').innerHTML = createConfigDetailContent(config);
    
    // 處理刪除按鈕
    const deleteBtn = document.getElementById('deleteConfigBtn');
    deleteBtn.setAttribute('data-config-id', configId);
    
    // 為了避免重複綁定，先移除舊的監聽器
    deleteBtn.removeEventListener('click', handleDeleteConfig);
    deleteBtn.addEventListener('click', handleDeleteConfig);
    
    configDetailModalInstance.show();
}

async function handleDeleteConfig(event) {
    const configId = event.currentTarget.getAttribute('data-config-id');
    const config = testRunConfigs.find(c => c.id === parseInt(configId));
    if (!config) return;

    const confirmMsg = window.i18n ? window.i18n.t('testRun.deleteConfirm', { name: escapeHtml(config.name) }) : `您確定要刪除 Test Run 配置 "${escapeHtml(config.name)}" 嗎？此操作無法復原。`;
    
    if (confirm(confirmMsg)) {
        await deleteTestRunConfig(configId);
    }
}

async function deleteTestRunConfig(configId) {
    try {
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`, {
            method: 'DELETE'
        });

        if (response.ok) { // Status 204 is ok
            if (configDetailModalInstance) {
                configDetailModalInstance.hide();
            }
            
            const successMsg = window.i18n ? window.i18n.t('testRun.deleteSuccess') : '成功刪除 Test Run 配置';
            AppUtils.showSuccess(successMsg);
            
            await loadTestRunConfigs(); // 重新載入列表
        } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || '刪除失敗');
        }
    } catch (error) {
        console.error('刪除 Test Run 配置失敗:', error);
        const errorMsg = window.i18n ? window.i18n.t('testRun.deleteFailed', { error: error.message }) : `刪除失敗：${error.message}`;
        AppUtils.showError(errorMsg);
    }
}

function createConfigDetailContent(config) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6>${window.i18n ? window.i18n.t('testRun.configBasicInfo') : '基本資訊'}</h6>
                <table class="table table-sm">
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configNameLabel') : '名稱'}</td><td>${escapeHtml(config.name)}</td></tr>
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configTableIdLabel') : 'Table ID'}</td><td><code>${escapeHtml(config.table_id)}</code></td></tr>
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configStatusLabel') : '狀態'}</td><td><span class="status-badge ${getStatusClass(config.status)}">${getStatusText(config.status)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>${window.i18n ? window.i18n.t('testRun.configStatsInfo') : '統計資訊'}</h6>
                <table class="table table-sm">
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configTotalCasesLabel') : '總測試案例'}</td><td>${config.total_test_cases}</td></tr>
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configExecutedLabel') : '已執行'}</td><td>${config.executed_cases}</td></tr>
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configExecutionRateLabel') : '執行率'}</td><td>${config.execution_rate.toFixed(1)}%</td></tr>
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configPassRateLabel') : '通過率'}</td><td>${config.pass_rate.toFixed(1)}%</td></tr>
                    <tr><td>${window.i18n ? window.i18n.t('testRun.configCreatedLabel') : '建立時間'}</td><td>${AppUtils.formatDate(config.created_at, 'datetime-tz')}</td></tr>
                </table>
            </div>
        </div>
        ${config.description ? `
            <div class="mt-3">
                <h6>${window.i18n ? window.i18n.t('common.description') : '描述'}</h6>
                <p class="text-muted">${escapeHtml(config.description)}</p>
            </div>
        ` : ''}
    `;
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// 更新頁面標題翻譯
function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('testRun.management') : '測試執行管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// 監聽 i18n 初始化和語言變更事件
document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);
</script>
{% endblock %}
