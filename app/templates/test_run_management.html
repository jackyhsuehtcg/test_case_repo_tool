{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.management') if i18n else '測試執行管理' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Test Run 入口頁面樣式 -->
<style>
/* Test Run 卡片樣式 */
.test-run-card {
    transition: all 0.2s ease;
    border: 1px solid var(--tr-border-light);
    cursor: pointer;
}

.test-run-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
}

.test-run-card:hover .card-title {
    color: var(--tr-primary-dark) !important;
}

.test-run-card .card-body {
    padding: 1.25rem;
}

/* 新增 Test Run 卡片樣式 */
.add-test-run-card {
    transition: all 0.2s ease;
    border: 2px dashed var(--tr-border-light);
    cursor: pointer;
    background-color: var(--tr-bg-light);
}

.add-test-run-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
    background-color: var(--tr-primary-light);
}

.add-test-run-card:hover h5,
.add-test-run-card:hover h6 {
    color: var(--tr-primary-dark) !important;
}

.add-test-run-card:hover .fas {
    color: var(--tr-primary-dark) !important;
}

/* 進度條樣式 */
.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    border-radius: 4px;
}

/* 狀態標籤樣式 */
.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-weight: 500;
}

.status-draft { background-color: #FFF3CD; color: #856404; border: 1px solid #FFEAA7; }
.status-active { background-color: #CCE5FF; color: #0056B3; border: 1px solid #99D6FF; }
.status-completed { background-color: #D4EDDA; color: #155724; border: 1px solid #A3E4A3; }
.status-archived { background-color: #E2E3E5; color: #495057; border: 1px solid #CED4DA; }

/* 統計資訊樣式 */
.stats-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.stats-item:last-child {
    margin-bottom: 0;
}

.stats-icon {
    width: 1.25rem;
    text-align: center;
    margin-right: 0.5rem;
    opacity: 0.7;
}

/* Loading animation */
.loading-skeleton {
    background: linear-gradient(90deg, var(--tr-bg-sidebar) 25%, var(--tr-border-light) 50%, var(--tr-bg-sidebar) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.management">測試執行管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testRun.subtitle">管理測試執行記錄，追蹤測試進度和結果</span>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="/" class="btn btn-outline-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Loading state -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="testRun.loadingConfigs">載入測試執行配置中...</div>
    </div>

    <!-- 無配置時的提示區域 -->
    <div id="no-configs-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card text-center add-test-run-card" onclick="openConfigFormModal()">
                    <div class="card-body py-5">
                        <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 64px; height: 64px; font-size: 24px; border: 2px dashed var(--tr-primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <h5 class="text-primary mb-2" data-i18n="testRun.createFirstConfig">建立第一個測試執行</h5>
                        <p class="text-muted small mb-0" data-i18n="testRun.createFirstConfigHint">
                            設定 Lark 資料表開始測試執行
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Run 配置卡片區域 -->
    <div id="test-run-configs-section">
        <div class="row" id="test-run-configs-container">
            <!-- Test Run 配置卡片將在此處動態生成 -->
        </div>
    </div>
</div>

<!-- Create/Edit Test Run Configuration Modal -->
<div class="modal fade" id="configFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configFormModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testRunConfigForm">
                    <input type="hidden" id="configId" name="id">
                    <div class="mb-3">
                        <label for="configName" class="form-label">
                            <span data-i18n="testRun.configName">Test Run 名稱</span> 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="configName" name="name" required 
                               data-i18n-placeholder="testRun.configNamePlaceholder"
                               placeholder="輸入 Test Run 名稱">
                    </div>
                    
                    <div class="mb-3">
                        <label for="tableId" class="form-label">
                            <span data-i18n="testRun.larkTableId">Lark 表格 ID</span>
                            <span class="badge bg-secondary ms-2" style="font-weight: 500;" data-i18n="common.optional">選填</span>
                        </label>
                        <input type="text" class="form-control" id="tableId" name="table_id"
                               placeholder="tbl...">
                        <div class="form-text" data-i18n="testRun.tableIdOptionalHint">
                            本地模式可留空；若需同步 Lark，請填入以 "tbl" 開頭的 Table ID
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label" data-i18n="common.description">描述</label>
                        <textarea class="form-control" id="configDescription" name="description" rows="3" 
                                data-i18n-placeholder="testRun.descriptionPlaceholder"></textarea>

                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="testEnvironment" class="form-label"><span data-i18n="testRun.testEnvironment">測試環境</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="testEnvironment" name="test_environment" data-i18n-placeholder="testRun.testEnvironmentPlaceholder" placeholder="例如：Staging / UAT / Prod Sandbox">
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="buildNumber" class="form-label"><span data-i18n="testRun.buildNumber">建置版本</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="buildNumber" name="build_number" data-i18n-placeholder="testRun.buildNumberPlaceholder" placeholder="例如：v1.2.3 / build #4567">
                        </div>
                      </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save me-2"></i><span id="saveConfigBtnText"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 選擇 Modal -->
<div class="modal fade" id="caseSelectModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-tasks me-2"></i><span data-i18n="testRun.caseSelect.title">選擇要加入的 Test Case</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="input-group input-group-search mb-3">
          <div class="position-relative flex-grow-1">
            <input id="caseSearchInput" class="form-control pe-4" data-i18n-placeholder="testRun.caseSelect.searchPlaceholder" placeholder="搜尋標題或編號...">
            <button class="input-clear-btn d-none" id="caseClearBtn" type="button" data-i18n-title="common.clear" title="清除" tabindex="-1" aria-label="Clear">
              <i class="fas fa-times-circle"></i>
            </button>
          </div>
          <button class="btn btn-secondary" id="caseSearchBtn" type="button"><i class="fas fa-search me-1"></i><span data-i18n="common.search">搜尋</span></button>
        </div>
        <div id="caseSelectInfo" class="text-muted small mb-2"></div>
        <div class="table-responsive" style="max-height: 50vh; overflow:auto;">
          <table class="table table-sm align-middle table-sticky">
            <thead>
              <tr>
                <th style="width:32px;"><input type="checkbox" id="selectAllCases"></th>
                <th style="width:160px;"><span data-i18n="testRun.caseSelect.columns.caseNumber">Test Case Number</span></th>
                <th><span data-i18n="testRun.caseSelect.columns.title">Title</span></th>
                <th style="width:100px;"><span data-i18n="testRun.caseSelect.columns.priority">Priority</span></th>
                <th style="width:100px;"><span data-i18n="testRun.caseSelect.columns.attachments">Attachments</span></th>
              </tr>
            </thead>
            <tbody id="caseListBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto text-muted small"><span id="selectedCount">0</span></div>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
        <button type="button" class="btn btn-primary" id="confirmCreateItemsBtn"><i class="fas fa-check me-1"></i><span data-i18n="common.create">建立</span></button>
      </div>
    </div>
  </div>
  </div>

<!-- Test Run 配置詳情 Modal -->
<div class="modal fade" id="configDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>
                    <span id="configDetailTitle" data-i18n="testRun.configDetails">Test Run 配置詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="configDetailContent">
                <!-- Configuration details will be dynamically loaded by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                <button type="button" class="btn btn-warning" id="editConfigBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="common.edit">編輯</span>
                </button>
                <button type="button" class="btn btn-danger" id="deleteConfigBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Delete Confirmation Dialog - Temporarily commented to fix loading issues -->
<!--
<div class="modal fade" id="deleteTestRunModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-warning mb-0">
          <i class="fas fa-info-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTestRun">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>
-->
<!-- Test Run Delete Confirmation Dialog -->
<div class="modal fade" id="deleteConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-warning mb-0">
          <i class="fas fa-info-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteConfigBtn">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Test Run 配置管理

let testRunConfigs = [];
let currentTeamId = null;
let configDetailModalInstance = null;
let configFormModalInstance = null;
// delete config modal is handled via bootstrap instance on demand

document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    bindEventListeners();
    
    // Ensure translations applied after DOM is ready
    if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
        refreshStatusTexts();
    }
});

// Listen for i18n ready event
document.addEventListener('i18nReady', function(event) {
    refreshStatusTexts();
});

// Listen for language changes
document.addEventListener('languageChanged', function(event) {
    refreshStatusTexts();
});

function initializePage() {
    currentTeamId = AppUtils.getCurrentTeam()?.id;
    if (!currentTeamId) {
        // Temporarily use hardcoded team ID for testing
        currentTeamId = 1;
        console.log('Using temporary hardcoded team ID:', currentTeamId);
    }
    loadTestRunConfigs();
}

function bindEventListeners() {
    document.getElementById('refreshBtn').addEventListener('click', loadTestRunConfigs);
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-test-run-card')) {
            openConfigFormModal(); // Changed from openCreateTestRunConfigModal
        }
    });
    
    document.getElementById('saveConfigBtn').addEventListener('click', handleSaveConfig);
}

async function loadTestRunConfigs() {
    try {
        console.log('Loading Test Run configurations, Team ID:', currentTeamId);
        showLoading();
        const response = await fetch(`/api/teams/${currentTeamId}/test-run-configs/`);
        console.log('API 回應狀態:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        testRunConfigs = await response.json();
        console.log('Loaded configurations count:', testRunConfigs.length);
        console.log('Configuration data:', testRunConfigs);
        renderTestRunConfigs();
    } catch (error) {
        console.error('Failed to load Test Run configurations:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.loadConfigsFailed') : '載入失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
        showNoConfigs();
    } finally {
        hideLoading();
    }
}

function renderTestRunConfigs() {
    console.log('Starting to render Test Run configurations');
    console.log('testRunConfigs:', testRunConfigs);
    if (!testRunConfigs || testRunConfigs.length === 0) {
        console.log('No configuration data, showing no configs state');
        showNoConfigs();
        return;
    }
    console.log('Showing configs section and rendering cards');
    showConfigsSection();
    renderConfigCards();
}

function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
    document.getElementById('no-configs-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
}

function showNoConfigs() {
    document.getElementById('no-configs-section').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
}

function showConfigsSection() {
    document.getElementById('no-configs-section').style.display = 'none';
    document.getElementById('test-run-configs-section').style.display = 'block';
}

function renderConfigCards() {
    const container = document.getElementById('test-run-configs-container');
    const configsHtml = testRunConfigs.map(config => createConfigCard(config)).join('');
    const addConfigCard = `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 add-test-run-card text-center" onclick="openConfigFormModal()">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h6 class="text-primary mb-1" data-i18n="testRun.addMoreConfigs">新增更多 Test Run</h6>
                    <small class="text-muted" data-i18n="testRun.addMoreConfigsHint">建立新的測試執行配置</small>
                </div>
            </div>
        </div>
    `;
    container.innerHTML = configsHtml + addConfigCard;
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
}

function createConfigCard(config) {
    const statusClass = getStatusClass(config.status);
    const statusText = getStatusText(config.status);
    const progressPercentage = config.execution_rate || 0;
    const passPercentage = config.pass_rate || 0;
    const createdDate = AppUtils.formatDate(config.created_at, 'datetime-tz');
    const envLine = config.test_environment ? `<div class=\"stats-item\"><i class=\"fas fa-server stats-icon\"></i><small class=\"text-muted\"><span data-i18n=\"testRun.testEnvironment\">測試環境</span>: ${escapeHtml(config.test_environment)}</small></div>` : '';
    const buildLine = config.build_number ? `<div class=\"stats-item\"><i class=\"fas fa-code-branch stats-icon\"></i><small class=\"text-muted\"><span data-i18n=\"testRun.buildNumber\">建置版本</span>: ${escapeHtml(config.build_number)}</small></div>` : '';
    
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 test-run-card" onclick="enterTestRun(${config.id})">
                <div class="card-body d-flex flex-column h-100">
                    <div class="d-flex align-items-start mb-3">
                        <div class="flex-shrink-0 me-3">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 48px; height: 48px; font-size: 16px; font-weight: bold;">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 min-width-0">
                            <h5 class="card-title text-primary mb-1 text-truncate">${escapeHtml(config.name)}</h5>
                            <div class="d-flex align-items-center mb-2">
                                <span class="status-badge ${statusClass} me-2">${statusText}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" data-i18n="testRun.progressLabel">執行進度</small>
                            <small class="text-muted">${progressPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" data-i18n="testRun.passRateLabel">通過率</small>
                            <small class="text-muted">${passPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${passPercentage}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        ${envLine}
                        ${buildLine}
                        <div class="stats-item">
                            <i class="fas fa-list-ul stats-icon"></i>
                            <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.totalExecuted', {total: config.total_test_cases, executed: config.executed_cases}) : `總數: ${config.total_test_cases} | 已執行: ${config.executed_cases}`}</small>
                        </div>
                        <div class="stats-item">
                            <i class="fas fa-calendar stats-icon"></i>
                            <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.createdLabel', {date: createdDate}) : `建立: ${createdDate}`}</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-auto pt-2">
                        <button class="btn btn-primary btn-sm flex-grow-1" onclick="event.stopPropagation(); enterTestRun(${config.id})">
                            <i class="fas fa-arrow-right me-1"></i><span data-i18n="testRun.enterButton">進入</span>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); showConfigDetails(${config.id})">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getStatusClass(status) {
    switch (status) {
        case 'active': return 'status-active';
        case 'completed': return 'status-completed';
        case 'draft': return 'status-draft';
        case 'archived': return 'status-archived';
        default: return 'status-draft';
    }
}

function getStatusText(status) {
    if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
        const statusKey = `testRun.status.${status}`;
        const translated = window.i18n.t(statusKey);
        if (translated === statusKey) {
            return getDefaultStatusText(status);
        }
        return translated;
    }
    return getDefaultStatusText(status);
}

function getDefaultStatusText(status) {
    const defaultTexts = {
        'active': '進行中',
        'completed': '已完成', 
        'draft': '草稿',
        'archived': '已歸檔',
        'unknown': '未知'
    };
    return defaultTexts[status] || '未知';
}

function refreshStatusTexts() {
    // Refresh status texts in config cards by reloading the configs
    if (typeof loadTestRunConfigs === 'function') {
        loadTestRunConfigs();
    }
    
    // Also refresh any status text in modals if they're visible
    const detailModal = document.getElementById('configDetailModal');
    if (detailModal && detailModal.classList.contains('show')) {
        // Find all status badges in the detail modal and update them
        const statusBadges = detailModal.querySelectorAll('.status-badge');
        statusBadges.forEach(badge => {
            const statusClass = badge.className.match(/status-(\w+)/);
            if (statusClass && statusClass[1]) {
                const status = statusClass[1];
                badge.textContent = getStatusText(status);
            }
        });
    }
}

function openConfigFormModal(configId = null) {
    const modalElement = document.getElementById('configFormModal');
    if (!configFormModalInstance) {
        configFormModalInstance = new bootstrap.Modal(modalElement);
    }

    const form = document.getElementById('testRunConfigForm');
    form.reset();
    document.getElementById('configId').value = '';

    const titleEl = document.getElementById('configFormModalTitle');
    const saveBtnTextEl = document.getElementById('saveConfigBtnText');

    if (configId) {
        // Edit mode
        const config = testRunConfigs.find(c => c.id === configId);
        if (config) {
            titleEl.setAttribute('data-i18n', 'testRun.editConfig');
            saveBtnTextEl.setAttribute('data-i18n', 'common.update');
            document.getElementById('configId').value = config.id;
            document.getElementById('configName').value = config.name;
            document.getElementById('tableId').value = config.table_id;
            document.getElementById('configDescription').value = config.description || '';
            // 嘗試載入詳細配置以填入可選欄位
            fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`)
              .then(r => r.ok ? r.json() : null)
              .then(full => {
                if (full) {
                  document.getElementById('testEnvironment').value = full.test_environment || '';
                  document.getElementById('buildNumber').value = full.build_number || '';
                }
              }).catch(() => {});
        }
    } else {
        // Create mode
        titleEl.setAttribute('data-i18n', 'testRun.createConfig');
        saveBtnTextEl.setAttribute('data-i18n', 'common.create');
    }
    
    if (window.i18n) window.i18n.retranslate(modalElement);
    configFormModalInstance.show();
}

async function handleSaveConfig() {
    const form = document.getElementById('testRunConfigForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const configId = document.getElementById('configId').value;
    const isEdit = !!configId;

    const configData = { name: document.getElementById('configName').value };
    const tableIdVal = (document.getElementById('tableId').value || '').trim();
    const descVal = (document.getElementById('configDescription').value || '').trim();
    const envVal = (document.getElementById('testEnvironment').value || '').trim();
    const buildVal = (document.getElementById('buildNumber').value || '').trim();
    if (tableIdVal) configData.table_id = tableIdVal;
    if (descVal) configData.description = descVal;
    if (envVal) configData.test_environment = envVal;
    if (buildVal) configData.build_number = buildVal;

    const url = isEdit ? `/api/teams/${currentTeamId}/test-run-configs/${configId}` : `/api/teams/${currentTeamId}/test-run-configs/`;
    const method = isEdit ? 'PUT' : 'POST';

    const saveBtn = document.getElementById('saveConfigBtn');
    try {
        saveBtn.disabled = true;
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            const fallbackMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
            throw new Error(errorData.detail || fallbackMsg);
        }

        const data = await response.json();
        configFormModalInstance.hide();
        if (isEdit) {
          const msg = window.i18n ? window.i18n.t('testRun.updateSuccess') : '更新成功';
          AppUtils.showSuccess(msg);
          await loadTestRunConfigs();
        } else {
          const msg = window.i18n ? window.i18n.t('testRun.createConfigSuccessSelectCases') : '建立成功，請選擇要加入的 Test Case';
          AppUtils.showSuccess(msg);
          // 進入 Test Case 選擇流程（直接開啟，取消時自動回滾）
          pendingCreate = true;
          createdItemsInSession = false;
          openCaseSelectModal(data.id);
        }

    } catch (error) {
        AppUtils.showError(error.message);
    } finally {
        saveBtn.disabled = false;
    }
}

function showConfigDetails(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) return;

    const modalElement = document.getElementById('configDetailModal');
    if (!configDetailModalInstance) {
        configDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    
    document.getElementById('configDetailTitle').textContent = config.name;
    document.getElementById('configDetailContent').innerHTML = createConfigDetailContent(config);
    
    // 手動觸發翻譯處理動態插入的內容
    if (window.i18n && window.i18n.isReady()) {
        const detailContent = document.getElementById('configDetailContent');
        window.i18n.retranslate(detailContent);
    }
    
    const deleteBtn = document.getElementById('deleteConfigBtn');
    deleteBtn.setAttribute('data-config-id', configId);
    deleteBtn.onclick = handleDeleteConfig;

    const editBtn = document.getElementById('editConfigBtn');
    editBtn.setAttribute('data-config-id', configId);
    editBtn.onclick = handleEditConfig;
    
    configDetailModalInstance.show();
}

function handleEditConfig(event) {
    const configId = parseInt(event.currentTarget.getAttribute('data-config-id'));
    if (configDetailModalInstance) {
        configDetailModalInstance.hide();
    }
    setTimeout(() => {
        openConfigFormModal(configId);
    }, 150);
}

async function handleDeleteConfig(event) {
    const configId = event.currentTarget.getAttribute('data-config-id');
    const config = testRunConfigs.find(c => c.id === parseInt(configId));
    if (!config) return;
    // Show custom modal
    const modal = document.getElementById('deleteConfigModal');
    const msgEl = document.getElementById('deleteConfirmMessage');
    msgEl.textContent = window.i18n ? window.i18n.t('testRun.confirmDelete', { name: escapeHtml(config.name) }) : `您確定要刪除 Test Run 配置 "${escapeHtml(config.name)}" 嗎？此操作無法復原。`;
    const inst = bootstrap.Modal.getOrCreateInstance(modal);
    // Rebind confirm handler
    const btnOld = document.getElementById('confirmDeleteConfigBtn');
    const btnNew = btnOld.cloneNode(true);
    btnOld.parentNode.replaceChild(btnNew, btnOld);
    document.getElementById('confirmDeleteConfigBtn').addEventListener('click', async () => {
        try {
            const resp = await fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`, { method: 'DELETE' });
            if (resp.ok || resp.status === 204) {
                if (configDetailModalInstance) configDetailModalInstance.hide();
                inst.hide();
                const successMsg = window.i18n ? window.i18n.t('testRun.deleteSuccess', { name: config.name }) : `成功刪除 "${config.name}"`;
                AppUtils.showSuccess(successMsg);
                await loadTestRunConfigs();
            } else {
                let detail = '';
                try {
                    const text = await resp.text();
                    try { detail = JSON.parse(text).detail || text; } catch { detail = text; }
                } catch { detail = ''; }
                const fallbackMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
                throw new Error(detail || fallbackMsg);
            }
        } catch (error) {
            console.error('Error deleting Test Run configuration:', error);
            const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
            AppUtils.showError(`${errorMsg}: ${error.message}`);
        }
    });
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modal);
    inst.show();
}

function createConfigDetailContent(config) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6 data-i18n="testRun.configBasicInfo">基本資訊</h6>
                <table class="table table-sm">
                    <tr><td data-i18n="testRun.configNameLabel">名稱</td><td>${escapeHtml(config.name)}</td></tr>
                    <tr><td data-i18n="testRun.configTableIdLabel">Table ID</td><td><code>${escapeHtml(config.table_id)}</code></td></tr>
                    <tr><td data-i18n="testRun.testEnvironment">測試環境</td><td>${escapeHtml(config.test_environment || '')}</td></tr>
                    <tr><td data-i18n="testRun.buildNumber">建置版本</td><td>${escapeHtml(config.build_number || '')}</td></tr>
                    <tr><td data-i18n="testRun.configStatusLabel">狀態</td><td><span class="status-badge ${getStatusClass(config.status)}">${getStatusText(config.status)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 data-i18n="testRun.configStatsInfo">統計資訊</h6>
                <table class="table table-sm">
                    <tr><td data-i18n="testRun.configTotalCasesLabel">總測試案例</td><td>${config.total_test_cases}</td></tr>
                    <tr><td data-i18n="testRun.configExecutedLabel">已執行</td><td>${config.executed_cases}</td></tr>
                    <tr><td data-i18n="testRun.configExecutionRateLabel">執行率</td><td>${config.execution_rate.toFixed(1)}%</td></tr>
                    <tr><td data-i18n="testRun.configPassRateLabel">通過率</td><td>${config.pass_rate.toFixed(1)}%</td></tr>
                    <tr><td data-i18n="testRun.configCreatedLabel">建立時間</td><td>${AppUtils.formatDate(config.created_at, 'datetime-tz')}</td></tr>
                </table>
            </div>
        </div>
        ${config.description ? `
            <div class="mt-3">
                <h6 data-i18n="common.description">描述</h6>
                <p class="text-muted">${escapeHtml(config.description)}</p>
            </div>
        ` : ''}
    `;
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('testRun.management') : '測試執行管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// Test Run entry function
function enterTestRun(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) {
        console.error('Test Run configuration not found:', configId);
        AppUtils.showError(window.i18n ? window.i18n.t('testRun.notFound') : '找不到測試執行配置');
        return;
    }
    
    // 導向 Test Run 執行頁面
    window.location.href = `/test-run-execution?config_id=${configId}`;
}

document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);

// ---- Test Case 選擇流程 ----
let caseSelectModalInstance = null;
let currentSelectingConfigId = null;
let availableCases = [];
let selectedCaseMap = new Map(); // key: test_case_number, value: case object
let pendingCreate = false; // true only for newly created config awaiting items
let createdItemsInSession = false; // set true when items are created

// Removed confirmation step; open modal directly and rely on hidden handler for rollback
function openCaseSelectModalWithConfirm(configId) {
  pendingCreate = true;
  createdItemsInSession = false;
  openCaseSelectModal(configId);
}

function openCaseSelectModal(configId) {
  currentSelectingConfigId = configId;
  const modalEl = document.getElementById('caseSelectModal');
  if (!caseSelectModalInstance) caseSelectModalInstance = new bootstrap.Modal(modalEl);
  // reset
  selectedCaseMap.clear();
  document.getElementById('selectedCount').textContent = '0';
  document.getElementById('caseListBody').innerHTML = '';
  document.getElementById('caseSearchInput').value = '';
  document.getElementById('caseSelectInfo').textContent = '';
  caseSelectModalInstance.show();
  // ensure we bind a one-time hide handler for rollback if pending
  const modalDom = document.getElementById('caseSelectModal');
  // Remove previous listener if any by cloning (simple way to avoid multiple bindings)
  modalDom.addEventListener('hidden.bs.modal', async function onHidden() {
    // This will be called whenever modal hides. If pending and no items created, rollback
    if (pendingCreate && !createdItemsInSession && currentSelectingConfigId) {
      try {
        await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}`, { method: 'DELETE' });
        const warnMsg = window.i18n ? window.i18n.t('testRun.configDeletedDueToCancel') : '已取消選擇，設定已刪除';
        AppUtils.showInfo(warnMsg);
        await loadTestRunConfigs();
      } catch (e) {
        AppUtils.showError((window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗') + `: ${e.message}`);
      } finally {
        pendingCreate = false;
        createdItemsInSession = false;
        currentSelectingConfigId = null;
      }
    } else {
      // Clear flags when modal hides in any case
      pendingCreate = false;
      createdItemsInSession = false;
      currentSelectingConfigId = null;
    }
    // remove this handler after execution
    modalDom.removeEventListener('hidden.bs.modal', onHidden);
  }, { once: true });
  // load first page
  loadTeamTestCases('');
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(document.getElementById('caseSelectModal'));
  // bind search/clear once per open
  bindCaseSearchBarEvents();
}

async function loadTeamTestCases(search) {
  try {
    console.log('Loading test cases for team ID:', currentTeamId);
    const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
    if (search) url.searchParams.set('search', search);
    url.searchParams.set('limit', '200');
    console.log('API URL:', url.toString());
    
    const resp = await fetch(url);
    console.log('API Response Status:', resp.status);
    
    if (!resp.ok) {
      const errorText = await resp.text();
      console.log('API Error Response:', errorText);
      throw new Error(`HTTP ${resp.status}: ${errorText}`);
    }
    
    availableCases = await resp.json();
    console.log('Loaded test cases:', availableCases.length);
    renderCaseList();
  } catch (e) {
    console.error('Load test cases error:', e);
    AppUtils.showError((window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗') + `: ${e.message}`);
  }
}

function renderCaseList() {
  const tbody = document.getElementById('caseListBody');
  const rows = availableCases.map(c => {
    const num = escapeHtml(c.test_case_number || '');
    const ttl = escapeHtml(c.title || '');
    const pri = escapeHtml(c.priority || '');
    const attCount = (c.attachments || []).length || 0;
    const checked = selectedCaseMap.has(c.test_case_number) ? 'checked' : '';
    return `
      <tr>
        <td><input type="checkbox" class="case-check" data-num="${num}" ${checked}></td>
        <td><code>${num}</code></td>
        <td>${ttl}</td>
        <td>${pri}</td>
        <td>${attCount}</td>
      </tr>`;
  }).join('');
  tbody.innerHTML = rows;
  wireCaseCheckHandlers();
  updateSelectedCount();
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(document.getElementById('caseSelectModal'));
}

function wireCaseCheckHandlers() {
  document.querySelectorAll('.case-check').forEach(el => {
    el.addEventListener('change', (e) => {
      const num = e.target.getAttribute('data-num');
      if (e.target.checked) {
        const c = availableCases.find(x => x.test_case_number === num);
        if (c) selectedCaseMap.set(num, c);
      } else {
        selectedCaseMap.delete(num);
      }
      updateSelectedCount();
    });
  });
  const selectAll = document.getElementById('selectAllCases');
  selectAll.checked = false;
  selectAll.addEventListener('change', (e) => {
    if (e.target.checked) {
      availableCases.forEach(c => selectedCaseMap.set(c.test_case_number, c));
      document.querySelectorAll('.case-check').forEach(ch => ch.checked = true);
    } else {
      selectedCaseMap.clear();
      document.querySelectorAll('.case-check').forEach(ch => ch.checked = false);
    }
    updateSelectedCount();
  });
  // search handlers moved to bindCaseSearchBarEvents()
}

function bindCaseSearchBarEvents() {
  const searchBtn = document.getElementById('caseSearchBtn');
  const clearBtn = document.getElementById('caseClearBtn');
  const inputEl = document.getElementById('caseSearchInput');
  if (searchBtn) {
    searchBtn.onclick = () => {
      loadTeamTestCases(inputEl.value.trim());
    };
  }
  if (clearBtn) {
    clearBtn.onclick = () => {
      inputEl.value = '';
      clearBtn.classList.add('d-none');
      loadTeamTestCases('');
      inputEl.focus();
    };
  }
  if (inputEl) {
    inputEl.onkeydown = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadTeamTestCases(inputEl.value.trim());
      }
    };
    // toggle clear button visibility on input
    inputEl.addEventListener('input', () => {
      if (clearBtn) {
        if (inputEl.value && inputEl.value.length > 0) {
          clearBtn.classList.remove('d-none');
        } else {
          clearBtn.classList.add('d-none');
        }
      }
    });
    // initialize visibility
    if (clearBtn) {
      if (inputEl.value && inputEl.value.length > 0) clearBtn.classList.remove('d-none');
      else clearBtn.classList.add('d-none');
    }
  }
}

function updateSelectedCount() {
  const count = selectedCaseMap.size;
  const selectedEl = document.getElementById('selectedCount');
  selectedEl.textContent = String(count);
  const info = document.getElementById('caseSelectInfo');
  if (window.i18n && count > 0) {
    info.textContent = window.i18n.t('testRun.caseSelect.selectedInfo', { count });
  } else {
    info.textContent = '';
  }
}

document.getElementById('confirmCreateItemsBtn').addEventListener('click', createItemsFromSelection);

async function createItemsFromSelection() {
  if (!currentSelectingConfigId) return;
  if (selectedCaseMap.size === 0) {
    const warn = window.i18n ? window.i18n.t('errors.pleaseSelectTestCases') : '請先選擇至少一筆 Test Case';
    AppUtils.showWarning ? AppUtils.showWarning(warn) : alert(warn);
    return;
  }
  const items = Array.from(selectedCaseMap.values()).map(c => ({
    test_case_number: c.test_case_number,
    title: c.title,
    priority: c.priority || 'Medium',
    precondition: c.precondition || null,
    steps: c.steps || null,
    expected_result: c.expected_result || null,
    assignee: c.assignee ? { id: c.assignee.id, name: c.assignee.name, en_name: c.assignee.en_name, email: c.assignee.email } : null,
    attachments: (c.attachments || []).map(a => ({ file_token: a.file_token, name: a.name, size: a.size, type: a.type })),
    user_story_map: c.user_story_map || [],
    tcg: c.tcg || [],
    parent_record: c.parent_record || [],
    raw_fields: c.raw_fields || null,
  }));

  try {
    const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items`;
    const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items }) });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const res = await resp.json();
    createdItemsInSession = true;
    pendingCreate = false;
    caseSelectModalInstance.hide();
    const msg = window.i18n ? window.i18n.t('testRun.itemsCreated', { count: res.created_count || items.length }) : `建立成功 (${res.created_count || items.length} 筆)`;
    AppUtils.showSuccess(msg);
    // 同步統計後刷新管理頁
    try { await fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/sync`); } catch(e) {}
    await loadTestRunConfigs();
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.saveFailed') : '建立失敗') + `: ${e.message}`);
  }
}
</script>
{% endblock %}
